{
  "project_name": "Construction Management & QC Platform",
  "project_stats": {
    "total_files": 1019,
    "typescript_files": 368,
    "test_files": 24,
    "component_files": 142
  },
  "typescript_errors": "client/src/pages/NewDashboard.tsx(43,67): error TS2339: Property 'stats' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ getStats: QueryProcedure<{ input: void; output: { projectStats: { total: number; ... 7 more ...; onTrack: number; }; ... 6 more ...; trends: { ...; }; }; meta: object; }>; ... 4 m...'.\nclient/src/pages/NewDashboard.tsx(45,20): error TS2551: Property 'recentActivities' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ getStats: QueryProcedure<{ input: void; output: { projectStats: { total: number; ... 7 more ...; onTrack: number; }; ... 6 more ...; trends: { ...; }; }; meta: object; }>; ... 4 m...'. Did you mean 'getRecentActivities'?\nclient/src/pages/NewDashboard.tsx(47,20): error TS2339: Property 'taskStatusDistribution' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ getStats: QueryProcedure<{ input: void; output: { projectStats: { total: number; ... 7 more ...; onTrack: number; }; ... 6 more ...; trends: { ...; }; }; meta: object; }>; ... 4 m...'.\nclient/src/pages/NewDashboard.tsx(49,20): error TS2339: Property 'defectSeverityDistribution' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ getStats: QueryProcedure<{ input: void; output: { projectStats: { total: number; ... 7 more ...; onTrack: number; }; ... 6 more ...; trends: { ...; }; }; meta: object; }>; ... 4 m...'.\nclient/src/pages/NewDashboard.tsx(51,20): error TS2339: Property 'projectProgress' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ getStats: QueryProcedure<{ input: void; output: { projectStats: { total: number; ... 7 more ...; onTrack: number; }; ... 6 more ...; trends: { ...; }; }; meta: object; }>; ... 4 m...'.\nclient/src/pages/PermissionsManagement.tsx(18,62): error TS2339: Property 'getAllUsers' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ listAllUsers: QueryProcedure<{ input: void; output: { id: number; openId: string; ... 11 more ...; dailySummaryTime: string | null; }[]; meta: object; }>; ... 11 more ...; getRole...'.\nclient/src/pages/PermissionsManagement.tsx(164,38): error TS7006: Parameter 'template' implicitly has an 'any' type.\nclient/src/pages/QCInspection.tsx(86,45): error TS2554: Expected 1-2 arguments, but got 0.\nclient/src/pages/QCInspection.tsx(185,51): error TS2339: Property 'assignChecklistToTask' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ templates: QueryProcedure<{ input: void; output: { preExecution: any[]; inProgress: any[]; postExecution: any[]; }; meta: object; }>; ... 22 more ...; getAllTaskChecklists: QueryP...'.\nclient/src/pages/QCInspection.tsx(192,15): error TS7006: Parameter 'error' implicitly has an 'any' type.\nclient/src/pages/QCInspection.tsx(1036,23): error TS2339: Property 'filter' does not exist on type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }'.\nclient/src/pages/Reports.tsx(57,11): error TS2740: Type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }' is missing the following properties from type 'any[]': length, pop, push, concat, and 35 more.\nclient/src/pages/Reports.tsx(60,20): error TS2339: Property 'some' does not exist on type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }'.\nclient/src/pages/Reports.tsx(65,28): error TS2345: Argument of type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }' is not assignable to parameter of type 'any[]'.\n  Type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }' is missing the following properties from type 'any[]': length, pop, push, concat, and 35 more.\nclient/src/pages/Reports.tsx(73,18): error TS2339: Property 'some' does not exist on type '{ items: any[]; pagination: { currentPage: number; pageSize: number; totalItems: number; totalPages: number; hasMore: boolean; hasPrevious: boolean; }; }'.\nclient/src/pages/RoleTemplates.tsx(28,47): error TS2339: Property 'permissions' does not exist on type 'CreateTRPCReactBase<BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ export: BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<...>>; ... 34 more ...; alertThre...'.\nclient/src/pages/RoleTemplates.tsx(30,39): error TS2339: Property 'permissions' does not exist on type 'CreateTRPCReactBase<BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ export: BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<...>>; ... 34 more ...; alertThre...'.\nclient/src/pages/RoleTemplates.tsx(33,13): error TS2339: Property 'permissions' does not exist on type 'TRPCContextPropsBase<BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ export: BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<...>>; ... 34 more ...; alertThr...'.\nclient/src/pages/RoleTemplates.tsx(37,15): error TS7006: Parameter 'error' implicitly has an 'any' type.\nclient/src/pages/RoleTemplates.tsx(120,27): error TS7006: Parameter 'template' implicitly has an 'any' type.\nclient/src/pages/RoleTemplates.tsx(188,17): error TS2339: Property 'permissions' does not exist on type 'TRPCContextPropsBase<BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ export: BuiltRouter<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<...>>; ... 34 more ...; alertThr...'.\nclient/src/pages/UserActivityLog.tsx(31,62): error TS2339: Property 'getAllUsers' does not exist on type 'DecorateRouterRecord<{ ctx: TrpcContext; meta: object; errorShape: DefaultErrorShape; transformer: true; }, DecorateCreateRouterOptions<{ listAllUsers: QueryProcedure<{ input: void; output: { id: number; openId: string; ... 11 more ...; dailySummaryTime: string | null; }[]; meta: object; }>; ... 11 more ...; getRole...'.\nserver/_core/virusScanner.ts(1,22): error TS7016: Could not find a declaration file for module 'clamscan'. '/home/ubuntu/construction_management_app/node_modules/.pnpm/clamscan@2.4.0/node_modules/clamscan/index.js' implicitly has an 'any' type.\n  Try `npm i --save-dev @types/clamscan` if it exists or add a new declaration (.d.ts) file containing `declare module 'clamscan';`\nserver/activityLogExport.ts(60,19): error TS2339: Property 'module' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(61,23): error TS2339: Property 'entityType' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(62,21): error TS2339: Property 'entityId' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(64,22): error TS2339: Property 'ipAddress' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(186,13): error TS2339: Property 'module' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(187,33): error TS2339: Property 'module' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogExport.ts(188,36): error TS2339: Property 'module' does not exist on type 'ActivityLogWithUser'.\nserver/activityLogPdfExport.ts(221,46): error TS2339: Property 'module' does not exist on type 'ActivityLogWithUser'.\nserver/db.ts(69,7): error TS2322: Type 'MySql2Database<Record<string, unknown>> & { $client: Pool; }' is not assignable to type '(MySql2Database<Record<string, unknown>> & { $client: Pool; }) | null'.\n  Type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/drizzle-orm@0.44.7_mysql2@3.15.1/node_modules/drizzle-orm/mysql2/driver\").MySql2Database<Record<string, unknown>> & { ...; }' is not assignable to type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/drizzle-orm@0.44.7_mysql2@3.15.1/node_modules/drizzle-orm/mysql2/driver\").MySql2Database<Record<string, unknown>> & { ...; }'. Two different types with this name exist, but they are unrelated.\n    Type 'MySql2Database<Record<string, unknown>> & { $client: Pool; }' is not assignable to type '{ $client: Pool; }'.\n      Types of property '$client' are incompatible.\n        Property 'promise' is missing in type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/promise\").Pool' but required in type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/typings/mysql/lib/Pool\").Pool'.\nserver/db.ts(1066,5): error TS2769: No overload matches this call.\n  Overload 2 of 2, '(values: { name: string | SQL<unknown> | Placeholder<string, any>; createdBy: number | SQL<unknown> | Placeholder<string, any>; stage: SQL<unknown> | Placeholder<string, any> | \"in_progress\" | \"pre_execution\" | \"post_execution\"; ... 6 more ...; allowPhotos?: number | ... 2 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'name' does not exist in type '{ name: string | SQL<unknown> | Placeholder<string, any>; createdBy: number | SQL<unknown> | Placeholder<string, any>; stage: SQL<unknown> | Placeholder<string, any> | \"in_progress\" | \"pre_execution\" | \"post_execution\"; ... 6 more ...; allowPhotos?: number | ... 2 more ... | undefined; }[]'.\nserver/db.ts(1243,30): error TS2339: Property 'id' does not exist on type '{}'.\nserver/db.ts(1922,5): error TS2769: No overload matches this call.\n  Overload 1 of 2, '(value: { type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'recipientId' does not exist in type '{ type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }'.\n  Overload 2 of 2, '(values: { type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'recipientId' does not exist in type '{ type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }[]'.\nserver/db.ts(2371,48): error TS2769: No overload matches this call.\n  Overload 1 of 2, '(value: { result: SQL<unknown> | Placeholder<string, any> | \"pass\" | \"fail\" | \"na\"; taskChecklistId: number | SQL<unknown> | Placeholder<string, any>; templateItemId: number | ... 1 more ... | Placeholder<...>; ... 4 more ...; comments?: string | ... 3 more ... | undefined; }): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'inspectedBy' does not exist in type '{ result: SQL<unknown> | Placeholder<string, any> | \"pass\" | \"fail\" | \"na\"; taskChecklistId: number | SQL<unknown> | Placeholder<string, any>; templateItemId: number | ... 1 more ... | Placeholder<...>; ... 4 more ...; comments?: string | ... 3 more ... | undefined; }'.\n  Overload 2 of 2, '(values: { result: SQL<unknown> | Placeholder<string, any> | \"pass\" | \"fail\" | \"na\"; taskChecklistId: number | SQL<unknown> | Placeholder<string, any>; templateItemId: number | ... 1 more ... | Placeholder<...>; ... 4 more ...; comments?: string | ... 3 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'taskChecklistId' does not exist in type '{ result: SQL<unknown> | Placeholder<string, any> | \"pass\" | \"fail\" | \"na\"; taskChecklistId: number | SQL<unknown> | Placeholder<string, any>; templateItemId: number | ... 1 more ... | Placeholder<...>; ... 4 more ...; comments?: string | ... 3 more ... | undefined; }[]'.\nserver/db.ts(3549,8): error TS2769: No overload matches this call.\n  Overload 1 of 2, '(value: { id?: number | SQL<unknown> | Placeholder<string, any> | undefined; createdAt?: SQL<unknown> | Placeholder<string, any> | Date | undefined; resolved?: number | ... 2 more ... | undefined; ... 10 more ...; logMessage?: string | ... 3 more ... | undefined; }): MySqlInsertBase<...>', gave the following error.\n    Type 'false' is not assignable to type 'number | SQL<unknown> | Placeholder<string, any> | undefined'.\n  Overload 2 of 2, '(values: { id?: number | SQL<unknown> | Placeholder<string, any> | undefined; createdAt?: SQL<unknown> | Placeholder<string, any> | Date | undefined; resolved?: number | ... 2 more ... | undefined; ... 10 more ...; logMessage?: string | ... 3 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'timestamp' does not exist in type '{ id?: number | SQL<unknown> | Placeholder<string, any> | undefined; createdAt?: SQL<unknown> | Placeholder<string, any> | Date | undefined; resolved?: number | ... 2 more ... | undefined; ... 10 more ...; logMessage?: string | ... 3 more ... | undefined; }[]'.\nserver/db.ts(3580,27): error TS2769: No overload matches this call.\n  Overload 1 of 3, '(left: MySqlColumn<{ name: \"resolved\"; tableName: \"oomEvents\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>, right: number | SQLWrapper): SQL<...>', gave the following error.\n    Argument of type 'boolean' is not assignable to parameter of type 'number | SQLWrapper'.\n  Overload 2 of 3, '(left: Aliased<boolean>, right: boolean | SQLWrapper): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"resolved\"; tableName: \"oomEvents\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'Aliased<boolean>'.\n      Type 'MySqlColumn<{ name: \"resolved\"; tableName: \"oomEvents\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is missing the following properties from type 'Aliased<boolean>': sql, fieldAlias\n  Overload 3 of 3, '(left: never, right: unknown): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"resolved\"; tableName: \"oomEvents\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'never'.\nserver/db.ts(4720,9): error TS2769: No overload matches this call.\n  Overload 1 of 3, '(left: MySqlColumn<{ name: \"isEnabled\"; tableName: \"alertThresholds\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>, right: number | SQLWrapper): SQL<...>', gave the following error.\n    Argument of type 'boolean' is not assignable to parameter of type 'number | SQLWrapper'.\n  Overload 2 of 3, '(left: Aliased<boolean>, right: boolean | SQLWrapper): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"isEnabled\"; tableName: \"alertThresholds\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'Aliased<boolean>'.\n      Type 'MySqlColumn<{ name: \"isEnabled\"; tableName: \"alertThresholds\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is missing the following properties from type 'Aliased<boolean>': sql, fieldAlias\n  Overload 3 of 3, '(left: never, right: unknown): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"isEnabled\"; tableName: \"alertThresholds\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'never'.\nserver/db.ts(5643,20): error TS2339: Property 'fileSize' does not exist on type '{ importedBy: number; fileName: string; fileUrl?: string | undefined; totalRows: number; }'.\nserver/db/client.ts(42,7): error TS2322: Type 'MySql2Database<Record<string, unknown>> & { $client: Pool; }' is not assignable to type '(MySql2Database<Record<string, unknown>> & { $client: Pool; }) | null'.\n  Type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/drizzle-orm@0.44.7_mysql2@3.15.1/node_modules/drizzle-orm/mysql2/driver\").MySql2Database<Record<string, unknown>> & { ...; }' is not assignable to type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/drizzle-orm@0.44.7_mysql2@3.15.1/node_modules/drizzle-orm/mysql2/driver\").MySql2Database<Record<string, unknown>> & { ...; }'. Two different types with this name exist, but they are unrelated.\n    Type 'MySql2Database<Record<string, unknown>> & { $client: Pool; }' is not assignable to type '{ $client: Pool; }'.\n      Types of property '$client' are incompatible.\n        Property 'promise' is missing in type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/promise\").Pool' but required in type 'import(\"/home/ubuntu/construction_management_app/node_modules/.pnpm/mysql2@3.15.1/node_modules/mysql2/typings/mysql/lib/Pool\").Pool'.\nserver/db/client.ts(47,53): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/db/client.ts(83,56): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/db/client.ts(100,65): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/db/client.ts(173,57): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/errorHandlerService.ts(57,52): error TS2345: Argument of type '{ code: \"UNAUTHORIZED\" | \"FORBIDDEN\" | \"SESSION_EXPIRED\" | \"VALIDATION_ERROR\" | \"REQUIRED_FIELD\" | \"INVALID_FORMAT\" | \"NOT_FOUND\" | \"DUPLICATE_ENTRY\" | \"DATABASE_ERROR\" | \"TASK_DEPENDENCY_ERROR\" | \"INSPECTION_INCOMPLETE\" | \"DEFECT_NOT_RESOLVED\" | \"TIMEOUT\" | \"INTERNAL_ERROR\"; trpcCode: \"UNAUTHORIZED\" | ... 6 more .....' is not assignable to parameter of type 'string'.\nserver/errorHandlerService.ts(75,36): error TS2345: Argument of type '{ error: any; context: ErrorContext | undefined; }' is not assignable to parameter of type 'string'.\nserver/errorHandlerService.ts(192,56): error TS2345: Argument of type '{ error: unknown; context: ErrorContext | undefined; }' is not assignable to parameter of type 'string'.\nserver/errorHandlerService.ts(221,35): error TS2345: Argument of type '{ name: string; message: string; stack: string | undefined; context: ErrorContext | undefined; }' is not assignable to parameter of type 'string'.\nserver/inspectionPdfGenerator.ts(434,18): error TS2339: Property 'itemResults' does not exist on type '{ items: { id: number; templateItemId: number; itemName: string | null; itemOrder: number; result: \"pass\" | \"fail\" | \"na\"; comments: string | null; photoUrls: string | null; createdAt: Date; }[]; ... 20 more ...; createdAt: Date; }'.\nserver/jobs/autoArchiveJob.ts(31,14): error TS2769: No overload matches this call.\n  Overload 1 of 3, '(left: MySqlColumn<{ name: \"enabled\"; tableName: \"archiveRules\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>, right: number | SQLWrapper): SQL<...>', gave the following error.\n    Argument of type 'boolean' is not assignable to parameter of type 'number | SQLWrapper'.\n  Overload 2 of 3, '(left: Aliased<boolean>, right: boolean | SQLWrapper): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"enabled\"; tableName: \"archiveRules\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'Aliased<boolean>'.\n      Type 'MySqlColumn<{ name: \"enabled\"; tableName: \"archiveRules\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is missing the following properties from type 'Aliased<boolean>': sql, fieldAlias\n  Overload 3 of 3, '(left: never, right: unknown): SQL<unknown>', gave the following error.\n    Argument of type 'MySqlColumn<{ name: \"enabled\"; tableName: \"archiveRules\"; dataType: \"number\"; columnType: \"MySqlTinyInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; isPrimaryKey: false; ... 5 more ...; generated: undefined; }, {}, {}>' is not assignable to parameter of type 'never'.\nserver/jobs/escalationCheck.ts(1,10): error TS2305: Module '\"../db\"' has no exported member 'checkAndTriggerEscalations'.\nserver/jobs/escalationCheck.ts(15,68): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/notificationService.ts(60,51): error TS2769: No overload matches this call.\n  Overload 1 of 2, '(value: { type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }): MySqlInsertBase<...>', gave the following error.\n    Type 'false' is not assignable to type 'number | SQL<unknown> | Placeholder<string, any> | undefined'.\n  Overload 2 of 2, '(values: { type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'userId' does not exist in type '{ type: SQL<unknown> | Placeholder<string, any> | \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | ... 25 more ... | \"system_health_info\"; ... 9 more ...; isRead?: number | ... 2 more ... | undefined; }[]'.\nserver/notificationService.ts(102,9): error TS2322: Type 'number' is not assignable to type 'boolean'.\nserver/notificationService.ts(106,81): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/notificationService.ts(131,69): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/notificationService.ts(138,74): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/notificationService.ts(182,76): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/routers/escalationRouter.ts(12,21): error TS2339: Property 'getAllEscalationRules' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(19,29): error TS2339: Property 'getEscalationRuleById' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(46,31): error TS2339: Property 'createEscalationRule' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(79,16): error TS2339: Property 'updateEscalationRule' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(94,16): error TS2339: Property 'deleteEscalationRule' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(116,23): error TS2339: Property 'getAllEscalationLogs' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(128,23): error TS2339: Property 'getEscalationLogsByEntity' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(140,16): error TS2339: Property 'resolveEscalationLog' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(161,23): error TS2339: Property 'getEscalationStatistics' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/escalationRouter.ts(167,16): error TS2339: Property 'checkAndTriggerEscalations' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(12,21): error TS2339: Property 'getAllRoleTemplates' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(23,23): error TS2339: Property 'getRoleTemplatesByType' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(34,23): error TS2339: Property 'getDefaultRoleTemplate' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(41,33): error TS2339: Property 'getRoleTemplateById' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(49,36): error TS2339: Property 'getRoleTemplatePermissions' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(68,35): error TS2339: Property 'createRoleTemplate' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(105,16): error TS2339: Property 'updateRoleTemplate' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(126,16): error TS2339: Property 'deleteRoleTemplate' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(149,16): error TS2339: Property 'applyRoleTemplateToUser' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(156,33): error TS2339: Property 'getRoleTemplateById' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/roleTemplatesRouter.ts(178,23): error TS2339: Property 'getRoleTemplatePermissions' does not exist on type 'typeof import(\"/home/ubuntu/construction_management_app/server/db\")'.\nserver/routers/userManagementRouter.ts(326,53): error TS2345: Argument of type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }[]' is not assignable to parameter of type 'ActivityLogWithUser[]'.\n  Type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }' is missing the following properties from type 'ActivityLogWithUser': projectId, taskId, defectId\nserver/routers/userManagementRouter.ts(386,47): error TS2345: Argument of type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }[]' is not assignable to parameter of type 'ActivityLogWithUser[]'.\n  Type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }' is missing the following properties from type 'ActivityLogWithUser': projectId, taskId, defectId\nserver/routers/userManagementRouter.ts(444,39): error TS2345: Argument of type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }[]' is not assignable to parameter of type 'ActivityLogWithUser[]'.\n  Type '{ userName: string; userEmail: string; id: number; userId: number; action: string; module: string | null; details: string | null; ipAddress: string | null; userAgent: string | null; createdAt: Date; }' is missing the following properties from type 'ActivityLogWithUser': projectId, taskId, defectId\nserver/securityMiddleware.ts(7,10): error TS2305: Module '\"./_core/trpc\"' has no exported member 'middleware'.\nserver/securityMiddleware.ts(89,32): error TS2345: Argument of type '{ userId: any; userEmail: any; action: any; timestamp: string; ip: any; }' is not assignable to parameter of type 'string'.\nserver/securityMiddleware.ts(134,57): error TS7031: Binding element 'ctx' implicitly has an 'any' type.\nserver/securityMiddleware.ts(134,62): error TS7031: Binding element 'next' implicitly has an 'any' type.\nserver/securityMiddleware.ts(134,68): error TS7031: Binding element 'rawInput' implicitly has an 'any' type.\nserver/securityMiddleware.ts(196,46): error TS2345: Argument of type '{ input: string; fieldName: string; pattern: string; }' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(118,48): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(218,46): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(316,51): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(386,59): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(433,53): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(484,57): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/analytics.service.ts(530,52): error TS2345: Argument of type 'Error' is not assignable to parameter of type 'string'.\nserver/services/defect.service.ts(62,23): error TS2339: Property 'projectId' does not exist on type 'MySqlTableWithColumns<{ name: \"defects\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"defects\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; ... 7 more ...; generated: undefined; }, {}, {}>; ... 34 more ...; escalation: MySqlColumn<...'.\nserver/services/defect.service.ts(76,27): error TS2339: Property 'projectId' does not exist on type 'MySqlTableWithColumns<{ name: \"defects\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"defects\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; ... 7 more ...; generated: undefined; }, {}, {}>; ... 34 more ...; escalation: MySqlColumn<...'.\nserver/services/defect.service.ts(90,27): error TS2339: Property 'projectId' does not exist on type 'MySqlTableWithColumns<{ name: \"defects\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"defects\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; ... 7 more ...; generated: undefined; }, {}, {}>; ... 34 more ...; escalation: MySqlColumn<...'.\nserver/services/defect.service.ts(165,48): error TS2339: Property 'id' does not exist on type '{}'.\nserver/services/defect.service.ts(228,23): error TS2339: Property 'projectId' does not exist on type 'MySqlTableWithColumns<{ name: \"defects\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"defects\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; ... 7 more ...; generated: undefined; }, {}, {}>; ... 34 more ...; escalation: MySqlColumn<...'.\nserver/services/defect.service.ts(254,20): error TS2339: Property 'projectId' does not exist on type 'MySqlTableWithColumns<{ name: \"defects\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"defects\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; ... 7 more ...; generated: undefined; }, {}, {}>; ... 34 more ...; escalation: MySqlColumn<...'.\nserver/services/inspection.service.ts(146,36): error TS2769: No overload matches this call.\n  Overload 1 of 2, '(value: { taskId: number | SQL<unknown> | Placeholder<string, any>; title: string | SQL<unknown> | Placeholder<string, any>; reportedBy: number | SQL<unknown> | Placeholder<...>; ... 32 more ...; closureNotes?: string | ... 3 more ... | undefined; }): MySqlInsertBase<...>', gave the following error.\n    Type '\"open\"' is not assignable to type 'SQL<unknown> | Placeholder<string, any> | \"in_progress\" | \"reported\" | \"analysis\" | \"resolved\" | \"pending_reinspection\" | \"closed\" | undefined'.\n  Overload 2 of 2, '(values: { taskId: number | SQL<unknown> | Placeholder<string, any>; title: string | SQL<unknown> | Placeholder<string, any>; reportedBy: number | SQL<unknown> | Placeholder<...>; ... 32 more ...; closureNotes?: string | ... 3 more ... | undefined; }[]): MySqlInsertBase<...>', gave the following error.\n    Object literal may only specify known properties, and 'taskId' does not exist in type '{ taskId: number | SQL<unknown> | Placeholder<string, any>; title: string | SQL<unknown> | Placeholder<string, any>; reportedBy: number | SQL<unknown> | Placeholder<...>; ... 32 more ...; closureNotes?: string | ... 3 more ... | undefined; }[]'.\nserver/services/inspection.service.ts(200,76): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/services/inspection.service.ts(256,74): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/services/inspection.service.ts(275,68): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/services/inspection.service.ts(287,71): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/services/notification.service.ts(28,46): error TS2339: Property 'id' does not exist on type '{}'.\nserver/services/notification.service.ts(66,33): error TS2339: Property 'recipientId' does not exist on type 'MySqlTableWithColumns<{ name: \"notifications\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"notifications\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; ... 8 more ...; generated: undefined; }, {}, {}>; ... 9 more ...; createdAt: MySqlColumn<...>;...'.\nserver/services/notification.service.ts(95,33): error TS2339: Property 'recipientId' does not exist on type 'MySqlTableWithColumns<{ name: \"notifications\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"notifications\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; ... 8 more ...; generated: undefined; }, {}, {}>; ... 9 more ...; createdAt: MySqlColumn<...>;...'.\nserver/services/notification.service.ts(123,33): error TS2339: Property 'recipientId' does not exist on type 'MySqlTableWithColumns<{ name: \"notifications\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"notifications\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; ... 8 more ...; generated: undefined; }, {}, {}>; ... 9 more ...; createdAt: MySqlColumn<...>;...'.\nserver/services/notification.service.ts(144,19): error TS2345: Argument of type '{ userId: number; id?: number | undefined; type: \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | ... 24 more ... | \"system_health_info\"; ... 7 more ...; createdAt?: Date | undefined; }[]' is not assignable to parameter of type 'MySqlTable<TableConfig>'.\n  Type '{ userId: number; id?: number | undefined; type: \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | ... 24 more ... | \"system_health_info\"; ... 7 more ...; createdAt?: Date | undefined; }[]' is missing the following properties from type 'MySqlTable<TableConfig>': $columns, _, $inferSelect, $inferInsert, getSQL\nserver/services/notification.service.ts(160,5): error TS2353: Object literal may only specify known properties, and 'message' does not exist in type '{ userId: number; type: \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | \"inspection_requested\" | ... 23 more ... | \"system_health_info\"; ... 8 more ...; createdAt?: Date | undefined; }'.\nserver/services/notification.service.ts(174,5): error TS2353: Object literal may only specify known properties, and 'message' does not exist in type '{ userId: number; type: \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | \"inspection_requested\" | ... 23 more ... | \"system_health_info\"; ... 8 more ...; createdAt?: Date | undefined; }'.\nserver/services/notification.service.ts(187,5): error TS2322: Type '\"task_due_soon\"' is not assignable to type '\"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | \"inspection_requested\" | \"inspection_completed\" | ... 22 more ... | \"system_health_info\"'.\nserver/services/notification.service.ts(202,5): error TS2322: Type '\"qc_inspection_scheduled\"' is not assignable to type '\"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | \"inspection_requested\" | \"inspection_completed\" | ... 22 more ... | \"system_health_info\"'.\nserver/services/notification.service.ts(217,5): error TS2353: Object literal may only specify known properties, and 'message' does not exist in type 'Omit<{ userId: number; type: \"task_assigned\" | \"task_status_changed\" | \"task_deadline_approaching\" | \"task_overdue\" | \"task_progress_updated\" | \"task_comment_mention\" | \"inspection_requested\" | ... 23 more ... | \"system_health_info\"; ... 8 more ...; createdAt?: Date | undefined; }, \"userId\">'.\nserver/services/project.service.ts(54,33): error TS18047: 'lastCode' is possibly 'null'.\nserver/services/project.service.ts(170,39): error TS7006: Parameter 't' implicitly has an 'any' type.\nserver/services/project.service.ts(197,54): error TS7006: Parameter 'tc' implicitly has an 'any' type.\nserver/services/task.service.ts(62,25): error TS2339: Property 'dueDate' does not exist on type 'MySqlTableWithColumns<{ name: \"tasks\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"tasks\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; ... 6 more ...; generated: undefined; }, {}, {}>; ... 15 more ...; escalation...'.\nserver/services/task.service.ts(120,40): error TS2339: Property 'id' does not exist on type '{}'.\nserver/services/task.service.ts(196,40): error TS2339: Property 'id' does not exist on type '{}'.\nserver/services/task.service.ts(265,21): error TS2339: Property 'dueDate' does not exist on type 'MySqlTableWithColumns<{ name: \"tasks\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"tasks\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; ... 6 more ...; generated: undefined; }, {}, {}>; ... 15 more ...; escalation...'.\nserver/services/task.service.ts(269,20): error TS2339: Property 'dueDate' does not exist on type 'MySqlTableWithColumns<{ name: \"tasks\"; schema: undefined; columns: { id: MySqlColumn<{ name: \"id\"; tableName: \"tasks\"; dataType: \"number\"; columnType: \"MySqlInt\"; data: number; driverParam: string | number; notNull: true; hasDefault: true; ... 6 more ...; generated: undefined; }, {}, {}>; ... 15 more ...; escalation...'.\nserver/services/user.service.ts(26,75): error TS2339: Property 'id' does not exist on type '{}'.\nserver/services/user.service.ts(144,35): error TS2339: Property 'id' does not exist on type '{}'.\nserver/utils/transaction.ts(35,71): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/utils/transaction.ts(63,77): error TS2345: Argument of type 'unknown' is not assignable to parameter of type 'string | undefined'.\nserver/validationService.ts(328,31): error TS2802: Type 'MapIterator<[string, { count: number; resetTime: number; }]>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.\nvite.config.ts(111,3): error TS2769: No overload matches this call.\n  The last overload gave the following error.\n    Type '(false | Plugin<any> | Plugin<any>[] | Plugin)[]' is not assignable to type 'PluginOption[]'.\n      Type 'false | Plugin<any> | Plugin<any>[] | Plugin' is not assignable to type 'PluginOption'.\n        Type 'Plugin' is not assignable to type 'PluginOption'.\n          Type 'Plugin' is not assignable to type 'Plugin<any>'.\n            Types of property 'resolveId' are incompatible.\n              Type 'ObjectHook<(this: PluginContext, source: string, importer: string | undefined, options: { custom?: CustomPluginOptions | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>, {}> | undefined' is not assignable to type 'ObjectHook<(this: PluginContext, source: string, importer: string | undefined, options: { attributes: Record<string, string>; custom?: CustomPluginOptions | undefined; ssr?: boolean | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>, { ...; }> | undefined'.\n                Type '(this: PluginContext, source: string, importer: string | undefined, options: { custom?: CustomPluginOptions | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>' is not assignable to type 'ObjectHook<(this: PluginContext, source: string, importer: string | undefined, options: { attributes: Record<string, string>; custom?: CustomPluginOptions | undefined; ssr?: boolean | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>, { ...; }> | undefined'.\n                  Type '(this: PluginContext, source: string, importer: string | undefined, options: { custom?: CustomPluginOptions | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>' is not assignable to type '(this: PluginContext, source: string, importer: string | undefined, options: { attributes: Record<string, string>; custom?: CustomPluginOptions | undefined; ssr?: boolean | undefined; isEntry: boolean; }) => ResolveIdResult | Promise<...>'.\n                    The 'this' types of each signature are incompatible.\n                      Type 'PluginContext' is missing the following properties from type 'PluginContext': emitAsset, emitChunk, getAssetFileName, getChunkFileName, and 3 more.\n",
  "important_files": {
    "server/routers.ts": "import { z } from \"zod\";\nimport { canEditDefect, canDeleteDefect } from \"@shared/permissions\";\nimport { TRPCError } from \"@trpc/server\";\nimport { boolToInt } from \"./utils/typeHelpers.js\";\nimport { COOKIE_NAME } from \"@shared/const\";\nimport {\n  validateTaskCreateInput,\n  validateTaskUpdateInput,\n  validateInspectionSubmission,\n  validateDefectCreateInput,\n  validateDefectUpdateInput,\n} from \"@shared/validationUtils\";\nimport { systemRouter } from \"./_core/systemRouter\";\nimport {\n  protectedProcedure,\n  publicProcedure,\n  router,\n  roleBasedProcedure,\n} from \"./_core/trpc\";\nimport * as db from \"./db\";\nimport * as analyticsService from \"./services/analytics.service\";\nimport {\n  generateProjectExport,\n  generateProjectReport,\n} from \"./downloadProject\";\nimport { generateArchiveExcel } from \"./excelExport\";\nimport { storagePut } from \"./storage\";\nimport {\n  getTaskDisplayStatus,\n  getTaskDisplayStatusLabel,\n  getTaskDisplayStatusColor,\n} from \"./taskStatusHelper\";\nimport { notifyOwner } from \"./_core/notification\";\nimport { checkArchiveWarnings } from \"./archiveNotifications\";\nimport { emitNotification } from \"./_core/socket\";\nimport { createNotification } from \"./notificationService\";\nimport {\n  projectSchema,\n  taskSchema,\n  defectSchema,\n  inspectionSchema,\n} from \"@shared/validations\";\nimport { healthRouter } from \"./monitoring/healthRouter\";\nimport { optimizationRouter } from \"./optimization/optimizationRouter\";\nimport { cacheRouter } from \"./cache/cacheRouter\";\nimport { databaseRouter } from \"./database/databaseRouter\";\nimport { performanceRouter } from \"./performance/performanceRouter\";\nimport { getHealthStatus, formatBytes } from \"./health\";\nimport { exportRouter } from \"./exportRouter\";\nimport { monitoringRouter } from \"./routers/monitoring\";\nimport { teamRouter } from \"./routers/teamRouter\";\nimport { userManagementRouter } from \"./routers/userManagementRouter\";\nimport { roleTemplatesRouter } from \"./routers/roleTemplatesRouter\";\nimport { escalationRouter } from \"./routers/escalationRouter\";\nimport { logger } from \"./logger\";\nimport { getSessionCookieOptions } from \"./_core/cookies\";\nimport { getVapidPublicKey } from \"./_core/pushNotification\";\n\n/**\n * Project Router - Project Management\n */\nconst projectRouter = router({\n  getNextProjectCode: protectedProcedure.query(async () => {\n    return await db.generateProjectCode();\n  }),\n\n  list: protectedProcedure\n    .input(z.object({\n      page: z.number().int().min(1).default(1),\n      pageSize: z.number().int().min(1).max(100).default(25),\n    }).optional())\n    .query(async ({ ctx, input }) => {\n      const page = input?.page || 1;\n      const pageSize = input?.pageSize || 25;\n      const offset = (page - 1) * pageSize;\n\n      const projects = await db.getAllProjects();\n      const totalItems = projects.length;\n      \n      // Apply pagination\n      const paginatedProjects = projects.slice(offset, offset + pageSize);\n      const projectIds = paginatedProjects.map((p: any) => p.id);\n      const statsMap = await db.getBatchProjectStats(projectIds);\n      \n      const projectsWithStats = paginatedProjects.map((p: any) => {\n        const stats = statsMap.get(p.id);\n        return {\n          ...p,\n          taskCount: stats?.totalTasks || 0,\n          completedTasks: stats?.completedTasks || 0,\n          progressPercentage: stats?.progressPercentage || 0,\n          projectStatus: stats?.projectStatus || \"on_track\",\n        };\n      });\n\n      const totalPages = Math.ceil(totalItems / pageSize);\n      return {\n        items: projectsWithStats,\n        pagination: {\n          currentPage: page,\n          pageSize,\n          totalItems,\n          totalPages,\n          hasMore: page < totalPages,\n          hasPrevious: page > 1,\n        },\n      };\n    }),\n\n  get: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getProjectById(input.id);\n    }),\n\n  create: roleBasedProcedure(\"projects\", \"create\")\n    .input(projectSchema)\n    .mutation(async ({ input, ctx }) => {\n      const result = await db.createProject({\n        ...input,\n        createdBy: ctx.user!.id,\n      });\n\n      const projectId = result.id;\n\n      if (!projectId || isNaN(projectId)) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: `Failed to create project: invalid project ID (${projectId})`,\n        });\n      }\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId,\n        action: \"project_created\",\n        details: JSON.stringify({ name: input.name }),\n      });\n\n      return { success: true, id: projectId };\n    }),\n\n  update: roleBasedProcedure(\"projects\", \"edit\")\n    .input(\n      z.object({\n        id: z.number(),\n        name: z.string().optional(),\n        code: z.string().optional(),\n        location: z.string().optional(),\n        latitude: z.string().optional(),\n        longitude: z.string().optional(),\n        startDate: z.string().optional(),\n        endDate: z.string().optional(),\n        ownerName: z.string().optional(),\n        color: z.string().optional(),\n        status: z\n          .enum([\n            \"draft\",\n            \"planning\",\n            \"active\",\n            \"on_hold\",\n            \"completed\",\n            \"cancelled\",\n          ])\n          .optional(),\n        completionPercentage: z.number().optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { id, ...updateData } = input;\n      const project = await db.getProjectById(id);\n      const result = await db.updateProject(id, updateData);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: id,\n        action: \"project_updated\",\n        details: JSON.stringify(updateData),\n      });\n\n      // Send notification if status changed\n      if (updateData.status && project) {\n        const members = await db.getProjectMembers(id);\n        const statusLabels: Record<string, string> = {\n          planning: \"\",\n          active: \"\",\n          on_hold: \"\",\n          completed: \"\",\n          cancelled: \"\",\n        };\n\n        // Notify owner about status change\n        const notification = {\n          id: `project-status-${id}-${Date.now()}`,\n          type: \"project_status\" as const,\n          title: \"\",\n          message: ` \"${project.name}\"  \"${statusLabels[updateData.status]}\"`,\n          link: `/projects/${id}`,\n          timestamp: new Date(),\n          read: false,\n        };\n\n        // Notify all project members\n        if (members && members.length > 0) {\n          members.forEach((member: any) => {\n            emitNotification(member.userId, notification);\n          });\n        }\n      }\n\n      return result;\n    }),\n\n  archive: protectedProcedure\n    .input(\n      z.object({\n        id: z.number(),\n        reason: z.string().optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      await db.archiveProject(input.id, ctx.user!.id, input.reason);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_archived\",\n        details: input.reason || \"Project archived\",\n      });\n\n      return { success: true };\n    }),\n\n  unarchive: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      await db.unarchiveProject(input.id, ctx.user!.id);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_unarchived\",\n        details: \"Project unarchived\",\n      });\n\n      return { success: true };\n    }),\n\n  listArchived: protectedProcedure.query(async ({ ctx }) => {\n    const archivedProjects = await db.getArchivedProjects(ctx.user!.id);\n    const projectIds = archivedProjects.map((p: any) => p.id);\n    const statsMap = await db.getBatchProjectStats(projectIds);\n    \n    const projectsWithStats = archivedProjects.map((project: any) => {\n      const stats = statsMap.get(project.id);\n      return {\n        ...project,\n        taskCount: stats?.totalTasks || 0,\n        completedTasks: stats?.completedTasks || 0,\n        progressPercentage: stats?.progressPercentage || 0,\n      };\n    });\n    return projectsWithStats;\n  }),\n\n  exportArchiveExcel: protectedProcedure.query(async ({ ctx }) => {\n    const archivedProjects = await db.getArchivedProjects(ctx.user!.id);\n\n    const exportData = archivedProjects.map((project: any) => {\n      const archivedYears = project.archivedAt\n        ? (Date.now() - new Date(project.archivedAt).getTime()) /\n          (1000 * 60 * 60 * 24 * 365)\n        : 0;\n\n      return {\n        id: project.id,\n        name: project.name,\n        code: project.code,\n        location: project.location,\n        startDate: project.startDate,\n        endDate: project.endDate,\n        projectStatus: project.status,\n        archivedAt: project.archivedAt,\n        archivedReason: project.archivedReason,\n        archivedYears,\n      };\n    });\n\n    const excelBuffer = await generateArchiveExcel(exportData);\n    const base64 = excelBuffer.toString(\"base64\");\n\n    return {\n      data: base64,\n      fileName: `archive_projects_${new Date().toISOString().split(\"T\")[0]}.xlsx`,\n    };\n  }),\n\n  getArchiveHistory: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getArchiveHistory(input.id);\n    }),\n\n  addMember: roleBasedProcedure(\"projects\", \"assignMembers\")\n    .input(\n      z.object({\n        projectId: z.number(),\n        userId: z.number(),\n        role: z.enum([\"project_manager\", \"qc_inspector\", \"worker\"]),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      return await db.addProjectMember(input);\n    }),\n\n  validateCompleteness: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      return await db.validateProjectCompleteness(input.id);\n    }),\n\n  openProject: roleBasedProcedure(\"projects\", \"edit\")\n    .input(\n      z.object({\n        id: z.number(),\n        newStatus: z.enum([\"planning\", \"active\"]),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const result = await db.openProject(input.id, input.newStatus);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_opened\",\n        details: JSON.stringify({ newStatus: input.newStatus }),\n      });\n\n      return result;\n    }),\n\n  exportExcel: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      const { exportProjectToExcel, getExportFilename } = await import(\n        \"./exportExcel\"\n      );\n      const project = await db.getProjectById(input.id);\n      if (!project) {\n        throw new TRPCError({\n          code: \"NOT_FOUND\",\n          message: \"Project not found\",\n        });\n      }\n\n      const buffer = await exportProjectToExcel(input.id);\n      const base64 = buffer.toString(\"base64\");\n      const filename = getExportFilename(project.name, \"xlsx\");\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_exported\",\n        details: JSON.stringify({ format: \"excel\", filename }),\n      });\n\n      return { data: base64, filename };\n    }),\n\n  exportPDF: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      const { exportProjectToPDF } = await import(\"./exportPDF\");\n      const { getExportFilename } = await import(\"./exportExcel\");\n      const project = await db.getProjectById(input.id);\n      if (!project) {\n        throw new TRPCError({\n          code: \"NOT_FOUND\",\n          message: \"Project not found\",\n        });\n      }\n\n      const buffer = await exportProjectToPDF(input.id);\n      const base64 = buffer.toString(\"base64\");\n      const filename = getExportFilename(project.name, \"pdf\");\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_exported\",\n        details: JSON.stringify({ format: \"pdf\", filename }),\n      });\n\n      return { data: base64, filename };\n    }),\n\n  delete: roleBasedProcedure(\"projects\", \"delete\")\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      await db.deleteProject(input.id);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: input.id,\n        action: \"project_deleted\",\n        details: JSON.stringify({ projectId: input.id }),\n      });\n\n      return { success: true };\n    }),\n\n  bulkDelete: protectedProcedure\n    .input(z.object({ ids: z.array(z.number()) }))\n    .mutation(async ({ input, ctx }) => {\n      const results = {\n        success: [] as number[],\n        failed: [] as { id: number; error: string }[],\n      };\n\n      for (const id of input.ids) {\n        try {\n          await db.deleteProject(id);\n          await db.logActivity({\n            userId: ctx.user!.id,\n            projectId: id,\n            action: \"project_deleted\",\n            details: JSON.stringify({ projectId: id, bulkOperation: true }),\n          });\n          results.success.push(id);\n        } catch (error) {\n          results.failed.push({\n            id,\n            error: error instanceof Error ? error.message : \"Unknown error\",\n          });\n        }\n      }\n\n      return results;\n    }),\n\n  stats: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      return await analyticsService.getProjectStats(input.id);\n    }),\n\n  downloadData: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      // Simplified version - just get basic project data\n      const project = await db.getProjectById(input.id);\n      if (!project) {\n        throw new TRPCError({\n          code: \"NOT_FOUND\",\n          message: \"Project not found\",\n        });\n      }\n\n      // Create simple export data\n      const exportData = {\n        project: {\n          id: project.id,\n          name: project.name,\n          code: project.code,\n          location: project.location,\n          startDate: project.startDate,\n          endDate: project.endDate,\n          projectStatus: project.status,\n          archivedAt: project.archivedAt,\n          archivedReason: project.archivedReason,\n        },\n        exportedAt: new Date().toISOString(),\n      };\n\n      // Create simple report\n      const report =\n        `# : ${project.name}\\n\\n` +\n        `**:** ${project.code || \"N/A\"}\\n` +\n        `**:** ${project.location || \"N/A\"}\\n` +\n        `**:** ${project.status}\\n` +\n        `** Archive:** ${project.archivedAt ? new Date(project.archivedAt).toLocaleDateString(\"th-TH\") : \"N/A\"}\\n` +\n        `**:** ${project.archivedReason || \"N/A\"}\\n`;\n\n      return {\n        exportData,\n        report,\n        fileName: `project_${project.code || project.id}_export_${Date.now()}.json`,\n        reportFileName: `project_${project.code || project.id}_report_${Date.now()}.md`,\n      };\n    }),\n\n  listWithStats: protectedProcedure.query(async ({ ctx }) => {\n    const projects = await db.getProjectsByUser(ctx.user!.id);\n    const projectIds = projects.map((p: any) => p.projects.id);\n    const statsMap = await db.getBatchProjectStats(projectIds);\n    \n    const projectsWithStats = projects.map((p: any) => {\n      const stats = statsMap.get(p.projects.id);\n      return {\n        ...p.projects,\n        stats,\n      };\n    });\n    return projectsWithStats;\n  }),\n});\n\n/**\n * Task Router - Task Management\n */\nconst taskRouter = router({\n  list: protectedProcedure\n    .input(z.object({ \n      projectId: z.number().optional(),\n      page: z.number().int().min(1).default(1),\n      pageSize: z.number().int().min(1).max(100).default(25),\n    }))\n    .query(async ({ input, ctx }) => {\n      const { projectId, page = 1, pageSize = 25 } = input;\n      const offset = (page - 1) * pageSize;\n\n      let tasks;\n      if (projectId) {\n        tasks = await db.getTasksByProject(projectId);\n      } else {\n        // Return all tasks for user if no projectId specified\n        tasks = await db.getTasksByAssignee(ctx.user!.id);\n      }\n\n      const totalItems = tasks.length;\n\n      // Apply pagination\n      const paginatedTasks = tasks.slice(offset, offset + pageSize);\n\n      // Add computed display status to each task\n      const tasksWithStatus = paginatedTasks.map((task: any) => {\n        const displayStatus = getTaskDisplayStatus(task);\n        return {\n          ...task,\n          displayStatus,\n          displayStatusLabel: getTaskDisplayStatusLabel(displayStatus),\n          displayStatusColor: getTaskDisplayStatusColor(displayStatus),\n        };\n      });\n\n      const totalPages = Math.ceil(totalItems / pageSize);\n      return {\n        items: tasksWithStatus,\n        pagination: {\n          currentPage: page,\n          pageSize,\n          totalItems,\n          totalPages,\n          hasMore: page < totalPages,\n          hasPrevious: page > 1,\n        },\n      };\n    }),\n\n  get: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .query(async ({ input }) => {\n      const task = await db.getTaskById(input.id);\n      if (!task) return null;\n\n      // Add computed display status\n      const displayStatus = getTaskDisplayStatus(task);\n      return {\n        ...task,\n        displayStatus,\n        displayStatusLabel: getTaskDisplayStatusLabel(displayStatus),\n        displayStatusColor: getTaskDisplayStatusColor(displayStatus),\n      };\n    }),\n\n  myTasks: protectedProcedure.query(async ({ ctx }) => {\n    // Get all projects where user is a member\n    const userProjects = await db.getProjectsByUser(ctx.user!.id);\n    const myProjectIds = userProjects.map((p: any) => p.projects.id);\n\n    // Get all tasks from those projects\n    const allTasks: any[] = [];\n    for (const projectId of myProjectIds) {\n      const projectTasks = await db.getTasksByProject(projectId);\n      allTasks.push(...projectTasks);\n    }\n\n    // Add computed display status to each task\n    return allTasks.map(task => {\n      const displayStatus = getTaskDisplayStatus(task);\n      return {\n        ...task,\n        displayStatus,\n        displayStatusLabel: getTaskDisplayStatusLabel(displayStatus),\n        displayStatusColor: getTaskDisplayStatusColor(displayStatus),\n      };\n    });\n  }),\n\n  create: roleBasedProcedure(\"tasks\", \"create\")\n    .input(taskSchema)\n    .mutation(async ({ input, ctx }) => {\n      try {\n        // Validate input using type guards\n        const validation = validateTaskCreateInput({\n          ...input,\n          projectId: input.projectId,\n        });\n\n        if (!validation.valid) {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: validation.errors?.join(\", \") || \"Invalid input\",\n          });\n        }\n\n        const result = await db.createTask({\n          ...validation.data!,\n          createdBy: ctx.user!.id,\n        });\n\n        const taskId = (result as any).insertId as number;\n\n        await db.logActivity({\n          userId: ctx.user!.id,\n          projectId: input.projectId,\n          taskId,\n          action: \"task_created\",\n          details: JSON.stringify({ name: input.name }),\n        });\n\n        // Create notification for assignee using notification service\n        if (input.assigneeId) {\n          await createNotification({\n            userId: input.assigneeId,\n            type: \"task_assigned\",\n            title: \"\",\n            content: `: \"${input.name}\"`,\n            priority: \"normal\",\n            relatedTaskId: taskId,\n            relatedProjectId: input.projectId,\n            sendEmail: true, // Send email for task assignments\n          });\n        }\n\n        return { success: true, id: taskId };\n      } catch (error) {\n        logger.error(\"[ERROR] Task create failed\", undefined, error);\n        throw error;\n      }\n    }),\n\n  update: roleBasedProcedure(\"tasks\", \"edit\")\n    .input(\n      z.object({\n        id: z.number(),\n        name: z.string().optional(),\n        description: z.string().optional(),\n        startDate: z.string().optional(),\n        endDate: z.string().optional(),\n        status: z\n          .enum([\n            \"todo\",\n            \"pending_pre_inspection\",\n            \"ready_to_start\",\n            \"in_progress\",\n            \"pending_final_inspection\",\n            \"rectification_needed\",\n            \"completed\",\n          ])\n          .optional(),\n        progress: z.number().min(0).max(100).optional(),\n        assigneeId: z.number().optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { id, ...updateData } = input;\n      const task = await db.getTaskById(id);\n      if (!task) throw new Error(\"Task not found\");\n\n      // Convert date strings to Date objects if present\n      const dbUpdateData: any = { ...updateData };\n      if (updateData.startDate) {\n        dbUpdateData.startDate = new Date(updateData.startDate);\n      }\n      if (updateData.endDate) {\n        dbUpdateData.endDate = new Date(updateData.endDate);\n      }\n\n      const result = await db.updateTask(id, dbUpdateData);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        taskId: id,\n        projectId: task.projectId,\n        action: \"task_updated\",\n        details: JSON.stringify(updateData),\n      });\n\n      // Send real-time notifications\n      if (updateData.status) {\n        const displayStatus = getTaskDisplayStatusLabel(\n          updateData.status as any\n        );\n        const notification = {\n          id: `task-status-${id}-${Date.now()}`,\n          type: \"task_status\" as const,\n          title: \"\",\n          message: ` \"${task.name}\"  \"${displayStatus}\"`,\n          link: `/tasks/${id}`,\n          timestamp: new Date(),\n          read: false,\n        };\n\n        // Notify task followers\n        const followers = await db.getTaskFollowers(id);\n        followers.forEach((follower: any) => {\n          if (follower.userId !== ctx.user!.id) {\n            emitNotification(follower.userId, notification);\n          }\n        });\n      }\n\n      // Send notification if task is assigned to someone\n      if (updateData.assigneeId && updateData.assigneeId !== task.assigneeId) {\n        await createNotification({\n          userId: updateData.assigneeId,\n          type: \"task_assigned\",\n          title: \"\",\n          content: ` \"${task.name}\"`,\n          priority: \"normal\",\n          relatedTaskId: id,\n          relatedProjectId: task.projectId,\n          sendEmail: true,\n        });\n      }\n\n      // Send notification if progress is updated significantly (25%, 50%, 75%, 100%)\n      if (\n        updateData.progress !== undefined &&\n        task.progress !== updateData.progress\n      ) {\n        const milestones = [25, 50, 75, 100];\n        const oldProgress = task.progress || 0;\n        const newProgress = updateData.progress;\n\n        // Check if we crossed a milestone\n        const crossedMilestone = milestones.find(\n          milestone => oldProgress < milestone && newProgress >= milestone\n        );\n\n        if (crossedMilestone && task.assigneeId) {\n          // Notify task followers about progress milestone\n          const followers = await db.getTaskFollowers(id);\n          for (const follower of followers) {\n            if (follower.userId !== ctx.user!.id) {\n              await createNotification({\n                userId: follower.userId,\n                type: \"task_progress_updated\",\n                title: \"\",\n                content: ` \"${task.name}\"  ${crossedMilestone}% `,\n                priority: \"normal\",\n                relatedTaskId: id,\n                relatedProjectId: task.projectId,\n                sendEmail: false, // Don't send email for progress updates\n              });\n            }\n          }\n        }\n      }\n\n      return result;\n    }),\n\n  addDependency: protectedProcedure\n    .input(\n      z.object({\n        taskId: z.number(),\n        dependsOnTaskId: z.number(),\n        type: z\n          .enum([\"finish_to_start\", \"start_to_start\", \"finish_to_finish\"])\n          .optional(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      return await db.addTaskDependency(input);\n    }),\n\n  getDependencies: protectedProcedure\n    .input(z.object({ taskId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getTaskDependencies(input.taskId);\n    }),\n\n  removeDependency: protectedProcedure\n    .input(\n      z.object({\n        taskId: z.number(),\n        dependsOnTaskId: z.number(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      return await db.removeTaskDependency(input.taskId, input.dependsOnTaskId);\n    }),\n\n  getProjectDependencies: protectedProcedure\n    .input(z.object({ projectId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getAllTaskDependenciesForProject(input.projectId);\n    }),\n\n  getCriticalPath: protectedProcedure\n    .input(z.object({ projectId: z.number() }))\n    .query(async ({ input }) => {\n      const { calculateCriticalPath } = await import(\"./criticalPath\");\n      const tasks = await db.getTasksByProject(input.projectId);\n      const dependencies = await db.getAllTaskDependenciesForProject(\n        input.projectId\n      );\n\n      // Transform tasks to include dependencies\n      const tasksWithDeps = tasks.map((task: any) => ({\n        id: task.id,\n        startDate: task.startDate,\n        endDate: task.endDate,\n        dependencies: dependencies.filter((d: any) => d.taskId === task.id),\n      }));\n\n      return calculateCriticalPath(tasksWithDeps as any);\n    }),\n\n  delete: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      const task = await db.getTaskById(input.id);\n      if (!task) throw new Error(\"Task not found\");\n\n      await db.deleteTask(input.id);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        projectId: task.projectId,\n        taskId: input.id,\n        action: \"task_deleted\",\n        details: JSON.stringify({ name: task.name }),\n      });\n\n      return { success: true };\n    }),\n\n  bulkUpdateStatus: roleBasedProcedure(\"tasks\", \"edit\")\n    .input(\n      z.object({\n        taskIds: z.array(z.number()).min(1),\n        status: z.enum([\n          \"todo\",\n          \"pending_pre_inspection\",\n          \"ready_to_start\",\n          \"in_progress\",\n          \"pending_final_inspection\",\n          \"rectification_needed\",\n          \"completed\",\n        ]),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { taskIds, status } = input;\n      let successCount = 0;\n\n      for (const taskId of taskIds) {\n        try {\n          const task = await db.getTaskById(taskId);\n          if (!task) continue;\n\n          await db.updateTask(taskId, { status: status as any });\n          await db.logActivity({\n            userId: ctx.user!.id,\n            taskId,\n            projectId: task.projectId,\n            action: \"task_updated\",\n            details: JSON.stringify({ status, bulkUpdate: true }),\n          });\n          successCount++;\n        } catch (error) {\n          logger.error(`Failed to update task ${taskId}`, undefined, error);\n        }\n      }\n\n      return { success: true, updated: successCount, total: taskIds.length };\n    }),\n\n  bulkAssign: roleBasedProcedure(\"tasks\", \"edit\")\n    .input(\n      z.object({\n        taskIds: z.array(z.number()).min(1),\n        assigneeId: z.number(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { taskIds, assigneeId } = input;\n      let successCount = 0;\n\n      for (const taskId of taskIds) {\n        try {\n          const task = await db.getTaskById(taskId);\n          if (!task) continue;\n\n          await db.updateTask(taskId, { assigneeId });\n          await db.logActivity({\n            userId: ctx.user!.id,\n            taskId,\n            projectId: task.projectId,\n            action: \"task_updated\",\n            details: JSON.stringify({ assigneeId, bulkAssign: true }),\n          });\n\n          // Create notification for assignee\n          await db.createNotification({\n            userId: assigneeId,\n            type: \"task_assigned\",\n            title: \"New Task Assigned\",\n            content: task.name,\n            relatedTaskId: taskId,\n            relatedProjectId: task.projectId,\n          });\n          successCount++;\n        } catch (error) {\n          logger.error(`Failed to assign task ${taskId}`, undefined, error);\n        }\n      }\n\n      return { success: true, assigned: successCount, total: taskIds.length };\n    }),\n\n  bulkDelete: roleBasedProcedure(\"tasks\", \"delete\")\n    .input(\n      z.object({\n        taskIds: z.array(z.number()).min(1),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const result = await db.bulkDeleteTasks(input.taskIds, ctx.user!.id);\n      return result;\n    }),\n\n  updatePriority: roleBasedProcedure(\"tasks\", \"edit\")\n    .input(\n      z.object({\n        id: z.number(),\n        priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      return await db.updateTaskPriority(\n        input.id,\n        input.priority,\n        ctx.user!.id\n      );\n    }),\n\n  updateCategory: roleBasedProcedure(\"tasks\", \"edit\")\n    .input(\n      z.object({\n        id: z.number(),\n        category: z.string().nullable(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      return await db.updateTaskCategory(\n        input.id,\n        input.category,\n        ctx.user!.id\n      );\n    }),\n\n  getBlockingDependencies: protectedProcedure\n    .input(z.object({ taskId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getBlockingDependencies(input.taskId);\n    }),\n\n  validateCanStart: protectedProcedure\n    .input(z.object({ taskId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.validateTaskCanStart(input.taskId);\n    }),\n\n  search: protectedProcedure\n    .input(\n      z.object({\n        query: z.string().optional(),\n        projectId: z.number().optional(),\n        status: z.string().optional(),\n        assigneeId: z.number().optional(),\n      })\n    )\n    .query(async ({ input, ctx }) => {\n      // Get all tasks based on filters\n      let tasks;\n\n      if (input.projectId) {\n        tasks = await db.getTasksByProject(input.projectId);\n      } else {\n        // Get all tasks from user's projects\n        const userProjects = await db.getProjectsByUser(ctx.user!.id);\n        const projectIds = userProjects.map((p: any) => p.projects.id);\n\n        const allTasks: any[] = [];\n        for (const projectId of projectIds) {\n          const projectTasks = await db.getTasksByProject(projectId);\n          allTasks.push(...projectTasks);\n        }\n        tasks = allTasks;\n      }\n\n      // Apply filters\n      let filteredTasks = tasks;\n\n      // Filter by search query (name or description)\n      if (input.query && input.query.trim() !== \"\") {\n        const queryLower = input.query.toLowerCase();\n        filteredTasks = filteredTasks.filter(\n          (task: any) =>\n            task.name.toLowerCase().includes(queryLower) ||\n            (task.description &&\n              task.description.toLowerCase().includes(queryLower))\n        );\n      }\n\n      // Filter by status\n      if (input.status && input.status !== \"all\") {\n        filteredTasks = filteredTasks.filter(\n          (task: any) => task.status === input.status\n        );\n      }\n\n      // Filter by assignee\n      if (input.assigneeId) {\n        filteredTasks = filteredTasks.filter(\n          (task: any) => task.assigneeId === input.assigneeId\n        );\n      }\n\n      // Add computed display status to each task\n      return filteredTasks.map((task: any) => {\n        const displayStatus = getTaskDisplayStatus(task);\n        return {\n          ...task,\n          displayStatus,\n          displayStatusLabel: getTaskDisplayStatusLabel(displayStatus),\n          displayStatusColor: getTaskDisplayStatusColor(displayStatus),\n        };\n      });\n    }),\n});\n\n/**\n * Checklist Router - QC Management\n */\n/**\n * Inspection Router - QC Inspection Management\n */\nconst inspectionRouter = router({\n  // List inspections by project with pagination\n  listByProject: protectedProcedure\n    .input(z.object({\n      projectId: z.number(),\n      page: z.number().int().min(1).default(1),\n      pageSize: z.number().int().min(1).max(100).default(25),\n    }))\n    .query(async ({ input }) => {\n      const { projectId, page = 1, pageSize = 25 } = input;\n      const offset = (page - 1) * pageSize;\n\n      // Get all inspections for the project\n      const allInspections = await db.getTaskChecklistsByProject(projectId);\n      const totalItems = allInspections.length;\n\n      // Apply pagination\n      const paginatedInspections = allInspections.slice(offset, offset + pageSize);\n\n      const totalPages = Math.ceil(totalItems / pageSize);\n      return {\n        items: paginatedInspections,\n        pagination: {\n          currentPage: page,\n          pageSize,\n          totalItems,\n          totalPages,\n          hasMore: page < totalPages,\n          hasPrevious: page > 1,\n        },\n      };\n    }),\n\n  // List all inspections with pagination (for admin)\n  list: protectedProcedure\n    .input(z.object({\n      page: z.number().int().min(1).default(1),\n      pageSize: z.number().int().min(1).max(100).default(25),\n      search: z.string().optional(),\n      status: z.enum([\"not_started\", \"pending_inspection\", \"in_progress\", \"completed\", \"failed\"]).optional(),\n      projectId: z.number().optional(),\n    }).optional())\n    .query(async ({ input }) => {\n      const page = input?.page || 1;\n      const pageSize = input?.pageSize || 25;\n      const offset = (page - 1) * pageSize;\n\n      // Get all inspections\n      let allInspections = await db.getAllTaskChecklists();\n\n      // Apply filters\n      if (input?.search) {\n        const searchLower = input.search.toLowerCase();\n        allInspections = allInspections.filter((inspection: any) => \n          inspection.taskName?.toLowerCase().includes(searchLower) ||\n          inspection.templateName?.toLowerCase().includes(searchLower) ||\n          inspection.projectName?.toLowerCase().includes(searchLower)\n        );\n      }\n\n      if (input?.status) {\n        allInspections = allInspections.filter((inspection: any) => inspection.status === input.status);\n      }\n\n      if (input?.projectId) {\n        allInspections = allInspections.filter((inspection: any) => inspection.projectId === input.projectId);\n      }\n\n      const totalItems = allInspections.length;\n\n      // Apply pagination\n      const paginatedInspections = allInspections.slice(offset, offset + pageSize);\n\n      const totalPages = Math.ceil(totalItems / pageSize);\n      return {\n        items: paginatedInspections,\n        pagination: {\n          currentPage: page,\n          pageSize,\n          totalItems,\n          totalPages,\n          hasMore: page < totalPages,\n          hasPrevious: page > 1,\n        },\n      };\n    }),\n\n  // Get inspection statistics\n  getStats: protectedProcedure\n    .input(z.object({\n      projectId: z.number().optional(),\n    }).optional())\n    .query(async ({ input }) => {\n      let allInspections = await db.getAllTaskChecklists();\n\n      // Filter by project if specified\n      if (input?.projectId) {\n        allInspections = allInspections.filter((inspection: any) => inspection.projectId === input.projectId);\n      }\n\n      const total = allInspections.length;\n      const pending = allInspections.filter((i: any) => \n        i.status === \"not_started\" || i.status === \"pending_inspection\" || i.status === \"in_progress\"\n      ).length;\n      const passed = allInspections.filter((i: any) => i.status === \"completed\").length;\n      const failed = allInspections.filter((i: any) => i.status === \"failed\").length;\n\n      return {\n        total,\n        pending,\n        passed,\n        failed,\n        passRate: total > 0 ? Math.round((passed / total) * 100) : 0,\n      };\n    }),\n});\n\nconst checklistRouter = router({\n  templates: protectedProcedure.query(async () => {\n    // Return all templates grouped by stage\n    const preExecution = await db.getChecklistTemplatesByStage(\"pre_execution\");\n    const inProgress = await db.getChecklistTemplatesByStage(\"in_progress\");\n    const postExecution =\n      await db.getChecklistTemplatesByStage(\"post_execution\");\n\n    return { preExecution, inProgress, postExecution };\n  }),\n\n  createTemplate: protectedProcedure\n    .input(\n      z.object({\n        name: z.string().min(1),\n        category: z.string().optional(),\n        stage: z.enum([\"pre_execution\", \"in_progress\", \"post_execution\"]),\n        description: z.string().optional(),\n        allowGeneralComments: z.boolean().optional(),\n        allowPhotos: z.boolean().optional(),\n        items: z\n          .array(\n            z.object({\n              itemText: z.string(),\n              order: z.number(),\n            })\n          )\n          .optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      try {\n        // Create checklist template\n\n        const templateResult = await db.createChecklistTemplate({\n          name: input.name,\n          category: input.category,\n          stage: input.stage,\n          description: input.description,\n          allowGeneralComments: input.allowGeneralComments,\n          allowPhotos: input.allowPhotos,\n          createdBy: ctx.user!.id,\n        });\n\n        const templateId = templateResult.insertId;\n\n        // Add items if provided\n        if (input.items && input.items.length > 0) {\n          // Add template items\n          for (const item of input.items) {\n            await db.addChecklistTemplateItem({\n              templateId,\n              itemText: item.itemText,\n              order: item.order,\n            });\n          }\n          // Items added\n        }\n\n        return { success: true };\n      } catch (error) {\n        logger.error(\"[createTemplate] Error\", undefined, error);\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message:\n            error instanceof Error\n              ? error.message\n              : \"Failed to create template\",\n        });\n      }\n    }),\n\n  updateTemplate: protectedProcedure\n    .input(\n      z.object({\n        id: z.number(),\n        name: z.string().min(1).optional(),\n        category: z.string().optional(),\n        stage: z\n          .enum([\"pre_execution\", \"in_progress\", \"post_execution\"])\n          .optional(),\n        description: z.string().optional(),\n        allowGeneralComments: z.boolean().optional(),\n        allowPhotos: z.boolean().optional(),\n        items: z\n          .array(\n            z.object({\n              itemText: z.string(),\n              order: z.number(),\n            })\n          )\n          .optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { id, items, ...templateData } = input;\n\n      // Update template basic info\n      if (Object.keys(templateData).length > 0) {\n        await db.updateChecklistTemplate(id, templateData);\n      }\n\n      // Update items if provided\n      if (items) {\n        // Delete existing items\n        await db.deleteChecklistTemplateItems(id);\n        // Add new items\n        for (const item of items) {\n          await db.addChecklistTemplateItem({\n            templateId: id,\n            itemText: item.itemText,\n            order: item.order,\n          });\n        }\n      }\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        action: \"checklist_template_updated\",\n        details: JSON.stringify({ templateId: id }),\n      });\n\n      return { success: true };\n    }),\n\n  deleteTemplate: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      try {\n        // Check if template is in use (has associated task checklists)\n        const checklistsUsingTemplate = await db.getTaskChecklistsByTemplateId(\n          input.id\n        );\n\n        if (checklistsUsingTemplate && checklistsUsingTemplate.length > 0) {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: `Cannot delete template. It is currently used in ${checklistsUsingTemplate.length} task checklist(s). Please remove the template from all tasks first.`,\n          });\n        }\n\n        // Delete the template (this will also delete associated items)\n        await db.deleteChecklistTemplate(input.id);\n\n        await db.logActivity({\n          userId: ctx.user!.id,\n          action: \"checklist_template_deleted\",\n          details: JSON.stringify({ templateId: input.id }),\n        });\n\n        return { success: true };\n      } catch (error) {\n        if (error instanceof TRPCError) throw error;\n        logger.error(\"[deleteTemplate] Error\", undefined, error);\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message:\n            error instanceof Error\n              ? error.message\n              : \"Failed to delete template\",\n        });\n      }\n    }),\n\n  listTemplates: protectedProcedure.query(async () => {\n    return await db.getAllChecklistTemplates();\n  }),\n\n  getTaskChecklists: protectedProcedure\n    .input(z.object({ taskId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getTaskChecklistsByTask(input.taskId);\n    }),\n\n  getByProject: protectedProcedure\n    .input(z.object({ projectId: z.number() }))\n    .query(async ({ input }) => {\n      return await db.getTaskChecklistsByProject(input.projectId);\n    }),\n\n  getTaskChecklistsByTemplateId: protectedProcedure\n    .input(z.object({ templateId: z.number() }))\n    .query(async ({ input }) => {\n      const checklists = await db.getTaskChecklistsByTemplateId(\n        input.templateId\n      );\n      // Get task details for each checklist\n      const result: any[] = [];\n      for (const checklist of checklists) {\n        const task = await db.getTaskById(checklist.taskId);\n        if (task) {\n          result.push({\n            id: checklist.id,\n            taskId: checklist.taskId,\n            taskName: task.name,\n            stage: checklist.stage,\n            status: checklist.status,\n          });\n        }\n      }\n      return result;\n    }),\n\n  assignToTask: protectedProcedure\n    .input(\n      z.object({\n        taskId: z.number(),\n        templateId: z.number(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      // Get template to determine stage\n      const template = await db.getChecklistTemplateById(input.templateId);\n      if (!template) throw new Error(\"Template not found\");\n\n      const result = await db.createTaskChecklist({\n        taskId: input.taskId,\n        templateId: input.templateId,\n        stage: template.stage,\n      });\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        taskId: input.taskId,\n        action: \"checklist_assigned\",\n        details: JSON.stringify({ templateName: template.name }),\n      });\n\n      // Send notification to task assignee about new checklist\n      const task = await db.getTaskById(input.taskId);\n      if (task && task.assigneeId) {\n        await createNotification({\n          userId: task.assigneeId,\n          type: \"checklist_assigned\",\n          title: \" Checklist \",\n          content: ` checklist \"${template.name}\"  \"${task.name}\"`,\n          priority: \"normal\",\n          relatedTaskId: input.taskId,\n          relatedProjectId: task.projectId,\n          sendEmail: false, // Don't send email for checklist assignments (low priority)\n        });\n      }\n\n      return { success: true, id: (result as any).insertId };\n    }),\n\n  removeFromTask: protectedProcedure\n    .input(z.object({ id: z.number() }))\n    .mutation(async ({ input, ctx }) => {\n      const checklist = await db.getTaskChecklistById(input.id);\n      if (!checklist) throw new Error(\"Checklist not found\");\n\n      await db.deleteTaskChecklist(input.id);\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        taskId: checklist.taskId,\n        action: \"checklist_removed\",\n        details: JSON.stringify({ checklistId: input.id }),\n      });\n\n      return { success: true };\n    }),\n\n  updateChecklistStatus: protectedProcedure\n    .input(\n      z.object({\n        id: z.number(),\n        status: z.enum([\n          \"not_started\",\n          \"pending_inspection\",\n          \"in_progress\",\n          \"completed\",\n          \"failed\",\n        ]),\n        generalComments: z.string().optional(),\n        photoUrls: z.string().optional(),\n        signature: z.string().optional(),\n        itemResults: z\n          .array(\n            z.object({\n              templateItemId: z.number(),\n              result: z.enum([\"pass\", \"fail\", \"na\"]),\n            })\n          )\n          .optional(),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const checklist = await db.getTaskChecklistById(input.id);\n      if (!checklist) throw new Error(\"Checklist not found\");\n\n      // Validate inspection submission if itemResults provided\n      if (input.itemResults && input.itemResults.length > 0) {\n        const validation = validateInspectionSubmission({\n          taskChecklistId: input.id,\n          inspectorId: ctx.user!.id,\n          itemResults: input.itemResults.map(item => ({\n            templateItemId: item.templateItemId,\n            result: item.result,\n          })),\n          overallNote: input.generalComments,\n          signatureUrl: input.signature,\n          photoUrls: input.photoUrls ? JSON.parse(input.photoUrls) : undefined,\n        });\n\n        if (!validation.valid) {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: validation.errors?.join(\", \") || \"Invalid inspection data\",\n          });\n        }\n      }\n\n      // Update checklist status, comments, photos, and signature\n      await db.updateTaskChecklist(input.id, {\n        status: input.status,\n        generalComments: input.generalComments,\n        photoUrls: input.photoUrls,\n        signature: input.signature,\n        inspectedBy: ctx.user!.id,\n        inspectedAt: new Date(),\n      });\n\n      // Save individual item results if provided\n      if (input.itemResults && input.itemResults.length > 0) {\n        for (const itemResult of input.itemResults) {\n          await db.saveChecklistItemResult({\n            taskChecklistId: input.id,\n            templateItemId: itemResult.templateItemId,\n            result: itemResult.result,\n          });\n        }\n      }\n\n      await db.logActivity({\n        userId: ctx.user!.id,\n        taskId: checklist.taskId,\n        action: \"checklist_status_updated\",\n        details: JSON.stringify({\n          checklistId: input.id,\n          status: input.status,\n        }),\n      });\n\n      // Auto-update task progress based on checklist completion\n      const { calculateAndUpdateTaskProgress } = await import(\n        \"./taskProgressHelper\"\n      );\n      await calculateAndUpdateTaskProgress(checklist.taskId);\n\n      // Send automatic notification when inspection fails\n      if (input.status === \"failed\") {\n        const task = await db.getTaskById(checklist.taskId);\n        const project = task ? await db.getProjectById(task.projectId) : null;\n        const template = await db.getChecklistTemplateById(checklist.templateId);\n        \n        // Notify task assignee\n        if (task && task.assigneeId) {\n          await createNotification({\n            userId: task.assigneeId,\n            type: \"inspection_failed\",\n            title: \"\",\n            content: ` \"${template?.name || 'Checklist'}\"  \"${task.name}\"  `,\n            priority: \"high\",\n            relatedTaskId: task.id,\n            relatedProjectId: task.projectId,\n            sendEmail: true,\n          });\n        }\n\n        // Notify project manager\n        if (project && project.createdBy) {\n          await createNotification({\n            userId: project.createdBy,\n            type: \"inspection_failed\",\n            title: \"\",\n            content: ` \"${project.name}\" -  \"${task?.name}\" `,\n            priority: \"high\",\n            relatedTaskId: task?.id,\n            relatedProjectId: project.id,\n            sendEmail: true,\n          });\n        }\n\n        // Update notification sent flag\n        await db.updateTaskChecklist(input.id, {\n          notificationSent: true,\n          notifiedAt: new Date(),\n        });\n      }\n\n      return { success: true };\n    }),\n\n  attachToTask: protectedProcedure\n    .input(\n      z.object({\n        taskId: z.number(),\n        templateId: z.number(),\n        stage: z.enum([\"pre_execution\", \"in_progress\", \"post_execution\"]),\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const result = await db.createTaskChecklist(input);\n\n      // Update task status if pre_execution\n      if (input.stage === \"pre_execution\") {\n        await db.updateTask(input.taskId, {\n          status: \"pending_pre_inspection\",\n        });\n\n        // Notify QC team\n        await db.createNotification({\n          userId: ctx.user!.id,\n          type: \"inspection_requested\",\n          title: \"Inspection Requested\",\n          relatedTaskId: input.taskId,\n        });\n      }\n\n      return result;\n    }),\n\n  submitInspection: protectedProcedure\n    .input(\n      z.object({\n        taskChecklistId: z.number(),\n        taskId: z.number(),\n        items: z.array(\n          z.object({\n            templateItemId: z.number(),\n            itemText: z.string(),\n            result: z.enum([\"pass\", \"fail\", \"na\"]),\n            photoUrls: z.string().optional(), // JSON string of photo URLs for this item\n          })\n        ),\n        generalComments: z.string().optional(),\n        photoUrls: z.array(z.s\n\n... ()",
    "server/db.ts": "import { eq, and, or, isNull, isNotNull, sql, desc, asc, count, inArray, notInArray, like, gte, lte, lt, ne } from \"drizzle-orm\";\nimport { bigIntToNumber } from \"./utils/bigint\";\nimport { boolToInt } from \"./utils/typeHelpers.js\";\nimport { drizzle } from \"drizzle-orm/mysql2\";\nimport mysql, { type Pool } from \"mysql2/promise\";\nimport {\n  InsertUser,\n  users,\n  projects,\n  projectMembers,\n  tasks,\n  taskDependencies,\n  checklistTemplates,\n  checklistTemplateItems,\n  taskChecklists,\n  checklistItemResults,\n  defects,\n  defectAttachments,\n  InsertDefectAttachment,\n  defectInspections,\n  InsertDefectInspection,\n  taskComments,\n  taskAttachments,\n  taskFollowers,\n  notifications,\n  activityLog,\n  categoryColors,\n  signatures,\n  queryLogs,\n  dbStatistics,\n  InsertQueryLog,\n  InsertDbStatistic,\n  memoryLogs,\n  oomEvents,\n  pushSubscriptions,\n  InsertPushSubscription,\n  scheduledNotifications,\n  notificationSettings,\n  taskAssignments,\n  alertThresholds,\n  InsertAlertThreshold,\n\n} from \"../drizzle/schema\";\nimport { ENV } from \"./_core/env\";\nimport { createNotification as sendNotification } from \"./notificationService\";\nimport { logger } from \"./logger\";\n\n// Use Pool type from mysql2/promise for proper typing\nlet _db: ReturnType<typeof drizzle> | null = null;\nlet _pool: Pool | null = null;\n\n// Lazily create the drizzle instance with connection pooling\nexport async function getDb() {\n  if (!_db && process.env.DATABASE_URL) {\n    try {\n      // Create connection pool with optimized settings\n      _pool = mysql.createPool({\n        uri: process.env.DATABASE_URL,\n        connectionLimit: 10, // Maximum 10 concurrent connections\n        waitForConnections: true,\n        queueLimit: 0,\n        enableKeepAlive: true,\n        keepAliveInitialDelay: 10000,\n        maxIdle: 5, // Maximum idle connections\n        idleTimeout: 60000, // Close idle connections after 60s\n      });\n      console.log(\"[Database] Connection pool created with limit: 10\");\n      // Create drizzle instance\n      _db = drizzle(_pool);\n    } catch (error: unknown) {\n      console.warn(\"[Database] Failed to connect:\", error);\n      _db = null;\n    }\n  }\n  return _db;\n}\n\n// Close database connections gracefully\nexport async function closeDbConnection(): Promise<void> {\n  if (_pool) {\n    try {\n      await _pool.end();\n      console.log('[Database] Connection pool closed');\n      _pool = null;\n      _db = null;\n    } catch (error: unknown) {\n      console.error('[Database] Error closing connection pool:', error);\n    }\n  }\n}\n\nexport async function upsertUser(user: InsertUser): Promise<void> {\n  if (!user.openId) {\n    throw new Error(\"User openId is required for upsert\");\n  }\n\n  const db = await getDb();\n  if (!db) {\n    console.warn(\"[Database] Cannot upsert user: database not available\");\n    return;\n  }\n\n  try {\n    const values: InsertUser = {\n      openId: user.openId,\n    };\n    const updateSet: Record<string, unknown> = {};\n\n    const textFields = [\"name\", \"email\", \"loginMethod\"] as const;\n    type TextField = (typeof textFields)[number];\n\n    const assignNullable = (field: TextField) => {\n      const value = user[field];\n      if (value === undefined) return;\n      const normalized = value ?? null;\n      values[field] = normalized;\n      updateSet[field] = normalized;\n    };\n\n    textFields.forEach(assignNullable);\n\n    if (user.lastSignedIn !== undefined) {\n      values.lastSignedIn = user.lastSignedIn;\n      updateSet.lastSignedIn = user.lastSignedIn;\n    }\n    if (user.role !== undefined) {\n      values.role = user.role;\n      updateSet.role = user.role;\n    } else if (user.openId === ENV.ownerOpenId) {\n      values.role = \"admin\";\n      updateSet.role = \"admin\";\n    }\n\n    if (!values.lastSignedIn) {\n      values.lastSignedIn = new Date();\n    }\n\n    if (Object.keys(updateSet).length === 0) {\n      updateSet.lastSignedIn = new Date();\n    }\n\n    await db.insert(users).values(values).onDuplicateKeyUpdate({\n      set: updateSet,\n    });\n  } catch (error: unknown) {\n    console.error(\"[Database] Failed to upsert user:\", error);\n    throw error;\n  }\n}\n\nexport async function getUserByOpenId(openId: string) {\n  const db = await getDb();\n  if (!db) {\n    console.warn(\"[Database] Cannot get user: database not available\");\n    return undefined;\n  }\n\n  const result = await db\n    .select()\n    .from(users)\n    .where(eq(users.openId, openId))\n    .limit(1);\n\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getUserById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db.select().from(users).where(eq(users.id, id)).limit(1);\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getAllUsers() {\n  const db = await getDb();\n  if (!db) return [];\n\n  const result = await db.select().from(users);\n  return result;\n}\n\nexport async function updateUserRole(userId: number, role: \"owner\" | \"admin\" | \"project_manager\" | \"qc_inspector\" | \"worker\") {\n  const db = await getDb();\n  if (!db) {\n    throw new Error(\"Database not available\");\n  }\n\n  await db.update(users).set({ role }).where(eq(users.id, userId));\n}\n\nexport async function updateUserProfile(userId: number, data: { name: string; email?: string }) {\n  const db = await getDb();\n  if (!db) {\n    throw new Error(\"Database not available\");\n  }\n\n  const updateData: Partial<typeof users.$inferInsert> = { name: data.name };\n  if (data.email !== undefined) {\n    updateData.email = data.email || null;\n  }\n\n  await db.update(users).set(updateData).where(eq(users.id, userId));\n}\n\nexport async function updateUserNotificationSettings(\n  userId: number,\n  data: {\n    notificationDaysAdvance?: number;\n    enableInAppNotifications?: boolean;\n    enableEmailNotifications?: boolean;\n    enableDailySummaryEmail?: boolean;\n    dailySummaryTime?: string;\n  }\n) {\n  const db = await getDb();\n  if (!db) {\n    throw new Error(\"Database not available\");\n  }\n\n  const updateData: any = {};\n  if (data.notificationDaysAdvance !== undefined) {\n    updateData.notificationDaysAdvance = data.notificationDaysAdvance;\n  }\n  if (data.enableInAppNotifications !== undefined) {\n    updateData.enableInAppNotifications = data.enableInAppNotifications;\n  }\n  if (data.enableEmailNotifications !== undefined) {\n    updateData.enableEmailNotifications = data.enableEmailNotifications;\n  }\n  if (data.enableDailySummaryEmail !== undefined) {\n    updateData.enableDailySummaryEmail = data.enableDailySummaryEmail;\n  }\n  if (data.dailySummaryTime !== undefined) {\n    updateData.dailySummaryTime = data.dailySummaryTime;\n  }\n\n  await db.update(users).set(updateData).where(eq(users.id, userId));\n}\n\n/**\n * Project Management\n */\n\n/**\n * Generate next available project code in format AO-YYYY-XXX\n */\nexport async function generateProjectCode(): Promise<string> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const currentYear = new Date().getFullYear();\n  const prefix = `AO-${currentYear}-`;\n\n  // Get the latest project code for this year\n  const latestProjects = await db\n    .select({ code: projects.code })\n    .from(projects)\n    .where(like(projects.code, `${prefix}%`))\n    .orderBy(desc(projects.code))\n    .limit(1);\n\n  if (latestProjects.length === 0) {\n    // First project of the year\n    return `${prefix}001`;\n  }\n\n  const latestCode = latestProjects[0].code;\n  if (!latestCode) {\n    return `${prefix}001`;\n  }\n\n  // Extract the number part and increment\n  const match = latestCode.match(/AO-(\\d{4})-(\\d{3})/);\n  if (!match) {\n    return `${prefix}001`;\n  }\n\n  const number = parseInt(match[2], 10) + 1;\n  return `${prefix}${number.toString().padStart(3, '0')}`;\n}\n\nexport async function createProject(data: {\n  name: string;\n  code?: string;\n  location?: string;\n  latitude?: string;\n  longitude?: string;\n  ownerName?: string;\n  startDate?: string;\n  endDate?: string;\n  createdBy: number;\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Convert date strings to Date objects\n  const values: typeof projects.$inferInsert = {\n    name: data.name,\n    createdBy: data.createdBy,\n  };\n  \n  // Auto-generate code if not provided\n  if (data.code) {\n    values.code = data.code;\n  } else {\n    values.code = await generateProjectCode();\n  }\n  \n  if (data.location) values.location = data.location;\n  if (data.latitude) values.latitude = data.latitude;\n  if (data.longitude) values.longitude = data.longitude;\n  if (data.ownerName) values.ownerName = data.ownerName;\n  if (data.startDate) values.startDate = data.startDate;\n  if (data.endDate) values.endDate = data.endDate;\n\n  const [result] = await db.insert(projects).values(values);\n  \n  const projectId = bigIntToNumber(result.insertId);\n  \n  if (projectId && !isNaN(projectId)) {\n    await db.insert(projectMembers).values({\n      projectId,\n      userId: data.createdBy,\n      role: 'project_manager',\n    });\n  }\n  \n  return { insertId: projectId, id: projectId };\n}\n\nexport async function getProjectById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db\n    .select()\n    .from(projects)\n    .where(eq(projects.id, id))\n    .limit(1);\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getAllProjects() {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(projects)\n    .where(isNull(projects.archivedAt)); // Filter out archived projects\n}\n\n// Pagination: Get projects with pagination\nexport async function getProjectsPaginated(page: number, pageSize: number) {\n  const db = await getDb();\n  if (!db) return { items: [], total: 0 };\n\n  const offset = (page - 1) * pageSize;\n\n  // Get total count\n  const countResult = await db\n    .select({ count: count() })\n    .from(projects)\n    .where(isNull(projects.archivedAt));\n  const total = countResult[0]?.count || 0;\n\n  // Get paginated items\n  const items = await db\n    .select()\n    .from(projects)\n    .where(isNull(projects.archivedAt))\n    .orderBy(desc(projects.createdAt))\n    .limit(pageSize)\n    .offset(offset);\n\n  return { items, total };\n}\n\nexport async function getProjectsByUser(userId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(projects)\n    .innerJoin(projectMembers, eq(projects.id, projectMembers.projectId))\n    .where(\n      and(\n        eq(projectMembers.userId, userId),\n        isNull(projects.archivedAt) // Filter out archived projects\n      )\n    );\n}\n\n/**\n * Validate project completeness for opening (minimum 70%)\n * Returns completeness percentage and details\n */\nexport async function validateProjectCompleteness(projectId: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const project = await getProjectById(projectId);\n  if (!project) throw new Error(\"Project not found\");\n\n  const checks = {\n    basicInfo: 0,\n    timeline: 0,\n    team: 0,\n    tasks: 0,\n    checklists: 0,\n  };\n\n  const details: Array<{ category: string; status: 'complete' | 'incomplete'; message: string }> = [];\n\n  // 1. Basic Info (20%): name, code, location\n  if (project.name && project.code && project.location) {\n    checks.basicInfo = 20;\n    details.push({ category: '', status: 'complete', message: ', , ' });\n  } else {\n    details.push({ category: '', status: 'incomplete', message: ', , ' });\n  }\n\n  // 2. Timeline (20%): startDate, endDate\n  if (project.startDate && project.endDate) {\n    checks.timeline = 20;\n    details.push({ category: '', status: 'complete', message: '' });\n  } else {\n    details.push({ category: '', status: 'incomplete', message: '' });\n  }\n\n  // 3. Team (15%): at least 1 member\n  const members = await db\n    .select()\n    .from(projectMembers)\n    .where(eq(projectMembers.projectId, projectId));\n  \n  if (members.length > 0) {\n    checks.team = 15;\n    details.push({ category: '', status: 'complete', message: ` ${members.length} ` });\n  } else {\n    details.push({ category: '', status: 'incomplete', message: ' 1 ' });\n  }\n\n  // 4. Tasks (15%): at least 1 task\n  const projectTasks = await db\n    .select()\n    .from(tasks)\n    .where(eq(tasks.projectId, projectId));\n  \n  if (projectTasks.length > 0) {\n    checks.tasks = 15;\n    details.push({ category: '', status: 'complete', message: ` ${projectTasks.length} ` });\n  } else {\n    details.push({ category: '', status: 'incomplete', message: ' 1 ' });\n  }\n\n  // 5. Checklist Templates (10%): at least 1 template (optional but recommended)\n  const templates = await db\n    .select()\n    .from(checklistTemplates);\n  \n  if (templates.length > 0) {\n    checks.checklists = 10;\n    details.push({ category: 'Checklist Templates', status: 'complete', message: ` ${templates.length} templates` });\n  } else {\n    details.push({ category: 'Checklist Templates', status: 'incomplete', message: ' checklist template  1 ' });\n  }\n\n  const totalPercentage = Object.values(checks).reduce((sum: any, val) => sum + val, 0);\n\n  return {\n    percentage: totalPercentage,\n    isValid: totalPercentage >= 70,\n    checks,\n    details,\n  };\n}\n\n/**\n * Open project - change status from draft to planning or active\n */\nexport async function openProject(projectId: number, newStatus: 'planning' | 'active') {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Validate completeness first\n  const validation = await validateProjectCompleteness(projectId);\n  if (!validation.isValid) {\n    throw new Error(` ${validation.percentage}% ( 70%)`);\n  }\n\n  // Update project status\n  await db\n    .update(projects)\n    .set({ status: newStatus })\n    .where(eq(projects.id, projectId));\n\n  return { success: true, newStatus };\n}\n\nexport async function getProjectStats(projectId: number) {\n  const db = await getDb();\n  if (!db) return null;\n\n  // Get project info for endDate\n  const project = await db\n    .select()\n    .from(projects)\n    .where(eq(projects.id, projectId))\n    .limit(1);\n  \n  const projectData = project[0];\n\n  // Get all tasks for this project\n  const projectTasks = await db\n    .select()\n    .from(tasks)\n    .where(eq(tasks.projectId, projectId));\n\n  const totalTasks = projectTasks.length;\n  if (totalTasks === 0) {\n    return {\n      totalTasks: 0,\n      completedTasks: 0,\n      inProgressTasks: 0,\n      notStartedTasks: 0,\n      overdueTasks: 0,\n      progressPercentage: 0,\n      projectStatus: 'on_track' as const,\n    };\n  }\n\n  const now = new Date();\n  const completedTasks = projectTasks.filter((t: any) => t.status === 'completed').length;\n  const inProgressTasks = projectTasks.filter((t: any) => t.status === 'in_progress').length;\n  const notStartedTasks = projectTasks.filter((t: any) => t.status === 'not_started').length;\n  const overdueTasks = projectTasks.filter((t: any) => \n    t.endDate && new Date(t.endDate) < now && t.status !== 'completed'\n  ).length;\n\n  // Calculate overall progress (average of all task progress)\n  const totalProgress = projectTasks.reduce((sum: any, t: any) => sum + (t.progress || 0), 0);\n  const progress = Math.round(totalProgress / totalTasks);\n\n  // Determine project status based on new logic:\n  // 1. overdue = project endDate passed and not completed\n  // 2. delayed = has at least one delayed task (overdue task)\n  // 3. on_track = no delayed tasks\n  let status: 'on_track' | 'delayed' | 'overdue' | 'completed';\n  \n  if (completedTasks === totalTasks || projectData?.status === 'completed') {\n    status = 'completed';\n  } else if (projectData?.endDate && new Date(projectData.endDate) < now) {\n    // Project passed its end date and not completed = overdue\n    status = 'overdue';\n  } else if (overdueTasks > 0) {\n    // Has at least one delayed task = delayed\n    status = 'delayed';\n  } else {\n    // No delayed tasks = on track\n    status = 'on_track';\n  }\n\n  return {\n    totalTasks,\n    completedTasks,\n    inProgressTasks,\n    notStartedTasks,\n    overdueTasks,\n    progressPercentage: progress,\n    projectStatus: status,\n  };\n}\n\n/**\n * Batch get project stats for multiple projects - Optimized version to prevent N+1 queries\n * @param projectIds Array of project IDs to get stats for\n * @returns Map of projectId to stats\n */\nexport async function getBatchProjectStats(projectIds: number[]) {\n  const db = await getDb();\n  if (!db || projectIds.length === 0) return new Map();\n\n  // Get all projects in one query\n  const projectsData = await db\n    .select()\n    .from(projects)\n    .where(inArray(projects.id, projectIds));\n\n  // Get all tasks for these projects in one query\n  const allTasks = await db\n    .select()\n    .from(tasks)\n    .where(inArray(tasks.projectId, projectIds));\n\n  // Group tasks by project ID\n  const tasksByProject = new Map<number, any[]>();\n  for (const task of allTasks) {\n    const projectTasks = tasksByProject.get(task.projectId) || [];\n    projectTasks.push(task);\n    tasksByProject.set(task.projectId, projectTasks);\n  }\n\n  // Calculate stats for each project\n  const statsMap = new Map();\n  const now = new Date();\n\n  for (const projectData of projectsData) {\n    const projectTasks = tasksByProject.get(projectData.id) || [];\n    const totalTasks = projectTasks.length;\n\n    if (totalTasks === 0) {\n      statsMap.set(projectData.id, {\n        totalTasks: 0,\n        completedTasks: 0,\n        inProgressTasks: 0,\n        notStartedTasks: 0,\n        overdueTasks: 0,\n        progressPercentage: 0,\n        projectStatus: 'on_track' as const,\n      });\n      continue;\n    }\n\n    const completedTasks = projectTasks.filter((t: any) => t.status === 'completed').length;\n    const inProgressTasks = projectTasks.filter((t: any) => t.status === 'in_progress').length;\n    const notStartedTasks = projectTasks.filter((t: any) => t.status === 'not_started').length;\n    const overdueTasks = projectTasks.filter((t: any) => \n      t.endDate && new Date(t.endDate) < now && t.status !== 'completed'\n    ).length;\n\n    const totalProgress = projectTasks.reduce((sum: any, t: any) => sum + (t.progress || 0), 0);\n    const progress = Math.round(totalProgress / totalTasks);\n\n    let status: 'on_track' | 'delayed' | 'overdue' | 'completed';\n    \n    if (completedTasks === totalTasks || projectData?.status === 'completed') {\n      status = 'completed';\n    } else if (projectData?.endDate && new Date(projectData.endDate) < now) {\n      status = 'overdue';\n    } else if (overdueTasks > 0) {\n      status = 'delayed';\n    } else {\n      status = 'on_track';\n    }\n\n    statsMap.set(projectData.id, {\n      totalTasks,\n      completedTasks,\n      inProgressTasks,\n      notStartedTasks,\n      overdueTasks,\n      progressPercentage: progress,\n      projectStatus: status,\n    });\n  }\n\n  return statsMap;\n}\n\nexport async function updateProject(\n  id: number,\n  data: Partial<{\n    name: string;\n    code: string;\n    location: string;\n    latitude: string;\n    longitude: string;\n    startDate: string;\n    endDate: string;\n    ownerName: string;\n    status: \"draft\" | \"planning\" | \"active\" | \"on_hold\" | \"completed\" | \"cancelled\";\n    completionPercentage: number;\n    progress: number;\n  }>\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const updateData: Record<string, any> = {};\n  if (data.name !== undefined) updateData.name = data.name;\n  if (data.code !== undefined) updateData.code = data.code || null;\n  if (data.location !== undefined) updateData.location = data.location || null;\n  if (data.latitude !== undefined) updateData.latitude = data.latitude || null;\n  if (data.longitude !== undefined) updateData.longitude = data.longitude || null;\n  if (data.ownerName !== undefined) updateData.ownerName = data.ownerName || null;\n  if (data.completionPercentage !== undefined) updateData.completionPercentage = data.completionPercentage;\n  if (data.startDate !== undefined) updateData.startDate = data.startDate ? new Date(data.startDate) : null;\n  if (data.endDate !== undefined) updateData.endDate = data.endDate ? new Date(data.endDate) : null;\n  if (data.status !== undefined) updateData.status = data.status;\n  if (data.progress !== undefined) updateData.progress = data.progress;\n\n  return await db.update(projects).set(updateData).where(eq(projects.id, id));\n}\n\nexport async function deleteProject(id: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Delete in order to respect foreign key constraints\n  // 1. Delete activity logs\n  await db.delete(activityLog).where(eq(activityLog.projectId, id));\n  \n  // 2. Delete task-related data\n  const projectTasks = await db.select({ id: tasks.id }).from(tasks).where(eq(tasks.projectId, id));\n  const taskIds = projectTasks.map((t: any) => t.id);\n  \n  if (taskIds.length > 0) {\n    // Delete task dependencies\n    await db.delete(taskDependencies).where(inArray(taskDependencies.taskId, taskIds));\n    await db.delete(taskDependencies).where(inArray(taskDependencies.dependsOnTaskId, taskIds));\n    \n    // Delete task followers\n    await db.delete(taskFollowers).where(inArray(taskFollowers.taskId, taskIds));\n    \n    // Delete task attachments\n    await db.delete(taskAttachments).where(inArray(taskAttachments.taskId, taskIds));\n    \n    // Delete task comments\n    await db.delete(taskComments).where(inArray(taskComments.taskId, taskIds));\n    \n    // Delete checklist item results\n    await db.delete(checklistItemResults).where(inArray(checklistItemResults.taskChecklistId, \n      (await db.select({ id: taskChecklists.id }).from(taskChecklists).where(inArray(taskChecklists.taskId, taskIds))).map((tc: any) => tc.id)\n    ));\n    \n    // Delete task checklists\n    await db.delete(taskChecklists).where(inArray(taskChecklists.taskId, taskIds));\n    \n    // Delete defects\n    await db.delete(defects).where(inArray(defects.taskId, taskIds));\n    \n    // Delete tasks\n    await db.delete(tasks).where(eq(tasks.projectId, id));\n  }\n  \n  // 3. Delete notifications\n  await db.delete(notifications).where(eq(notifications.relatedProjectId, id));\n  \n  // 4. Delete project members\n  await db.delete(projectMembers).where(eq(projectMembers.projectId, id));\n  \n  // 5. Finally delete the project\n  await db.delete(projects).where(eq(projects.id, id));\n}\n\nexport async function archiveProject(projectId: number, userId: number, reason?: string) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(projects).set({\n    archivedAt: new Date(),\n    archivedBy: userId,\n    archivedReason: reason,\n  }).where(eq(projects.id, projectId));\n\n  // Log archive history\n  await logArchiveHistory({\n    projectId,\n    action: \"archived\",\n    performedBy: userId,\n    reason,\n  });\n}\n\nexport async function unarchiveProject(projectId: number, userId: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(projects).set({\n    archivedAt: null,\n    archivedBy: null,\n    archivedReason: null,\n  }).where(eq(projects.id, projectId));\n\n  // Log archive history\n  await logArchiveHistory({\n    projectId,\n    action: \"unarchived\",\n    performedBy: userId,\n  });\n}\n\nexport async function getArchivedProjects(userId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  // Get user to check role\n  const user = await getUserById(userId);\n  if (!user) return [];\n\n  // Admin and owner can see all archived projects\n  if (user.role === 'admin' || user.role === 'owner') {\n    const result = await db\n      .select()\n      .from(projects)\n      .where(isNotNull(projects.archivedAt))\n      .orderBy(desc(projects.archivedAt));\n    return result;\n  }\n\n  // Other users only see projects they're members of\n  const result = await db\n    .select()\n    .from(projects)\n    .innerJoin(projectMembers, eq(projects.id, projectMembers.projectId))\n    .where(\n      and(\n        eq(projectMembers.userId, userId),\n        isNotNull(projects.archivedAt)\n      )\n    )\n    .orderBy(desc(projects.archivedAt));\n\n  return result.map((r: any) => r.projects);\n}\n\nexport async function addProjectMember(data: {\n  projectId: number;\n  userId: number;\n  role: \"project_manager\" | \"qc_inspector\" | \"worker\";\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.insert(projectMembers).values({\n    projectId: data.projectId,\n    userId: data.userId,\n    role: data.role,\n  });\n}\n\n/**\n * Task Management\n */\nexport async function createTask(data: {\n  projectId: number;\n  parentTaskId?: number;\n  name: string;\n  description?: string;\n  category?: string;\n  status?: string;\n  priority?: string;\n  startDate?: string | Date;\n  endDate?: string | Date;\n  assigneeId?: number;\n  createdBy: number;\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const { createdBy, startDate, endDate, ...taskData } = data;\n  \n  // Convert Date to string if needed\n  const startDateStr = startDate instanceof Date ? startDate.toISOString().split('T')[0] : startDate;\n  const endDateStr = endDate instanceof Date ? endDate.toISOString().split('T')[0] : endDate;\n  \n  const [result] = await db.insert(tasks).values({\n    ...taskData,\n    status: (taskData.status as any) || \"todo\",\n    priority: (taskData.priority as any) || \"medium\",\n    progress: 0,\n    // Keep dates as strings (YYYY-MM-DD format) - database schema uses varchar(10)\n    startDate: startDateStr || null,\n    endDate: endDateStr || null,\n  });\n  \n  const taskId = bigIntToNumber(result.insertId);\n  return { insertId: taskId, id: taskId };\n}\n\nexport async function getTaskById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db.select().from(tasks).where(eq(tasks.id, id)).limit(1);\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getTasksByProject(projectId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(tasks)\n    .where(eq(tasks.projectId, projectId))\n    .orderBy(asc(tasks.order));\n}\n\n/**\n * Get tasks by multiple project IDs (optimized to avoid N+1 queries)\n * @param projectIds Array of project IDs\n * @returns Array of tasks\n */\nexport async function getTasksByProjectIds(projectIds: number[]) {\n  const db = await getDb();\n  if (!db) return [];\n\n  if (projectIds.length === 0) return [];\n\n  return await db\n    .select()\n    .from(tasks)\n    .where(inArray(tasks.projectId, projectIds))\n    .orderBy(asc(tasks.order));\n}\n\nexport async function getTasksByAssignee(userId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(tasks)\n    .where(eq(tasks.assigneeId, userId))\n    .orderBy(desc(tasks.updatedAt));\n}\n\nexport async function getAllTasks() {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(tasks)\n    .orderBy(desc(tasks.updatedAt));\n}\n\n// Pagination: Get tasks with pagination\nexport async function getTasksPaginated(page: number, pageSize: number, filters?: {\n  projectId?: number;\n  assigneeId?: number;\n  status?: string;\n  priority?: string;\n}) {\n  const db = await getDb();\n  if (!db) return { items: [], total: 0 };\n\n  const offset = (page - 1) * pageSize;\n\n  // Build where conditions\n  const conditions = [];\n  if (filters?.projectId) {\n    conditions.push(eq(tasks.projectId, filters.projectId));\n  }\n  if (filters?.assigneeId) {\n    conditions.push(eq(tasks.assigneeId, filters.assigneeId));\n  }\n  if (filters?.status) {\n    conditions.push(eq(tasks.status, filters.status as any));\n  }\n  if (filters?.priority) {\n    conditions.push(eq(tasks.priority, filters.priority as any));\n  }\n\n  const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n  // Get total count\n  const countResult = await db\n    .select({ count: count() })\n    .from(tasks)\n    .where(whereClause);\n  const total = countResult[0]?.count || 0;\n\n  // Get paginated items\n  const items = await db\n    .select()\n    .from(tasks)\n    .where(whereClause)\n    .orderBy(desc(tasks.updatedAt))\n    .limit(pageSize)\n    .offset(offset);\n\n  return { items, total };\n}\n\nexport async function updateTask(\n  id: number,\n  data: Partial<{\n    name: string;\n    description: string;\n    status: \"todo\" | \"pending_pre_inspection\" | \"ready_to_start\" | \"in_progress\" | \"pending_final_inspection\" | \"rectification_needed\" | \"completed\";\n    progress: number;\n    assigneeId: number;\n    startDate: Date;\n    endDate: Date;\n  }>\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const updateData: Record<string, any> = {};\n  if (data.name !== undefined && data.name !== null) updateData.name = data.name;\n  // Only update description if it's not undefined and not null (allow empty string)\n  if (data.description !== undefined && data.description !== null) {\n    updateData.description = data.description;\n  }\n  if (data.status !== undefined) updateData.status = data.status;\n  if (data.progress !== undefined) updateData.progress = data.progress;\n  if (data.assigneeId !== undefined) updateData.assigneeId = data.assigneeId;\n  \n  // Convert Date to YYYY-MM-DD string format for varchar columns\n  if (data.startDate !== undefined) {\n    updateData.startDate = data.startDate instanceof Date \n      ? data.startDate.toISOString().split('T')[0] \n      : data.startDate;\n  }\n  if (data.endDate !== undefined) {\n    updateData.endDate = data.endDate instanceof Date \n      ? data.endDate.toISOString().split('T')[0] \n      : data.endDate;\n  }\n\n  return await db.update(tasks).set(updateData).where(eq(tasks.id, id));\n}\n\nexport async function addTaskDependency(data: {\n  taskId: number;\n  dependsOnTaskId: number;\n  type?: \"finish_to_start\" | \"start_to_start\" | \"finish_to_finish\";\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Check if dependency already exists\n  const existing = await db\n    .select()\n    .from(taskDependencies)\n    .where(\n      and(\n        eq(taskDependencies.taskId, data.taskId),\n        eq(taskDependencies.dependsOnTaskId, data.dependsOnTaskId)\n      )\n    );\n\n  if (existing.length > 0) {\n    throw new Error(\"Dependency already exists\");\n  }\n\n  return await db.insert(taskDependencies).values({\n    taskId: data.taskId,\n    dependsOnTaskId: data.dependsOnTaskId,\n    type: data.type || \"finish_to_start\",\n  });\n}\n\n/**\n * Checklist Template Management\n */\nexport async function createChecklistTemplate(data: {\n  name: string;\n  category?: string;\n  stage: \"pre_execution\" | \"in_progress\" | \"post_execution\";\n  description?: string;\n  allowGeneralComments?: boolean;\n  allowPhotos?: boolean;\n  createdBy: number;\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const [result] = await db.insert(checklistTemplates).values({\n    name: data.name,\n    category: data.category,\n    stage: data.stage,\n    description: data.description,\n    allowGeneralComments: data.allowGeneralComments,\n    allowPhotos: data.allowPhotos,\n    createdBy: data.createdBy,\n  });\n\n  // Handle BigInt conversion properly - convert to string first, then parse\n  const insertId = parseInt(String(result.insertId));\n  \n  if (isNaN(insertId) || insertId === 0) {\n    throw new Error(`Invalid insertId: ${result.insertId}`);\n  }\n  \n  return { insertId };\n}\n\nexport async function updateChecklistTemplate(\n  id: number,\n  data: {\n    name?: string;\n    category?: string;\n    stage?: \"pre_execution\" | \"in_progress\" | \"post_execution\";\n    description?: string;\n    allowGeneralComments?: boolean;\n    allowPhotos?: boolean;\n  }\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const updateData: any = { ...data };\n  if (data.allowGeneralComments !== undefined) {\n    updateData.allowGeneralComments = data.allowGeneralComments ? 1 : 0;\n  }\n  if (data.allowPhotos !== undefined) {\n    updateData.allowPhotos = data.allowPhotos ? 1 : 0;\n  }\n\n  return await db.update(checklistTemplates).set(updateData).where(eq(checklistTemplates.id, id));\n}\n\nexport async function deleteChecklistTemplateItems(templateId: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.delete(checklistTemplateItems).where(eq(checklistTemplateItems.templateId, templateId));\n}\n\nexport async function deleteChecklistTemplate(id: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // First delete all items associated with this template\n  await deleteChecklistTemplateItems(id);\n  \n  // Then delete the template itself\n  return await db.delete(checklistTemplates).where(eq(checklistTemplates.id, id));\n}\n\nexport async function getChecklistTemplateById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db\n    .select()\n    .from(checklistTemplates)\n    .where(eq(checklistTemplates.id, id))\n    .limit(1);\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getAllChecklistTemplates() {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db.select().from(checklistTemplates).orderBy(checklistTemplates.name);\n}\n\nexport async function getChecklistTemplatesByStage(stage: \"pre_execution\" | \"in_progress\" | \"post_execution\") {\n  const db = await getDb();\n  if (!db) return [];\n\n  const templates = await db\n    .select()\n    .from(checklistTemplates)\n    .where(eq(checklistTemplates.stage, stage));\n\n  // Fetch items for each template\n  const templatesWithItems = await Promise.all(\n    templates.map(async (template: any) => {\n      const items = await db\n        .select()\n        .from(checklistTemplateItems)\n        .where(eq(checklistTemplateItems.templateId, template.id))\n        .orderBy(checklistTemplateItems.order);\n      return { ...template, items };\n    })\n  );\n\n  return templatesWithItems;\n}\n\nexport async function addChecklistTemplateItem(data: {\n  templateId: number;\n  itemText: string;\n  order: number;\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.insert(checklistTemplateItems).values({\n    templateId: data.templateId,\n    itemText: data.itemText,\n    order: data.order,\n  });\n}\n\nexport async function getChecklistTemplateItems(templateId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(checklistTemplateItems)\n    .where(eq(checklistTemplateItems.templateId, templateId))\n    .orderBy(asc(checklistTemplateItems.order));\n}\n\n/**\n * Batch get checklist template items for multiple templates - Optimized version\n * @param templateIds Array of template IDs\n * @returns Map of templateId to items array\n */\nexport async function getBatchChecklistTemplateItems(templateIds: number[]) {\n  const db = await getDb();\n  if (!db || templateIds.length === 0) return new Map();\n\n  // Get all items for these templates in one query\n  const allItems = await db\n    .select()\n    .from(checklistTemplateItems)\n    .where(inArray(checklistTemplateItems.templateId, templateIds))\n    .orderBy(asc(checklistTemplateItems.order));\n\n  // Group items by template ID\n  const itemsByTemplate = new Map<number, any[]>();\n  for (const item of allItems) {\n    const items = itemsByTemplate.get(item.templateId) || [];\n    items.push(item);\n    itemsByTemplate.set(item.templateId, items);\n  }\n\n  return itemsByTemplate;\n}\n\n/**\n * Task Checklist Management\n */\nexport async function createTaskChecklist(data: {\n  taskId: number;\n  templateId: number;\n  stage: \"pre_execution\" | \"in_progress\" | \"post_execution\";\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Create the task checklist\n  const [result] = await db.insert(taskChecklists).values({\n    taskId: data.taskId,\n    templateId: data.templateId,\n    stage: data.stage,\n    status: \"not_started\",\n  }).$returningId();\n\n  const checklistId = result.id;\n\n  // Get all template items\n  const templateItems = await db\n    .select()\n    .from(checklistTemplateItems)\n    .where(eq(checklistTemplateItems.templateId, data.templateId))\n    .orderBy(checklistTemplateItems.order);\n\n  // Create checklist item results for each template item\n  if (templateItems.length > 0) {\n    const itemResults = templateItems.map((item) => ({\n      taskChecklistId: checklistId,\n      templateItemId: item.id,\n      result: \"na\" as const, // Default to N/A, inspector will update\n      photoUrls: null,\n    }));\n\n    await db.insert(checklistItemResults).values(itemResults);\n  }\n\n  return { insertId: checklistId };\n}\n\nexport async function getTaskChecklistsByTask(taskId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  const checklists = await db\n    .select({\n      id: taskChecklists.id,\n      taskId: taskChecklists.taskId,\n      templateId: taskChecklists.templateId,\n      stage: taskChecklists.stage,\n      status: taskChecklists.status,\n      templateName: checklistTemplates.name,\n      allowGeneralComments: checklistTemplates.allowGeneralComments,\n      allowPhotos: checklistTemplates.allowPhotos,\n      taskName: tasks.name,\n      projectName: projects.name,\n    })\n    .from(taskChecklists)\n    .leftJoin(checklistTemplates, eq(taskChecklists.templateId, checklistTemplates.id))\n    .leftJoin(tasks, eq(taskChecklists.taskId, tasks.id))\n    .leftJoin(projects, eq(tasks.projectId, projects.id))\n    .where(eq(taskChecklists.taskId, taskId));\n\n  // Get items for each checklist\n  const result: any[] = [];\n  for (const checklist of checklists) {\n    const items = await db\n      .select()\n      .from(checklistTemplateItems)\n      .where(eq(checklistTemplateItems.templateId, checklist.templateId));\n    result.push({ ...checklist, items });\n  }\n\n  return result;\n}\n\nexport async function getTaskChecklistsByTemplateId(templateId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(taskChecklists)\n    .where(eq(taskChecklists.templateId, templateId));\n}\n\nexport async function getTaskChecklistsByProject(projectId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  const checklists = await db\n    .select({\n      id: taskChecklists.id,\n      taskId: taskChecklists.taskId,\n      templateId: taskChecklists.templateId,\n      stage: taskChecklists.stage,\n      status: taskChecklists.status,\n      inspectedBy: taskChecklists.inspectedBy,\n      inspectedAt: taskChecklists.inspectedAt,\n      generalComments: taskChecklists.generalComments,\n      photoUrls: taskChecklists.photoUrls,\n      signature: taskChecklists.signature,\n      createdAt: taskChecklists.createdAt,\n      updatedAt: taskChecklists.updatedAt,\n      projectId: tasks.projectId,\n      taskName: tasks.name,\n      templateName: checklistTemplates.name,\n      allowGeneralComments: checklistTemplates.allowGeneralComments,\n      allowPhotos: checklistTemplates.allowPhotos,\n    })\n    .from(taskChecklists)\n    .leftJoin(tasks, eq(taskChecklists.taskId, tasks.id))\n    .leftJoin(checklistTemplates, eq(taskChecklists.templateId, checklistTemplates.id))\n    .where(eq(tasks.projectId, projectId));\n\n  // Get items for each checklist\n  const result: any[] = [];\n  for (const checklist of checklists) {\n    const items = await db\n      .select()\n      .from(checklistTemplateItems)\n      .where(eq(checklistTemplateItems.templateId, checklist.templateId));\n    result.push({ ...checklist, items });\n  }\n\n  return result;\n}\n\nexport async function getTaskChecklistById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db\n    .select()\n    .from(taskChecklists)\n    .where(eq(taskChecklists.id, id))\n    .limit(1);\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getAllTaskChecklists() {\n  const db = await getDb();\n  if (!db) return [];\n\n  const result = await db\n    .select({\n      id: taskChecklists.id,\n      taskId: taskChecklists.taskId,\n      templateId: taskChecklists.templateId,\n      stage: taskChecklists.stage,\n      status: taskChecklists.status,\n      inspectedBy: taskChecklists.inspectedBy,\n      inspectedAt: taskChecklists.inspectedAt,\n      generalComments: taskChecklists.generalComments,\n      photoUrls: taskChecklists.photoUrls,\n      signature: taskChecklists.signature,\n      createdAt: taskChecklists.createdAt,\n      updatedAt: taskChecklists.updatedAt,\n      taskName: tasks.name,\n      templateName: checklistTemplates.name,\n      projectId: tasks.projectId,\n      projectName: projects.name,\n      inspectorName: users.name,\n    })\n    .from(taskChecklists)\n    .leftJoin(tasks, eq(taskChecklists.taskId, tasks.id))\n    .leftJoin(projects, eq(tasks.projectId, projects.id))\n    .leftJoin(checklistTemplates, eq(taskChecklists.templateId, checklistTemplates.id))\n    .leftJoin(users, eq(taskChecklists.inspectedBy, users.id))\n    .orderBy(desc(taskChecklists.createdAt));\n\n  return result;\n}\n\nexport async function updateTaskChecklist(\n  id: number,\n  data: Partial<{\n    status: \"not_started\" | \"pending_inspection\" | \"in_progress\" | \"completed\" | \"failed\";\n    inspectedBy: number;\n    inspectedAt: Date;\n    generalComments: string;\n    photoUrls: string;\n    signature: string;\n    notificationSent: boolean;\n    notifiedAt: Date;\n  }>\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const updateData: any = {};\n  if (data.status !== undefined) updateData.status = data.status;\n  if (data.inspectedBy !== undefined) updateData.inspectedBy = data.inspectedBy;\n  if (data.inspectedAt !== undefined) updateData.inspectedAt = data.inspectedAt;\n  if (data.generalComments !== undefined) updateData.generalComments = data.generalComments;\n  if (data.photoUrls !== undefined) updateData.photoUrls = data.photoUrls;\n  if (data.signature !== undefined) updateData.signature = data.signature;\n  if (data.notificationSent !== undefined) updateData.notificationSent = data.notificationSent;\n  if (data.notifiedAt !== undefined) updateData.notifiedAt = data.notifiedAt;\n\n  return await db.update(taskChecklists).set(updateData).where(eq(taskChecklists.id, id));\n}\n\nexport async function updateTaskChecklistStatus(\n  id: number,\n  status: \"not_started\" | \"pending_inspection\" | \"in_progress\" | \"completed\" | \"failed\"\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.update(taskChecklists).set({ status }).where(eq(taskChecklists.id, id));\n}\n\nexport async function deleteTaskChecklist(id: number) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // First delete related checklist item results\n  await db.delete(checklistItemResults).where(eq(checklistItemResults.taskChecklistId, id));\n  \n  // Then delete the task checklist\n  return await db.delete(taskChecklists).where(eq(taskChecklists.id, id));\n}\n\nexport async function addChecklistItemResult(data: {\n  taskChecklistId: number;\n  templateItemId: number;\n  result: \"pass\" | \"fail\" | \"na\";\n  \n  photoUrls?: string;\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.insert(checklistItemResults).values({\n    taskChecklistId: data.taskChecklistId,\n    templateItemId: data.templateItemId,\n    result: data.result,\n    photoUrls: data.photoUrls,\n  });\n}\n\nexport async function getChecklistItemResults(taskChecklistId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(checklistItemResults)\n    .where(eq(checklistItemResults.taskChecklistId, taskChecklistId));\n}\n\n// Alias for consistency\nexport const saveChecklistItemResult = addChecklistItemResult;\n\nexport async function updateChecklistItemResult(\n  id: number,\n  data: {\n    result?: \"pass\" | \"fail\" | \"na\";\n    photoUrls?: string;\n    comments?: string;\n  }\n) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db\n    .update(checklistItemResults)\n    .set({\n      result: data.result,\n      photoUrls: data.photoUrls,\n      comments: data.comments,\n      updatedAt: new Date(),\n    })\n    .where(eq(checklistItemResults.id, id));\n}\n\nexport async function getChecklistItemResultById(id: number) {\n  const db = await getDb();\n  if (!db) return null;\n\n  const results = await db\n    .select()\n    .from(checklistItemResults)\n    .where(eq(checklistItemResults.id, id))\n    .limit(1);\n\n  return results.length > 0 ? results[0] : null;\n}\n\n/**\n * Defect Management\n */\nexport async function createDefect(data: {\n  taskId: number;\n  checklistItemResultId?: number;\n  title: string;\n  description?: string;\n  photoUrls?: string;\n  severity: \"low\" | \"medium\" | \"high\" | \"critical\";\n  reportedBy: number;\n  assignedTo?: number;\n  // CAR/PAR/NCR specific fields\n  type?: \"CAR\" | \"PAR\" | \"NCR\";\n  checklistId?: number;\n  rootCause?: string;\n  correctiveAction?: string;\n  preventiveAction?: string;\n  dueDate?: Date;\n  ncrLevel?: \"major\" | \"minor\";\n}) {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return await db.insert(defects).values({\n    taskId: data.taskId,\n    checklistItemResultId: data.checklistItemResultId,\n    title: data.title,\n    description: data.description,\n    photoUrls: data.photoUrls,\n    severity: data.severity,\n    reportedBy: data.reportedBy,\n    assignedTo: data.assignedTo,\n    status: \"reported\",\n    // CAR/PAR/NCR fields\n    type: data.type || \"CAR\",\n    checklistId: data.checklistId,\n    rootCause: data.rootCause,\n    correctiveAction: data.correctiveAction,\n    preventiveAction: data.preventiveAction,\n    dueDate: data.dueDate,\n    ncrLevel: data.ncrLevel,\n  });\n}\n\nexport async function getDefectById(id: number) {\n  const db = await getDb();\n  if (!db) return undefined;\n\n  const result = await db\n    .select()\n    .from(defects)\n    .where(eq(defects.id, id))\n    .limit(1);\n\n  return result.length > 0 ? result[0] : undefined;\n}\n\nexport async function getDefectsByTask(taskId: number) {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(defects)\n    .where(eq(defects.taskId, taskId))\n    .orderBy(desc(defects.createdAt));\n}\n\nexport async function getOpenDefects() {\n  const db = await getDb();\n  if (!db) return [];\n\n  return await db\n    .select()\n    .from(defects)\n    .where(eq(defects.status, \"reported\"))\n    .orderBy(desc(defects.severity));\n}\n\nexport async function getAllDefects() {\n  const db = await getDb();\n  if (!db) return [];\n\n  const results = await db\n    .select({\n      id: defects.id,\n      taskId: defects.taskId,\n      projectId: tasks.projectId,\n      checklistItemResultId: defects.checklistItemResultId,\n      title: defects.title,\n      description: defects.description,\n      photoUrls: defects.photoUrls,\n      status: defects.status,\n      severity: defects.severity,\n      assignedTo: defects.assignedTo,\n      reportedBy: defects.reportedBy,\n      resolvedBy: defects.resolvedBy,\n      resolvedAt: defects.resolvedAt,\n      resolutionPhotoUrls: defects.resolutionPhotoUrls,\n      resolutionComment: defects.resolutionComment,\n      type: defects.type,\n      checklistId: defects.checklistId,\n      rootCause: defects.rootCause,\n      correctiveAction: defects.correctiveAction,\n      preventiveAction: defects.preventiveAction,\n      dueDate: defects.dueDate,\n      ncrLevel: defects.ncrLevel,\n      verifiedBy: defects.verifiedBy,\n      verifiedAt: defects.verifiedAt,\n      verificationComment: defects.verificationComment,\n      createdAt: defects.createdAt,\n      updatedAt: defects.updatedAt,\n      detectedAt: defects.createdAt,\n      taskName: tasks.name,\n      checklistTemplateName: checklistTemplates.name,\n      assignedToName: sql<string | null>`(SELECT name FROM ${users} WHERE ${users.id} = ${defects.assignedTo})`,\n      detectedByName: sql<string | null>`(SELECT name FROM ${users} WHERE ${users.id} = ${defects.reportedBy})`,\n    })\n    .from(defects)\n    .leftJoin(tasks, eq(defects.taskId, tasks.id))\n    .leftJoin(taskChecklists, eq(defects.checklistId, taskChecklists.id))\n    .leftJoin(checklistTemplates, eq(taskChecklists.templateId, checklistTemplates.id))\n    .orderBy(desc(defects.createdAt));\n  \n  return results;\n}\n\n// Pagination: Get defects with pagination\nexport async function getDefectsPaginated(page: number, pageSize: number, filters?: {\n  projectId?: number;\n  taskId?: number;\n  status?: string;\n  severity?: string;\n  assignedTo?: number;\n}) {\n  const db = await getDb();\n  if (!db) return { items: [], total: 0 };\n\n  const offset = (page - 1) * pageSize;\n\n  // Build where conditions\n  const conditions = [];\n  if (filters?.taskId) {\n    conditions.push(eq(defects.taskId, filters.taskId));\n  }\n  if (filters?.status) {\n    conditions.push(eq(defects.status, filters.status as any));\n  }\n  if (filters?.severity) {\n    conditions.push(eq(defects.severity, filters.severity as any));\n  }\n  if (filters?.assignedTo) {\n    conditions.push(eq(defects.assignedTo, filters.assignedTo));\n  }\n  // Note: projectId filter requires join with tasks table\n  if (filters?.projectId) {\n    conditions.push(eq(tasks.projectId, filters.projectId));\n  }\n\n  const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n  // Get total count\n  const countQuery = db\n    .select({ count: count() })\n    .from(defects)\n    .leftJoin(tasks, eq(defects.taskId, tasks.id));\n  \n  if (whereClause) {\n    countQuery.where(whereClause);\n  }\n  \n  const countResult = await countQuery;\n  const total = countResult[0]?.count || 0;\n\n  // Get paginated items\n  const itemsQuery = db\n    .select({\n      id: defects.id,\n      taskId: defects.taskId,\n      projectId: tasks.projectId,\n      checklistItemResultId: defects.checklistItemResultId,\n   \n\n... ()",
    "drizzle/schema.ts": "import { mysqlTable, mysqlSchema, AnyMySqlColumn, index, int, varchar, text, timestamp, mysqlEnum, tinyint } from \"drizzle-orm/mysql-core\"\nimport { sql } from \"drizzle-orm\"\n\nexport const activityLog = mysqlTable(\"activityLog\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tprojectId: int(),\n\ttaskId: int(),\n\tdefectId: int(),\n\taction: varchar({ length: 100 }).notNull(),\n\tdetails: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdx\").on(table.userId),\n\tindex(\"projectIdx\").on(table.projectId),\n\tindex(\"taskIdx\").on(table.taskId),\n\tindex(\"defectIdx\").on(table.defectId),\n\tindex(\"actionIdx\").on(table.action),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const alertThresholds = mysqlTable(\"alertThresholds\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tmetricType: mysqlEnum(['cpu','memory']).notNull(),\n\tthreshold: int().notNull(),\n\tisEnabled: tinyint().default(1).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"userMetricIdx\").on(table.userId, table.metricType),\n]);\n\nexport const approvalSteps = mysqlTable(\"approvalSteps\", {\n\tid: int().autoincrement().notNull(),\n\tapprovalId: int().notNull(),\n\tapproverId: int().notNull(),\n\tstatus: mysqlEnum(['pending','approved','rejected']).default('pending').notNull(),\n\tcomments: text(),\n\tsignatureData: text(),\n\tapprovedAt: timestamp(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"approvalIdx\").on(table.approvalId),\n\tindex(\"approverIdx\").on(table.approverId),\n]);\n\nexport const approvals = mysqlTable(\"approvals\", {\n\tid: int().autoincrement().notNull(),\n\tentityType: mysqlEnum(['defect','checklist']).notNull(),\n\tentityId: int().notNull(),\n\tstatus: mysqlEnum(['pending','approved','rejected']).default('pending').notNull(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"entityIdx\").on(table.entityType, table.entityId),\n]);\n\nexport const archiveHistory = mysqlTable(\"archiveHistory\", {\n\tid: int().autoincrement().notNull(),\n\tprojectId: int().notNull(),\n\taction: mysqlEnum(['archived','unarchived']).notNull(),\n\tperformedBy: int().notNull(),\n\treason: text(),\n\truleId: int(),\n\tperformedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"projectIdIdx\").on(table.projectId),\n\tindex(\"performedAtIdx\").on(table.performedAt),\n]);\n\nexport const archiveRules = mysqlTable(\"archiveRules\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tenabled: tinyint().default(1).notNull(),\n\tprojectStatus: mysqlEnum(['planning','active','on_hold','completed','cancelled']),\n\tdaysAfterCompletion: int(),\n\tdaysAfterEndDate: int(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n\tlastRunAt: timestamp(),\n});\n\nexport const categoryColors = mysqlTable(\"categoryColors\", {\n\tid: int().autoincrement().notNull(),\n\tprojectId: int().notNull(),\n\tcategory: mysqlEnum(['preparation','structure','architecture','mep','other']).notNull(),\n\tcolor: varchar({ length: 7 }).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"projectCategoryIdx\").on(table.projectId, table.category),\n]);\n\nexport const checklistItemResults = mysqlTable(\"checklistItemResults\", {\n\tid: int().autoincrement().notNull(),\n\ttaskChecklistId: int().notNull(),\n\ttemplateItemId: int().notNull(),\n\tresult: mysqlEnum(['pass','fail','na']).notNull(),\n\tphotoUrls: text(),\n\tcomments: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"checklistIdx\").on(table.taskChecklistId),\n]);\n\nexport const checklistResults = mysqlTable(\"checklistResults\", {\n\tid: int().autoincrement().notNull(),\n\tchecklistId: int().notNull(),\n\titemId: int().notNull(),\n\tresult: mysqlEnum(['pass','fail','na']).notNull(),\n\tcomment: text(),\n\tphotoUrls: text(),\n\tinspectedBy: int().notNull(),\n\tinspectedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"checklistIdx\").on(table.checklistId),\n\tindex(\"itemIdx\").on(table.itemId),\n]);\n\nexport const checklistTemplateItems = mysqlTable(\"checklistTemplateItems\", {\n\tid: int().autoincrement().notNull(),\n\ttemplateId: int().notNull(),\n\titemText: text().notNull(),\n\torder: int().default(0).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"templateIdx\").on(table.templateId),\n]);\n\nexport const checklistTemplates = mysqlTable(\"checklistTemplates\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tcategory: varchar({ length: 100 }),\n\tstage: mysqlEnum(['pre_execution','in_progress','post_execution']).notNull(),\n\tdescription: text(),\n\tallowGeneralComments: tinyint().default(1).notNull(),\n\tallowPhotos: tinyint().default(1).notNull(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"categoryIdx\").on(table.category),\n\tindex(\"stageIdx\").on(table.stage),\n]);\n\nexport const dbStatistics = mysqlTable(\"dbStatistics\", {\n\tid: int().autoincrement().notNull(),\n\ttableName: varchar({ length: 100 }).notNull(),\n\trowCount: int().notNull(),\n\tdataSize: int().notNull(),\n\tindexSize: int().notNull(),\n\tavgQueryTime: int(),\n\tqueryCount: int().default(0).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"tableNameIdx\").on(table.tableName),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const defectAttachments = mysqlTable(\"defectAttachments\", {\n\tid: int().autoincrement().notNull(),\n\tdefectId: int().notNull(),\n\tfileUrl: varchar({ length: 500 }).notNull(),\n\tfileKey: varchar({ length: 500 }).notNull(),\n\tfileName: varchar({ length: 255 }).notNull(),\n\tfileType: varchar({ length: 100 }).notNull(),\n\tfileSize: int().notNull(),\n\tattachmentType: mysqlEnum(['before','after','supporting']).notNull(),\n\tuploadedBy: int().notNull(),\n\tuploadedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"defectIdx\").on(table.defectId),\n\tindex(\"typeIdx\").on(table.attachmentType),\n]);\n\nexport const defectInspections = mysqlTable(\"defect_inspections\", {\n\tid: int().autoincrement().notNull(),\n\tdefectId: int().notNull(),\n\tinspectorId: int().notNull(),\n\tinspectionType: varchar({ length: 20 }).notNull(),\n\tresult: varchar({ length: 20 }).default('pending').notNull(),\n\tcomments: text(),\n\tphotoUrls: text(),\n\tinspectedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"defectIdx\").on(table.defectId),\n\tindex(\"inspectorIdx\").on(table.inspectorId),\n\tindex(\"typeIdx\").on(table.inspectionType),\n]);\n\nexport const defects = mysqlTable(\"defects\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tchecklistItemResultId: int(),\n\ttitle: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tphotoUrls: text(),\n\tstatus: mysqlEnum(['reported','analysis','in_progress','resolved','pending_reinspection','closed']).default('reported').notNull(),\n\tseverity: mysqlEnum(['low','medium','high','critical']).default('medium').notNull(),\n\tassignedTo: int(),\n\treportedBy: int().notNull(),\n\tresolvedBy: int(),\n\tresolvedAt: timestamp(),\n\tresolutionPhotoUrls: text(),\n\tresolutionComment: text(),\n\ttype: mysqlEnum(['CAR','PAR','NCR']).default('CAR').notNull(),\n\tchecklistId: int(),\n\trootCause: text(),\n\tcorrectiveAction: text(),\n\tpreventiveAction: text(),\n\tdueDate: timestamp(),\n\tactionMethod: text(),\n\tactionResponsible: varchar({ length: 255 }),\n\tactionDeadline: timestamp(),\n\tactionNotes: text(),\n\tncrLevel: mysqlEnum(['major','minor']),\n\tverifiedBy: int(),\n\tverifiedAt: timestamp(),\n\tverificationComment: text(),\n\tresolutionNotes: text(),\n\timplementationMethod: text(),\n\tbeforePhotos: text(),\n\tafterPhotos: text(),\n\tclosureNotes: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n\tescalation: text(),\n},\n(table) => [\n\tindex(\"taskIdx\").on(table.taskId),\n\tindex(\"statusIdx\").on(table.status),\n\tindex(\"assignedToIdx\").on(table.assignedTo),\n\tindex(\"typeIdx\").on(table.type),\n\tindex(\"checklistIdx\").on(table.checklistId),\n]);\n\nexport const memoryLogs = mysqlTable(\"memoryLogs\", {\n\tid: int().autoincrement().notNull(),\n\ttimestamp: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\ttotalMemoryMb: int().notNull(),\n\tusedMemoryMb: int().notNull(),\n\tfreeMemoryMb: int().notNull(),\n\tusagePercentage: int().notNull(),\n\tbuffersCacheMb: int(),\n\tavailableMemoryMb: int(),\n\tswapTotalMb: int(),\n\tswapUsedMb: int(),\n\tswapFreePercentage: int(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"timestampIdx\").on(table.timestamp),\n\tindex(\"usagePercentageIdx\").on(table.usagePercentage),\n]);\n\nexport const notificationSettings = mysqlTable(\"notificationSettings\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tenableTaskDeadlineReminders: tinyint().default(1).notNull(),\n\ttaskDeadlineDaysAdvance: int().default(3).notNull(),\n\tenableDefectOverdueReminders: tinyint().default(1).notNull(),\n\tdefectOverdueDaysThreshold: int().default(7).notNull(),\n\tenableDailySummary: tinyint().default(0).notNull(),\n\tdailySummaryTime: varchar({ length: 5 }).default('08:00'),\n\tenableInAppNotifications: tinyint().default(1).notNull(),\n\tenableEmailNotifications: tinyint().default(1).notNull(),\n\tenablePushNotifications: tinyint().default(1).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"notificationSettings_userId_unique\").on(table.userId),\n\tindex(\"userIdx\").on(table.userId),\n]);\n\nexport const notifications = mysqlTable(\"notifications\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\ttype: mysqlEnum(['task_assigned','task_status_changed','task_deadline_approaching','task_overdue','task_progress_updated','task_comment_mention','inspection_requested','inspection_completed','inspection_passed','inspection_failed','checklist_assigned','checklist_reminder','reinspection_required','defect_assigned','defect_created','defect_status_changed','defect_resolved','defect_reinspected','defect_deadline_approaching','project_member_added','project_milestone_reached','project_status_changed','file_uploaded','comment_added','dependency_blocked','comment_mention','task_updated','deadline_reminder','system_health_warning','system_health_critical','system_health_info']).notNull(),\n\tpriority: mysqlEnum(['urgent','high','normal','low']).default('normal').notNull(),\n\ttitle: varchar({ length: 255 }).notNull(),\n\tcontent: text(),\n\trelatedTaskId: int(),\n\trelatedProjectId: int(),\n\trelatedDefectId: int(),\n\tisRead: tinyint().default(0).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdx\").on(table.userId),\n\tindex(\"isReadIdx\").on(table.isRead),\n\tindex(\"typeIdx\").on(table.type),\n\tindex(\"relatedTaskIdx\").on(table.relatedTaskId),\n\tindex(\"relatedProjectIdx\").on(table.relatedProjectId),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const oomEvents = mysqlTable(\"oomEvents\", {\n\tid: int().autoincrement().notNull(),\n\ttimestamp: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tprocessName: varchar({ length: 255 }),\n\tprocessId: int(),\n\tkilledProcessName: varchar({ length: 255 }),\n\tkilledProcessId: int(),\n\tmemoryUsedMb: int(),\n\tseverity: mysqlEnum(['low','medium','high','critical']).default('medium').notNull(),\n\tlogMessage: text(),\n\tresolved: tinyint().default(0).notNull(),\n\tresolvedAt: timestamp(),\n\tresolvedBy: int(),\n\tresolutionNotes: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"timestampIdx\").on(table.timestamp),\n\tindex(\"severityIdx\").on(table.severity),\n\tindex(\"resolvedIdx\").on(table.resolved),\n]);\n\nexport const projectMembers = mysqlTable(\"projectMembers\", {\n\tid: int().autoincrement().notNull(),\n\tprojectId: int().notNull(),\n\tuserId: int().notNull(),\n\trole: mysqlEnum(['project_manager','qc_inspector','worker']).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"projectUserIdx\").on(table.projectId, table.userId),\n]);\n\nexport const projects = mysqlTable(\"projects\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tcode: varchar({ length: 100 }),\n\tlocation: text(),\n\tlatitude: varchar({ length: 50 }),\n\tlongitude: varchar({ length: 50 }),\n\townerName: varchar({ length: 255 }),\n\tstartDate: varchar({ length: 10 }),\n\tendDate: varchar({ length: 10 }),\n\tbudget: int(),\n\tstatus: mysqlEnum(['draft','planning','active','on_hold','completed','cancelled']).default('draft').notNull(),\n\tcompletionPercentage: int().default(0),\n\tcolor: varchar({ length: 7 }).default('#3B82F6'),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n\tarchivedAt: timestamp(),\n\tarchivedBy: int(),\n\tarchivedReason: text(),\n},\n(table) => [\n\tindex(\"createdByIdx\").on(table.createdBy),\n\tindex(\"archivedAtIdx\").on(table.archivedAt),\n]);\n\nexport const pushSubscriptions = mysqlTable(\"pushSubscriptions\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tendpoint: text().notNull(),\n\tp256Dh: text().notNull(),\n\tauth: text().notNull(),\n\tuserAgent: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tlastUsedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdx\").on(table.userId),\n]);\n\nexport const qcChecklistItems = mysqlTable(\"qc_checklist_items\", {\n\tid: int().autoincrement().notNull(),\n\tchecklistId: int().notNull(),\n\titemText: text().notNull(),\n\torderIndex: int().default(0).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const qcChecklists = mysqlTable(\"qc_checklists\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tcategory: varchar({ length: 100 }),\n\tisTemplate: tinyint().default(1).notNull(),\n\tprojectId: int(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const qcInspectionResults = mysqlTable(\"qc_inspection_results\", {\n\tid: int().autoincrement().notNull(),\n\tinspectionId: int().notNull(),\n\tchecklistItemId: int().notNull(),\n\tresult: mysqlEnum(['pass','fail','na']).notNull(),\n\tremarks: text(),\n\tphotoUrl: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const qcInspections = mysqlTable(\"qc_inspections\", {\n\tid: int().autoincrement().notNull(),\n\tprojectId: int().notNull(),\n\tchecklistId: int().notNull(),\n\ttaskId: int(),\n\tinspectionDate: timestamp().notNull(),\n\tinspectorId: int().notNull(),\n\tlocation: text(),\n\tstatus: mysqlEnum(['pending','in_progress','completed','failed']).default('pending').notNull(),\n\toverallResult: mysqlEnum(['pass','fail','conditional']),\n\tnotes: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const queryLogs = mysqlTable(\"queryLogs\", {\n\tid: int().autoincrement().notNull(),\n\tqueryText: text().notNull(),\n\texecutionTime: int().notNull(),\n\ttableName: varchar({ length: 100 }),\n\toperationType: mysqlEnum(['SELECT','INSERT','UPDATE','DELETE','OTHER']).notNull(),\n\tuserId: int(),\n\tendpoint: varchar({ length: 255 }),\n\terrorMessage: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const scheduledNotifications = mysqlTable(\"scheduledNotifications\", {\n\tid: int().autoincrement().notNull(),\n\ttype: mysqlEnum(['task_deadline_reminder','defect_overdue_reminder','inspection_reminder','daily_summary']).notNull(),\n\tuserId: int().notNull(),\n\trelatedTaskId: int(),\n\trelatedDefectId: int(),\n\trelatedProjectId: int(),\n\tscheduledFor: timestamp().notNull(),\n\tstatus: mysqlEnum(['pending','sent','failed','cancelled']).default('pending').notNull(),\n\ttitle: varchar({ length: 255 }).notNull(),\n\tcontent: text(),\n\tpriority: mysqlEnum(['urgent','high','normal','low']).default('normal').notNull(),\n\tsentAt: timestamp(),\n\terrorMessage: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const signatures = mysqlTable(\"signatures\", {\n\tid: int().autoincrement().notNull(),\n\tchecklistId: int().notNull(),\n\tsignatureData: text().notNull(),\n\tsignedBy: int().notNull(),\n\tsignedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const systemLogs = mysqlTable(\"systemLogs\", {\n\tid: int().autoincrement().notNull(),\n\ttype: mysqlEnum(['error','warning','info','performance','security']).notNull(),\n\tcategory: varchar({ length: 100 }).notNull(),\n\tmessage: text().notNull(),\n\tdetails: text(),\n\tseverity: mysqlEnum(['low','medium','high','critical']).default('low').notNull(),\n\tuserId: int(),\n\tipAddress: varchar({ length: 45 }),\n\tuserAgent: text(),\n\tresolved: tinyint().default(0).notNull(),\n\tresolvedBy: int(),\n\tresolvedAt: timestamp(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const taskAssignments = mysqlTable(\"taskAssignments\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tuserId: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const taskAttachments = mysqlTable(\"taskAttachments\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tfileName: varchar({ length: 255 }).notNull(),\n\tfileUrl: text().notNull(),\n\tfileKey: varchar({ length: 500 }).notNull(),\n\tfileSize: int(),\n\tmimeType: varchar({ length: 100 }),\n\tuploadedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const taskChecklists = mysqlTable(\"taskChecklists\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\ttemplateId: int().notNull(),\n\tstage: mysqlEnum(['pre_execution','in_progress','post_execution']).notNull(),\n\tstatus: mysqlEnum(['not_started','pending_inspection','in_progress','completed','failed']).default('not_started').notNull(),\n\tinspectedBy: int(),\n\tinspectedAt: timestamp(),\n\tgeneralComments: text(),\n\tphotoUrls: text(),\n\tsignature: text(),\n\toriginalInspectionId: int(),\n\treinspectionCount: int().default(0).notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const taskComments = mysqlTable(\"taskComments\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tuserId: int().notNull(),\n\tcontent: text().notNull(),\n\tmentions: text(),\n\tattachmentUrls: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const taskDependencies = mysqlTable(\"taskDependencies\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tdependsOnTaskId: int().notNull(),\n\ttype: mysqlEnum(['finish_to_start','start_to_start','finish_to_finish']).default('finish_to_start').notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const taskFollowers = mysqlTable(\"taskFollowers\", {\n\tid: int().autoincrement().notNull(),\n\ttaskId: int().notNull(),\n\tuserId: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const tasks = mysqlTable(\"tasks\", {\n\tid: int().autoincrement().notNull(),\n\tprojectId: int().notNull(),\n\tparentTaskId: int(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tstartDate: varchar({ length: 10 }),\n\tendDate: varchar({ length: 10 }),\n\tprogress: int().default(0).notNull(),\n\tstatus: mysqlEnum(['todo','pending_pre_inspection','ready_to_start','in_progress','pending_final_inspection','rectification_needed','completed','not_started','delayed']).default('todo').notNull(),\n\tassigneeId: int(),\n\tcategory: varchar({ length: 50 }),\n\tpriority: mysqlEnum(['low','medium','high','urgent']).default('medium').notNull(),\n\torder: int().default(0).notNull(),\n\tphotoUrls: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n\tescalation: text(),\n});\n\nexport const errorLogs = mysqlTable(\"errorLogs\", {\n\tid: int().autoincrement().notNull(),\n\terrorMessage: text().notNull(),\n\terrorStack: text(),\n\tuserAgent: text(),\n\turl: text(),\n\tuserId: int(),\n\tseverity: mysqlEnum(['low','medium','high','critical']).default('medium').notNull(),\n\tresolved: tinyint().default(0).notNull(),\n\tresolvedBy: int(),\n\tresolvedAt: timestamp(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"createdAtIdx\").on(table.createdAt),\n\tindex(\"severityIdx\").on(table.severity),\n\tindex(\"resolvedIdx\").on(table.resolved),\n]);\n\nexport const permissions = mysqlTable(\"permissions\", {\n\tid: int().autoincrement().notNull(),\n\tmodule: varchar({ length: 100 }).notNull(),\n\taction: varchar({ length: 100 }).notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"moduleActionIdx\").on(table.module, table.action),\n]);\n\nexport const userPermissions = mysqlTable(\"userPermissions\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tpermissionId: int().notNull(),\n\tgranted: tinyint().default(1).notNull(),\n\tgrantedBy: int().notNull(),\n\tgrantedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdIdx\").on(table.userId),\n\tindex(\"permissionIdIdx\").on(table.permissionId),\n]);\n\nexport const userActivityLogs = mysqlTable(\"userActivityLogs\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\taction: varchar({ length: 255 }).notNull(),\n\tmodule: varchar({ length: 100 }),\n\tdetails: text(),\n\tipAddress: varchar({ length: 45 }),\n\tuserAgent: text(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdIdx\").on(table.userId),\n\tindex(\"actionIdx\").on(table.action),\n\tindex(\"moduleIdx\").on(table.module),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const bulkImportLogs = mysqlTable(\"bulkImportLogs\", {\n\tid: int().autoincrement().notNull(),\n\timportedBy: int().notNull(),\n\tfileName: varchar({ length: 255 }).notNull(),\n\tfileSize: int(),\n\ttotalRecords: int().notNull(),\n\tsuccessCount: int().default(0).notNull(),\n\tfailureCount: int().default(0).notNull(),\n\terrorDetails: text(),\n\tstatus: mysqlEnum(['pending','processing','completed','failed']).default('pending').notNull(),\n\tcompletedAt: timestamp(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"importedByIdx\").on(table.importedBy),\n\tindex(\"statusIdx\").on(table.status),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const roleTemplates = mysqlTable(\"roleTemplates\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\tpermissions: text().notNull(),\n\tisDefault: tinyint().default(0).notNull(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n});\n\nexport const escalationRules = mysqlTable(\"escalationRules\", {\n\tid: int().autoincrement().notNull(),\n\tname: varchar({ length: 255 }).notNull(),\n\tdescription: text(),\n\teventType: mysqlEnum(['failed_inspection','unresolved_defect','overdue_task']).notNull(),\n\tthresholdValue: int().notNull(),\n\tthresholdUnit: mysqlEnum(['hours','days']).default('hours').notNull(),\n\tnotifyRoles: text().notNull(),\n\tnotifyUsers: text(),\n\tisActive: tinyint().default(1).notNull(),\n\tcreatedBy: int().notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"eventTypeIdx\").on(table.eventType),\n\tindex(\"isActiveIdx\").on(table.isActive),\n]);\n\nexport const escalationLogs = mysqlTable(\"escalationLogs\", {\n\tid: int().autoincrement().notNull(),\n\truleId: int().notNull(),\n\teventType: mysqlEnum(['failed_inspection','unresolved_defect','overdue_task']).notNull(),\n\tentityId: int().notNull(),\n\tnotifiedUsers: text().notNull(),\n\tescalatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"ruleIdIdx\").on(table.ruleId),\n\tindex(\"eventTypeIdx\").on(table.eventType),\n\tindex(\"entityIdIdx\").on(table.entityId),\n\tindex(\"escalatedAtIdx\").on(table.escalatedAt),\n]);\n\nexport const users = mysqlTable(\"users\", {\n\tid: int().autoincrement().notNull(),\n\topenId: varchar({ length: 64 }).notNull(),\n\tname: text(),\n\temail: varchar({ length: 320 }),\n\tloginMethod: varchar({ length: 64 }),\n\trole: mysqlEnum(['owner','admin','project_manager','qc_inspector','worker']).default('worker').notNull(),\n\tcreatedAt: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp().defaultNow().onUpdateNow().notNull(),\n\tlastSignedIn: timestamp().default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tnotificationDaysAdvance: int().default(3).notNull(),\n\tenableInAppNotifications: tinyint().default(1).notNull(),\n\tenableEmailNotifications: tinyint().default(1).notNull(),\n\tenableDailySummaryEmail: tinyint().default(0).notNull(),\n\tdailySummaryTime: varchar({ length: 5 }).default('08:00'),\n},\n(table) => [\n\tindex(\"openId\").on(table.openId),\n]);\n\n\n// Export Insert Types\nexport type InsertUser = typeof users.$inferInsert;\nexport type InsertProject = typeof projects.$inferInsert;\nexport type InsertTask = typeof tasks.$inferInsert;\nexport type InsertDefect = typeof defects.$inferInsert;\nexport type InsertDefectAttachment = typeof defectAttachments.$inferInsert;\nexport type InsertDefectInspection = typeof defectInspections.$inferInsert;\nexport type InsertNotification = typeof notifications.$inferInsert;\nexport type InsertScheduledNotification = typeof scheduledNotifications.$inferInsert;\nexport type InsertTaskComment = typeof taskComments.$inferInsert;\nexport type InsertTaskAttachment = typeof taskAttachments.$inferInsert;\nexport type InsertChecklistTemplate = typeof checklistTemplates.$inferInsert;\nexport type InsertChecklistTemplateItem = typeof checklistTemplateItems.$inferInsert;\nexport type InsertTaskChecklist = typeof taskChecklists.$inferInsert;\nexport type InsertChecklistItemResult = typeof checklistItemResults.$inferInsert;\nexport type InsertActivityLog = typeof activityLog.$inferInsert;\nexport type InsertEscalationRule = typeof escalationRules.$inferInsert;\nexport type InsertEscalationLog = typeof escalationLogs.$inferInsert;\nexport type InsertQueryLog = typeof queryLogs.$inferInsert;\nexport type InsertDbStatistic = typeof dbStatistics.$inferInsert;\nexport type InsertPushSubscription = typeof pushSubscriptions.$inferInsert;\nexport type InsertAlertThreshold = typeof alertThresholds.$inferInsert;\nexport type InsertTaskDependency = typeof taskDependencies.$inferInsert;\nexport type InsertTaskAssignment = typeof taskAssignments.$inferInsert;\nexport type InsertTaskFollower = typeof taskFollowers.$inferInsert;\nexport type InsertArchiveRule = typeof archiveRules.$inferInsert;\nexport type InsertArchiveHistory = typeof archiveHistory.$inferInsert;\nexport type InsertErrorLog = typeof errorLogs.$inferInsert;\nexport type InsertPermission = typeof permissions.$inferInsert;\nexport type InsertUserPermission = typeof userPermissions.$inferInsert;\nexport type InsertUserActivityLog = typeof userActivityLogs.$inferInsert;\nexport type InsertBulkImportLog = typeof bulkImportLogs.$inferInsert;\nexport type InsertRoleTemplate = typeof roleTemplates.$inferInsert;\n\n// Export Select Types\nexport type User = typeof users.$inferSelect;\nexport type Project = typeof projects.$inferSelect;\nexport type Task = typeof tasks.$inferSelect;\nexport type Defect = typeof defects.$inferSelect;\nexport type ChecklistTemplate = typeof checklistTemplates.$inferSelect;\nexport type ChecklistTemplateItem = typeof checklistTemplateItems.$inferSelect;\nexport type TaskChecklist = typeof taskChecklists.$inferSelect;\nexport type ChecklistItemResult = typeof checklistItemResults.$inferSelect;\nexport type TaskComment = typeof taskComments.$inferSelect;\nexport type TaskAttachment = typeof taskAttachments.$inferSelect;\nexport type ActivityLog = typeof activityLog.$inferSelect;\nexport type Notification = typeof notifications.$inferSelect;\nexport type TaskDependency = typeof taskDependencies.$inferSelect;\nexport type TaskAssignment = typeof taskAssignments.$inferSelect;\nexport type TaskFollower = typeof taskFollowers.$inferSelect;\n\n// Additional composite types\nexport type ActivityLogWithUser = ActivityLog & {\n  user: Pick<User, 'id' | 'name' | 'email'> | null;\n};\n\nexport type DefectAttachment = typeof defectAttachments.$inferSelect;\nexport type DefectInspection = typeof defectInspections.$inferSelect;\nexport type EscalationRule = typeof escalationRules.$inferSelect;\nexport type EscalationLog = typeof escalationLogs.$inferSelect;\nexport type ErrorLog = typeof errorLogs.$inferSelect;\nexport type Permission = typeof permissions.$inferSelect;\nexport type UserPermission = typeof userPermissions.$inferInsert;\nexport type UserActivityLog = typeof userActivityLogs.$inferSelect;\nexport type BulkImportLog = typeof bulkImportLogs.$inferSelect;\nexport type RoleTemplate = typeof roleTemplates.$inferSelect;\nexport type ScheduledNotification = typeof scheduledNotifications.$inferSelect;\nexport type NotificationSetting = typeof notificationSettings.$inferSelect;\nexport type PushSubscription = typeof pushSubscriptions.$inferSelect;\nexport type Signature = typeof signatures.$inferSelect;\nexport type Approval = typeof approvals.$inferSelect;\nexport type ApprovalStep = typeof approvalSteps.$inferSelect;\nexport type ArchiveRule = typeof archiveRules.$inferSelect;\nexport type ArchiveHistory = typeof archiveHistory.$inferSelect;\nexport type CategoryColor = typeof categoryColors.$inferSelect;\nexport type AlertThreshold = typeof alertThresholds.$inferSelect;\nexport type QueryLog = typeof queryLogs.$inferSelect;\nexport type DbStatistic = typeof dbStatistics.$inferSelect;\nexport type MemoryLog = typeof memoryLogs.$inferSelect;\nexport type OomEvent = typeof oomEvents.$inferSelect;\nexport type SystemLog = typeof systemLogs.$inferSelect;\nexport type ProjectMember = typeof projectMembers.$inferSelect;\n",
    "server/services/project.service.ts": "/**\n * Project Service\n * \n * Handles project-related business logic with proper data integrity:\n * - createProject: Creates project and automatically adds creator as project manager\n * - deleteProject: Deletes project and all related data (members, tasks, dependencies, etc.)\n * \n * Uses toNumber() helper for safe ID conversions and constants from utils/constants.ts\n */\n\nimport { eq, inArray, and } from \"drizzle-orm\";\nimport { getDb } from \"../db\";\nimport {\n  projects,\n  projectMembers,\n  tasks,\n  taskDependencies,\n  taskFollowers,\n  taskAttachments,\n  taskComments,\n  taskChecklists,\n  checklistItemResults,\n  defects,\n  notifications,\n  activityLog,\n  taskAssignments,\n} from \"../../drizzle/schema\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { PROJECT_STATUS } from \"../constants/statuses\";\nimport { logger } from \"../logger\";\n\n/**\n * Generate next available project code in format AO-YYYY-XXX\n */\nasync function generateProjectCode(): Promise<string> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const currentYear = new Date().getFullYear();\n  const prefix = `AO-${currentYear}-`;\n\n  // Get the highest number for current year\n  const result = await db\n    .select()\n    .from(projects)\n    .where(eq(projects.code, prefix))\n    .orderBy(projects.code)\n    .limit(1);\n\n  let nextNumber = 1;\n  if (result.length > 0) {\n    const lastCode = result[0].code;\n    const lastNumber = parseInt(lastCode.split(\"-\")[2] || \"0\");\n    nextNumber = lastNumber + 1;\n  }\n\n  return `${prefix}${nextNumber.toString().padStart(3, \"0\")}`;\n}\n\n/**\n * Create a new project with automatic member assignment\n * \n * @param data Project creation data\n * @returns Object with insertId and id of created project\n * \n * @throws Error if database is unavailable or operation fails\n * \n * Business Logic:\n * 1. Auto-generates project code if not provided (format: AO-YYYY-XXX)\n * 2. Creates project record with status 'draft' by default\n * 3. Automatically adds creator as project manager in projectMembers table\n * 4. Returns safe numeric ID using toNumber() helper\n */\nexport async function createProject(data: {\n  name: string;\n  code?: string;\n  location?: string;\n  latitude?: string;\n  longitude?: string;\n  ownerName?: string;\n  startDate?: string;\n  endDate?: string;\n  createdBy: number;\n}): Promise<{ insertId: number; id: number }> {\n  // Use transaction to ensure atomicity\n  return await withTransaction(async (tx) => {\n    // Prepare project values\n    const values: typeof projects.$inferInsert = {\n      name: data.name,\n      createdBy: data.createdBy,\n      status: PROJECT_STATUS.DRAFT,\n    };\n\n    // Auto-generate code if not provided\n    if (data.code) {\n      values.code = data.code;\n    } else {\n      values.code = await generateProjectCode();\n    }\n\n    // Optional fields\n    if (data.location) values.location = data.location;\n    if (data.latitude) values.latitude = data.latitude;\n    if (data.longitude) values.longitude = data.longitude;\n    if (data.ownerName) values.ownerName = data.ownerName;\n    if (data.startDate) values.startDate = data.startDate;\n    if (data.endDate) values.endDate = data.endDate;\n\n    // Insert project within transaction\n    const [result] = await tx.insert(projects).values(values);\n\n    // Convert insertId to number safely\n    const projectId = bigIntToNumber(result.insertId);\n\n    // Add creator as project manager within same transaction\n    await tx.insert(projectMembers).values({\n      projectId,\n      userId: data.createdBy,\n      role: \"project_manager\",\n    });\n\n    logger.info(`[Project Service] Created project ${projectId} with code ${values.code}`);\n\n    return { insertId: projectId, id: projectId };\n  });\n}\n\n/**\n * Delete a project and all related data\n * \n * @param id Project ID to delete\n * \n * @throws Error if database is unavailable or operation fails\n * \n * Business Logic:\n * Deletes data in correct order to respect foreign key constraints:\n * 1. Activity logs\n * 2. Task-related data:\n *    - Task dependencies (both directions)\n *    - Task followers\n *    - Task attachments\n *    - Task comments\n *    - Task assignments\n *    - Checklist item results\n *    - Task checklists\n *    - Defects\n *    - Tasks themselves\n * 3. Notifications\n * 4. Project members\n * 5. Project record\n * \n * Uses toNumber() for safe ID conversions throughout the process\n */\nexport async function deleteProject(id: number): Promise<void> {\n  const projectId = bigIntToNumber(id);\n  logger.info(`[Project Service] Starting deletion of project ${projectId}`);\n\n  // Use transaction to ensure all-or-nothing deletion\n  await withTransaction(async (tx) => {\n    // 1. Delete activity logs\n    await tx.delete(activityLog).where(eq(activityLog.projectId, projectId));\n\n    // 2. Get all tasks for this project\n    const projectTasks = await tx\n      .select({ id: tasks.id })\n      .from(tasks)\n      .where(eq(tasks.projectId, projectId));\n\n    const taskIds = projectTasks.map((t) => bigIntToNumber(t.id));\n\n    if (taskIds.length > 0) {\n      logger.info(`[Project Service] Deleting ${taskIds.length} tasks and related data`);\n\n      // Delete task dependencies (both directions)\n      await tx.delete(taskDependencies).where(inArray(taskDependencies.taskId, taskIds));\n      await tx.delete(taskDependencies).where(inArray(taskDependencies.dependsOnTaskId, taskIds));\n\n      // Delete task followers\n      await tx.delete(taskFollowers).where(inArray(taskFollowers.taskId, taskIds));\n\n      // Delete task attachments\n      await tx.delete(taskAttachments).where(inArray(taskAttachments.taskId, taskIds));\n\n      // Delete task comments\n      await tx.delete(taskComments).where(inArray(taskComments.taskId, taskIds));\n\n      // Delete task assignments\n      await tx.delete(taskAssignments).where(inArray(taskAssignments.taskId, taskIds));\n\n      // Get all task checklist IDs\n      const taskChecklistRecords = await tx\n        .select({ id: taskChecklists.id })\n        .from(taskChecklists)\n        .where(inArray(taskChecklists.taskId, taskIds));\n\n      const checklistIds = taskChecklistRecords.map((tc) => bigIntToNumber(tc.id));\n\n      if (checklistIds.length > 0) {\n        // Delete checklist item results\n        await tx\n          .delete(checklistItemResults)\n          .where(inArray(checklistItemResults.taskChecklistId, checklistIds));\n      }\n\n      // Delete task checklists\n      await tx.delete(taskChecklists).where(inArray(taskChecklists.taskId, taskIds));\n\n      // Delete defects\n      await tx.delete(defects).where(inArray(defects.taskId, taskIds));\n\n      // Delete tasks\n      await tx.delete(tasks).where(eq(tasks.projectId, projectId));\n    }\n\n    // 3. Delete notifications\n    await tx.delete(notifications).where(eq(notifications.relatedProjectId, projectId));\n\n    // 4. Delete project members\n    await tx.delete(projectMembers).where(eq(projectMembers.projectId, projectId));\n\n    // 5. Finally delete the project\n    await tx.delete(projects).where(eq(projects.id, projectId));\n\n    logger.info(`[Project Service] Successfully deleted project ${projectId}`);\n  });\n}\n",
    "server/services/task.service.ts": "import { and, desc, eq, inArray, sql, asc } from \"drizzle-orm\";\nimport { getDb } from \"../db/client\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { logger } from \"../logger\";\nimport {\n  tasks,\n  taskDependencies,\n  taskComments,\n  type Task,\n  type InsertTask,\n  type TaskDependency,\n  type InsertTaskDependency,\n  type TaskComment,\n  type InsertTaskComment,\n} from \"../../drizzle/schema\";\n\n/**\n * Task Service\n * Handles all task-related operations including dependencies and comments\n */\n\n// ============================================================================\n// Task CRUD Operations\n// ============================================================================\n\nexport async function createTask(data: InsertTask): Promise<Task> {\n  return await withTransaction(async (tx) => {\n    const [result] = await tx.insert(tasks).values(data);\n    const taskId = bigIntToNumber(result.insertId);\n    const [created] = await tx.select().from(tasks).where(eq(tasks.id, taskId));\n    \n    if (!created) throw new Error(\"Failed to create task\");\n    logger.info(`[Task Service] Created task ${taskId}`);\n    return created;\n  });\n}\n\nexport async function getTaskById(taskId: number): Promise<Task | undefined> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const [task] = await db.select().from(tasks).where(eq(tasks.id, taskId));\n  return task;\n}\n\nexport async function getTasksByProjectId(projectId: number): Promise<Task[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db.select().from(tasks).where(eq(tasks.projectId, projectId)).orderBy(desc(tasks.createdAt));\n}\n\nexport async function getTasksByAssignee(assigneeId: number): Promise<Task[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(tasks)\n    .where(eq(tasks.assigneeId, assigneeId))\n    .orderBy(desc(tasks.dueDate));\n}\n\nexport async function updateTask(\n  taskId: number,\n  data: Partial<InsertTask>\n): Promise<Task> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(tasks).set(data).where(eq(tasks.id, taskId));\n\n  const [updated] = await db.select().from(tasks).where(eq(tasks.id, taskId));\n  if (!updated) throw new Error(\"Task not found after update\");\n\n  return updated;\n}\n\nexport async function deleteTask(taskId: number): Promise<void> {\n  const safeTaskId = bigIntToNumber(taskId);\n  logger.info(`[Task Service] Starting deletion of task ${safeTaskId}`);\n  \n  await withTransaction(async (tx) => {\n    // Delete dependencies first\n    await tx.delete(taskDependencies).where(\n      sql`${taskDependencies.taskId} = ${safeTaskId} OR ${taskDependencies.dependsOnTaskId} = ${safeTaskId}`\n    );\n\n    // Delete comments\n    await tx.delete(taskComments).where(eq(taskComments.taskId, safeTaskId));\n\n    // Delete task\n    await tx.delete(tasks).where(eq(tasks.id, safeTaskId));\n    \n    logger.info(`[Task Service] Successfully deleted task ${safeTaskId}`);\n  });\n}\n\n// ============================================================================\n// Task Dependencies\n// ============================================================================\n\nexport async function createTaskDependency(\n  data: InsertTaskDependency\n): Promise<TaskDependency> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  // Check for circular dependencies\n  const hasCircular = await checkCircularDependency(data.taskId, data.dependsOnTaskId);\n  if (hasCircular) {\n    throw new Error(\"Circular dependency detected\");\n  }\n\n  const [dep] = await db.insert(taskDependencies).values(data).$returningId();\n  const [created] = await db\n    .select()\n    .from(taskDependencies)\n    .where(eq(taskDependencies.id, dep.id));\n\n  if (!created) throw new Error(\"Failed to create task dependency\");\n  return created;\n}\n\nexport async function getTaskDependencies(taskId: number): Promise<TaskDependency[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db.select().from(taskDependencies).where(eq(taskDependencies.taskId, taskId));\n}\n\nexport async function getTaskDependents(taskId: number): Promise<TaskDependency[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(taskDependencies)\n    .where(eq(taskDependencies.dependsOnTaskId, taskId));\n}\n\nexport async function deleteTaskDependency(dependencyId: number): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.delete(taskDependencies).where(eq(taskDependencies.id, dependencyId));\n}\n\nasync function checkCircularDependency(\n  taskId: number,\n  dependsOnTaskId: number\n): Promise<boolean> {\n  const db = await getDb();\n  if (!db) return false;\n\n  // BFS to detect cycles\n  const visited = new Set<number>();\n  const queue: number[] = [dependsOnTaskId];\n\n  while (queue.length > 0) {\n    const current = queue.shift()!;\n\n    if (current === taskId) {\n      return true; // Circular dependency found\n    }\n\n    if (visited.has(current)) continue;\n    visited.add(current);\n\n    const deps = await db\n      .select()\n      .from(taskDependencies)\n      .where(eq(taskDependencies.taskId, current));\n\n    for (const dep of deps) {\n      queue.push(dep.dependsOnTaskId);\n    }\n  }\n\n  return false;\n}\n\n// ============================================================================\n// Task Comments\n// ============================================================================\n\nexport async function createTaskComment(data: InsertTaskComment): Promise<TaskComment> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const [comment] = await db.insert(taskComments).values(data).$returningId();\n  const [created] = await db\n    .select()\n    .from(taskComments)\n    .where(eq(taskComments.id, comment.id));\n\n  if (!created) throw new Error(\"Failed to create task comment\");\n  return created;\n}\n\nexport async function getTaskComments(taskId: number): Promise<TaskComment[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(taskComments)\n    .where(eq(taskComments.taskId, taskId))\n    .orderBy(desc(taskComments.createdAt));\n}\n\nexport async function updateTaskComment(\n  commentId: number,\n  content: string\n): Promise<TaskComment> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db\n    .update(taskComments)\n    .set({ content, updatedAt: new Date() })\n    .where(eq(taskComments.id, commentId));\n\n  const [updated] = await db\n    .select()\n    .from(taskComments)\n    .where(eq(taskComments.id, commentId));\n\n  if (!updated) throw new Error(\"Comment not found after update\");\n  return updated;\n}\n\nexport async function deleteTaskComment(commentId: number): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.delete(taskComments).where(eq(taskComments.id, commentId));\n}\n\n// ============================================================================\n// Bulk Operations\n// ============================================================================\n\nexport async function bulkUpdateTaskStatus(\n  taskIds: number[],\n  status: Task[\"status\"]\n): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(tasks).set({ status }).where(inArray(tasks.id, taskIds));\n}\n\nexport async function getOverdueTasks(): Promise<Task[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const now = new Date();\n  return db\n    .select()\n    .from(tasks)\n    .where(\n      and(\n        sql`${tasks.dueDate} < ${now}`,\n        sql`${tasks.status} != 'completed'`\n      )\n    )\n    .orderBy(tasks.dueDate);\n}\n",
    "server/services/defect.service.ts": "import { and, desc, eq, inArray, sql } from \"drizzle-orm\";\nimport { getDb } from \"../db/client\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { logger } from \"../logger\";\nimport {\n  defects,\n  defectAttachments,\n  activityLog,\n  type Defect,\n  type InsertDefect,\n  type DefectAttachment,\n  type InsertDefectAttachment,\n} from \"../../drizzle/schema\";\n\n/**\n * Defect Service\n * Handles all defect-related operations including attachments\n */\n\n// ============================================================================\n// Defect CRUD Operations\n// ============================================================================\n\nexport async function createDefect(data: InsertDefect): Promise<Defect> {\n  return await withTransaction(async (tx) => {\n    const [result] = await tx.insert(defects).values(data);\n    const defectId = bigIntToNumber(result.insertId);\n    \n    // Create activity log entry\n    await tx.insert(activityLog).values({\n      userId: data.reportedBy,\n      taskId: data.taskId,\n      defectId: defectId,\n      action: 'defect_created',\n      details: `Defect created: ${data.title}`,\n    });\n    \n    const [created] = await tx.select().from(defects).where(eq(defects.id, defectId));\n    if (!created) throw new Error(\"Failed to create defect\");\n    \n    logger.info(`[Defect Service] Created defect ${defectId}`);\n    return created;\n  });\n}\n\nexport async function getDefectById(defectId: number): Promise<Defect | undefined> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const [defect] = await db.select().from(defects).where(eq(defects.id, defectId));\n  return defect;\n}\n\nexport async function getDefectsByProjectId(projectId: number): Promise<Defect[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defects)\n    .where(eq(defects.projectId, projectId))\n    .orderBy(desc(defects.createdAt));\n}\n\nexport async function getDefectsByStatus(\n  projectId: number,\n  status: Defect[\"status\"]\n): Promise<Defect[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defects)\n    .where(and(eq(defects.projectId, projectId), eq(defects.status, status)))\n    .orderBy(desc(defects.createdAt));\n}\n\nexport async function getDefectsBySeverity(\n  projectId: number,\n  severity: Defect[\"severity\"]\n): Promise<Defect[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defects)\n    .where(and(eq(defects.projectId, projectId), eq(defects.severity, severity)))\n    .orderBy(desc(defects.createdAt));\n}\n\nexport async function getDefectsByAssignee(assigneeId: number): Promise<Defect[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defects)\n    .where(eq(defects.assignedTo, assigneeId))\n    .orderBy(desc(defects.createdAt));\n}\n\nexport async function updateDefect(\n  defectId: number,\n  data: Partial<InsertDefect>,\n  updatedBy?: number\n): Promise<Defect> {\n  return await withTransaction(async (tx) => {\n    const safeDefectId = bigIntToNumber(defectId);\n    \n    await tx.update(defects).set(data).where(eq(defects.id, safeDefectId));\n    \n    // Create activity log entry if status changed\n    if (data.status && updatedBy) {\n      await tx.insert(activityLog).values({\n        userId: updatedBy,\n        defectId: safeDefectId,\n        action: 'defect_status_changed',\n        details: `Defect status changed to: ${data.status}`,\n      });\n    }\n    \n    const [updated] = await tx.select().from(defects).where(eq(defects.id, safeDefectId));\n    if (!updated) throw new Error(\"Defect not found after update\");\n    \n    logger.info(`[Defect Service] Updated defect ${safeDefectId}`);\n    return updated;\n  });\n}\n\nexport async function deleteDefect(defectId: number): Promise<void> {\n  const safeDefectId = bigIntToNumber(defectId);\n  logger.info(`[Defect Service] Starting deletion of defect ${safeDefectId}`);\n  \n  await withTransaction(async (tx) => {\n    // Delete attachments first\n    await tx.delete(defectAttachments).where(eq(defectAttachments.defectId, safeDefectId));\n    \n    // Delete activity logs\n    await tx.delete(activityLog).where(eq(activityLog.defectId, safeDefectId));\n\n    // Delete defect\n    await tx.delete(defects).where(eq(defects.id, safeDefectId));\n    \n    logger.info(`[Defect Service] Successfully deleted defect ${safeDefectId}`);\n  });\n}\n\n// ============================================================================\n// Defect Attachments\n// ============================================================================\n\nexport async function createDefectAttachment(\n  data: InsertDefectAttachment\n): Promise<DefectAttachment> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const [attachment] = await db.insert(defectAttachments).values(data).$returningId();\n  const [created] = await db\n    .select()\n    .from(defectAttachments)\n    .where(eq(defectAttachments.id, attachment.id));\n\n  if (!created) throw new Error(\"Failed to create defect attachment\");\n  return created;\n}\n\nexport async function getDefectAttachments(defectId: number): Promise<DefectAttachment[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defectAttachments)\n    .where(eq(defectAttachments.defectId, defectId))\n    .orderBy(desc(defectAttachments.uploadedAt));\n}\n\nexport async function deleteDefectAttachment(attachmentId: number): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.delete(defectAttachments).where(eq(defectAttachments.id, attachmentId));\n}\n\n// ============================================================================\n// Bulk Operations\n// ============================================================================\n\nexport async function bulkUpdateDefectStatus(\n  defectIds: number[],\n  status: Defect[\"status\"]\n): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(defects).set({ status }).where(inArray(defects.id, defectIds));\n}\n\nexport async function bulkAssignDefects(\n  defectIds: number[],\n  assignedTo: number\n): Promise<void> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  await db.update(defects).set({ assignedTo }).where(inArray(defects.id, defectIds));\n}\n\n// ============================================================================\n// Statistics & Analytics\n// ============================================================================\n\nexport async function getDefectStatsByProject(projectId: number): Promise<{\n  total: number;\n  byStatus: Record<string, number>;\n  bySeverity: Record<string, number>;\n}> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  const allDefects = await db\n    .select()\n    .from(defects)\n    .where(eq(defects.projectId, projectId));\n\n  const byStatus: Record<string, number> = {};\n  const bySeverity: Record<string, number> = {};\n\n  for (const defect of allDefects) {\n    byStatus[defect.status] = (byStatus[defect.status] || 0) + 1;\n    bySeverity[defect.severity] = (bySeverity[defect.severity] || 0) + 1;\n  }\n\n  return {\n    total: allDefects.length,\n    byStatus,\n    bySeverity,\n  };\n}\n\nexport async function getCriticalDefects(projectId: number): Promise<Defect[]> {\n  const db = await getDb();\n  if (!db) throw new Error(\"Database not available\");\n\n  return db\n    .select()\n    .from(defects)\n    .where(\n      and(\n        eq(defects.projectId, projectId),\n        eq(defects.severity, \"critical\"),\n        sql`${defects.status} != 'resolved'`\n      )\n    )\n    .orderBy(desc(defects.createdAt));\n}\n",
    "client/src/App.tsx": "import { lazy, Suspense } from \"react\";\nimport { Toaster } from \"@/components/ui/sonner\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport NotFound from \"@/pages/NotFound\";\nimport { Route, Switch } from \"wouter\";\nimport ErrorBoundary from \"./components/ErrorBoundary\";\nimport DefectDetailErrorBoundary from \"./components/DefectDetailErrorBoundary\";\nimport PageErrorBoundary from \"./components/PageErrorBoundary\";\nimport { ThemeProvider } from \"./contexts/ThemeContext\";\nimport Home from \"./pages/Home\";\nimport LoginDemo from \"./pages/LoginDemo\";\nimport DashboardLayout from \"./components/DashboardLayout\";\nimport { PWAInstallBanner } from \"./components/PWAInstallBanner\";\n\n// Lazy load heavy pages\nconst Overview = lazy(() => import(\"./pages/Overview\"));\nconst Dashboard = lazy(() => import(\"./pages/Dashboard\"));\nconst NewDashboard = lazy(() => import(\"./pages/NewDashboard\"));\nconst Projects = lazy(() => import(\"./pages/Projects\"));\nconst Tasks = lazy(() => import(\"./pages/Tasks\"));\nconst QCInspection = lazy(() => import(\"./pages/QCInspection\"));\nconst Defects = lazy(() => import(\"./pages/Defects\"));\nconst DefectDetail = lazy(() => import(\"./pages/DefectDetail\"));\nconst NotificationCenter = lazy(() => import(\"./pages/NotificationCenter\"));\nconst ProjectDetail = lazy(() => import(\"./pages/ProjectDetail\"));\nconst TaskDetail = lazy(() => import(\"./pages/TaskDetail\"));\nconst Settings = lazy(() => import(\"./pages/Settings\"));\nconst Reports = lazy(() => import(\"./pages/Reports\"));\nconst Analytics = lazy(() => import(\"./pages/Analytics\"));\nconst NewProject = lazy(() => import(\"./pages/NewProject\"));\nconst NewTask = lazy(() => import(\"./pages/NewTask\"));\nconst ChecklistTemplates = lazy(() => import(\"./pages/ChecklistTemplates\"));\nconst Templates = lazy(() => import(\"./pages/Templates\"));\nconst UserManagement = lazy(() => import(\"./pages/UserManagement\"));\nconst UserProfile = lazy(() => import(\"./pages/UserProfile\"));\nconst TeamManagement = lazy(() => import(\"./pages/TeamManagement\"));\nconst ProjectTeam = lazy(() => import(\"./pages/ProjectTeam\"));\nconst MyTasks = lazy(() => import(\"./pages/MyTasks\"));\nconst Archive = lazy(() => import(\"./pages/Archive\"));\nconst ArchiveRules = lazy(() => import(\"./pages/ArchiveRules\"));\nconst NotificationSettings = lazy(() => import(\"./pages/NotificationSettings\"));\nconst SystemMonitoring = lazy(() => import(\"./pages/SystemMonitoring\"));\nconst InspectionHistory = lazy(() => import(\"./pages/InspectionHistory\"));\nconst InspectionDetail = lazy(() => import(\"./pages/InspectionDetail\"));\nconst AlertSettings = lazy(() => import(\"./pages/AlertSettings\"));\nconst AdvancedAnalytics = lazy(() => import(\"./pages/AdvancedAnalytics\"));\nconst SystemOverview = lazy(() => import(\"./pages/SystemOverview\"));\nconst GanttChartPage = lazy(() => import(\"./pages/GanttChartPage\"));\nconst BulkUserImport = lazy(() => import(\"./pages/BulkUserImport\"));\nconst PermissionsManagement = lazy(() => import(\"./pages/PermissionsManagement\"));\nconst EscalationSettings = lazy(() => import(\"./pages/EscalationSettings\"));\nconst EscalationLogs = lazy(() => import(\"./pages/EscalationLogs\"));\nconst UserActivityLog = lazy(() => import(\"./pages/UserActivityLog\"));\nconst RoleTemplates = lazy(() => import(\"./pages/RoleTemplates\"));\nconst InspectionStatistics = lazy(() => import(\"./pages/InspectionStatistics\"));\nconst ErrorTracking = lazy(() => import(\"./pages/ErrorTracking\"));\nconst Inspections = lazy(() => import(\"./pages/Inspections\"));\nconst NewTemplate = lazy(() => import(\"./pages/NewTemplate\"));\n\n\n// Loading component\nconst PageLoader = () => (\n  <div className=\"flex items-center justify-center min-h-screen\">\n    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n  </div>\n);\n\nfunction Router() {\n  return (\n    <Suspense fallback={<PageLoader />}>\n    <Switch>\n      <Route path={\"/\"} component={Home} />\n      <Route path={\"/login-demo\"} component={LoginDemo} />\n      <Route path={\"/tasks/new\"}>\n        {() => (\n          <DashboardLayout>\n            <NewTask />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/projects/new\"}>\n        {() => (\n          <DashboardLayout>\n            <NewProject />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/system-overview\"}>\n        {() => (\n          <DashboardLayout>\n            <SystemOverview />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/advanced-analytics\"}>\n        {() => (\n          <DashboardLayout>\n            <AdvancedAnalytics />\n          </DashboardLayout>\n        )}\n      </Route>\n\n      <Route path={\"/overview\"}>\n        {() => (\n          <DashboardLayout>\n            <Overview />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/dashboard\"}>\n        {() => (\n          <DashboardLayout>\n            <Dashboard />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/dashboard-old\"}>\n        {() => (\n          <DashboardLayout>\n            <NewDashboard />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/projects\"}>\n        {() => (\n          <DashboardLayout>\n            <PageErrorBoundary\n              pageName=\"Projects\"\n              fallbackPath=\"/dashboard\"\n            >\n              <Projects />\n            </PageErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/tasks\"}>\n        {() => (\n          <DashboardLayout>\n            <PageErrorBoundary\n              pageName=\"Tasks\"\n              fallbackPath=\"/dashboard\"\n            >\n              <Tasks />\n            </PageErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/qc\"}>\n        {() => (\n          <DashboardLayout>\n            <PageErrorBoundary\n              pageName=\"QCInspection\"\n              fallbackPath=\"/dashboard\"\n            >\n              <QCInspection />\n            </PageErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/qc-inspection\"}>\n        {() => (\n          <DashboardLayout>\n            <PageErrorBoundary\n              pageName=\"QCInspection\"\n              fallbackPath=\"/dashboard\"\n            >\n              <QCInspection />\n            </PageErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/inspections\"}>\n        {() => (\n          <DashboardLayout>\n            <PageErrorBoundary\n              pageName=\"Inspections\"\n              fallbackPath=\"/dashboard\"\n            >\n              <Inspections />\n            </PageErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/checklist-templates\"}>\n        {() => (\n          <DashboardLayout>\n            <ChecklistTemplates />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/templates/new\"}>\n        {() => (\n          <DashboardLayout>\n            <NewTemplate />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/templates\"}>\n        {() => (\n          <DashboardLayout>\n            <Templates />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/defects/:id\"}>\n        {() => (\n          <DashboardLayout>\n            <DefectDetailErrorBoundary\n              onGoBack={() => window.location.href = \"/defects\"}\n              onReset={() => window.location.reload()}\n            >\n              <DefectDetail />\n            </DefectDetailErrorBoundary>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/defects\"}>\n        {() => (\n          <DashboardLayout>\n            <Defects />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/notifications\"}>\n        {() => (\n          <DashboardLayout>\n            <NotificationCenter />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/projects/:id\"}>\n        {() => (\n          <DashboardLayout>\n            <ProjectDetail />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/tasks/:taskId/inspections\">\n        {() => (\n          <DashboardLayout>\n            <InspectionHistory />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/inspections/:inspectionId\">\n        {() => (\n          <DashboardLayout>\n            <InspectionDetail />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/tasks/:id\"}>\n        {() => (\n          <DashboardLayout>\n            <TaskDetail />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/settings\"}>\n        {() => (\n          <DashboardLayout>\n            <Settings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/settings/notifications\"}>\n        {() => (\n          <DashboardLayout>\n            <NotificationSettings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/user-management\">\n        {() => (\n          <DashboardLayout>\n            <UserManagement />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/bulk-user-import\">\n        {() => (\n          <DashboardLayout>\n            <BulkUserImport />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/permissions-management\">\n        {() => (\n          <DashboardLayout>\n            <PermissionsManagement />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/escalation-settings\">\n        {() => (\n          <DashboardLayout>\n            <EscalationSettings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/escalation-logs\">\n        {() => (\n          <DashboardLayout>\n            <EscalationLogs />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/user-activity-log\">\n        {() => (\n          <DashboardLayout>\n            <UserActivityLog />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/role-templates\">\n        {() => (\n          <DashboardLayout>\n            <RoleTemplates />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/users\"}>\n        {() => (\n          <DashboardLayout>\n            <UserManagement />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/team\"}>\n        {() => (\n          <DashboardLayout>\n            <TeamManagement />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/my-tasks\"}>\n        {() => (\n          <DashboardLayout>\n            <MyTasks />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/projects/:projectId/team\"}>\n        {() => (\n          <DashboardLayout>\n            <ProjectTeam />\n          </DashboardLayout>\n        )}\n      </Route>\n\n      <Route path={\"/profile\"}>\n        {() => (\n          <DashboardLayout>\n            <UserProfile />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/reports\"}>\n        {() => (\n          <DashboardLayout>\n            <Reports />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/analytics\"}>\n        {() => (\n          <DashboardLayout>\n            <Analytics />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/inspection-statistics\"}>\n        {() => (\n          <DashboardLayout>\n            <InspectionStatistics />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/error-tracking\"}>\n        {() => (\n          <DashboardLayout>\n            <ErrorTracking />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/archive\"}>\n        {() => (\n          <DashboardLayout>\n            <Archive />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/archive/rules\"}>\n        {() => (\n          <DashboardLayout>\n            <ArchiveRules />\n          </DashboardLayout>\n        )}\n      </Route>\n      {/* System Monitoring -  DB, System, Memory  */}\n      <Route path={\"/system-monitoring\"}>\n        {() => (\n          <DashboardLayout>\n            <SystemMonitoring />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/alert-settings\"}>\n        {() => (\n          <DashboardLayout>\n            <AlertSettings />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/gantt\"}>\n        {() => (\n          <DashboardLayout>\n            <GanttChartPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      {/* Legacy routes - redirect to new unified page */}\n      <Route path={\"/ceo-dashboard\"}>\n        {() => {\n          // Redirect to new dashboard\n          window.location.href = '/dashboard';\n          return null;\n        }}\n      </Route>\n      <Route path={\"/monitoring\"}>\n        {() => (\n          <DashboardLayout>\n            <SystemMonitoring />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/system-monitor\"}>\n        {() => (\n          <DashboardLayout>\n            <SystemMonitoring />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/memory-monitoring\"}>\n        {() => (\n          <DashboardLayout>\n            <SystemMonitoring />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path={\"/404\"} component={NotFound} />\n      {/* Final fallback route */}\n      <Route component={NotFound} />\n    </Switch>\n    </Suspense>\n  );\n}\n\nfunction App() {\n  return (\n    <ErrorBoundary>\n      <ThemeProvider defaultTheme=\"light\" switchable>\n        <TooltipProvider>\n          <Toaster />\n          <PWAInstallBanner />\n          <Router />\n        </TooltipProvider>\n      </ThemeProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n",
    "client/src/pages/Dashboard.tsx": "import { useAuth } from \"@/_core/hooks/useAuth\";\nimport { trpc } from \"@/lib/trpc\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Activity,\n  AlertCircle,\n  AlertTriangle,\n  ArrowRight,\n  BarChart3,\n  CheckCircle2,\n  Clock,\n  TrendingUp,\n  TrendingDown,\n  Users,\n  Target,\n  Calendar,\n  FileCheck,\n  XCircle,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { useMemo } from \"react\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { th } from \"date-fns/locale\";\n\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Progress } from \"@/components/ui/progress\";\n\n/**\n * Enhanced Dashboard - Construction Management & QC Platform\n * \n * New Widgets:\n * - Project Timeline Overview (on track, at risk, behind schedule)\n * - Team Performance Metrics (completion rate, on-time rate)\n * - QC Status Summary (inspections, defects)\n * - Recent Activities (enhanced with project/task names)\n */\nexport default function Dashboard() {\n  const { user } = useAuth();\n\n  // Fetch enhanced dashboard data\n  const { data: timelineData, isLoading: timelineLoading, error: timelineError } = trpc.dashboard.getProjectTimelineOverview.useQuery();\n  const { data: teamData, isLoading: teamLoading, error: teamError } = trpc.dashboard.getTeamPerformanceMetrics.useQuery();\n  const { data: qcData, isLoading: qcLoading, error: qcError } = trpc.dashboard.getQCStatusSummary.useQuery();\n  const { data: activities = [], isLoading: activitiesLoading, error: activitiesError } = trpc.dashboard.getRecentActivities.useQuery({ limit: 15 });\n  const { data: statsData, isLoading: statsLoading, error: statsError } = trpc.dashboard.getStats.useQuery();\n\n  // Debug logging\n  console.log('[Dashboard] Timeline:', { data: timelineData, loading: timelineLoading, error: timelineError });\n  console.log('[Dashboard] Team:', { data: teamData, loading: teamLoading, error: teamError });\n  console.log('[Dashboard] QC:', { data: qcData, loading: qcLoading, error: qcError });\n  console.log('[Dashboard] Activities:', { count: activities.length, loading: activitiesLoading, error: activitiesError });\n  console.log('[Dashboard] Stats:', { data: statsData, loading: statsLoading, error: statsError });\n\n  // Calculate overview stats\n  const overviewStats = useMemo(() => {\n    if (!statsData) return null;\n    \n    return {\n      projects: {\n        total: statsData.projectStats.total,\n        active: statsData.projectStats.active,\n        onTrack: statsData.projectStats.on_track,\n        delayed: statsData.projectStats.delayed,\n        overdue: statsData.projectStats.overdue,\n      },\n      tasks: {\n        total: statsData.taskStats.total,\n        completed: statsData.taskStats.completed,\n        inProgress: statsData.taskStats.in_progress,\n        delayed: statsData.taskStats.delayed,\n      },\n      inspections: {\n        total: statsData.checklistStats.total,\n        pending: statsData.checklistStats.pending_inspection,\n        completed: statsData.checklistStats.completed,\n        failed: statsData.checklistStats.failed,\n      },\n      defects: {\n        total: statsData.defectStats?.total || 0,\n        open: statsData.defectStats?.open || 0,\n        critical: statsData.defectStats?.overdue || 0,\n      },\n    };\n  }, [statsData]);\n\n  // Get timeline status color\n  const getTimelineStatusColor = (status: string) => {\n    switch (status) {\n      case 'on_track': return 'text-green-600 bg-green-50';\n      case 'at_risk': return 'text-amber-600 bg-amber-50';\n      case 'behind_schedule': return 'text-red-600 bg-red-50';\n      default: return 'text-slate-600 bg-slate-50';\n    }\n  };\n\n  // Get timeline status label\n  const getTimelineStatusLabel = (status: string) => {\n    switch (status) {\n      case 'on_track': return '';\n      case 'at_risk': return '';\n      case 'behind_schedule': return '';\n      default: return '';\n    }\n  };\n\n  // Get activity icon\n  const getActivityIcon = (action: string) => {\n    if (action.includes('') || action.includes('created')) return <CheckCircle2 className=\"w-4 h-4\" />;\n    if (action.includes('') || action.includes('updated')) return <Activity className=\"w-4 h-4\" />;\n    if (action.includes('') || action.includes('deleted')) return <XCircle className=\"w-4 h-4\" />;\n    if (action.includes('') || action.includes('inspected')) return <FileCheck className=\"w-4 h-4\" />;\n    return <Activity className=\"w-4 h-4\" />;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n        {/* Header */}\n        <div>\n          <h1 className=\"text-3xl font-bold text-slate-900\"></h1>\n          <p className=\"text-slate-600 mt-1\"></p>\n        </div>\n\n        {/* Overview Cards */}\n        {statsLoading ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {[1, 2, 3, 4].map(i => (\n              <Card key={i}>\n                <CardHeader className=\"pb-3\">\n                  <Skeleton className=\"h-4 w-24\" />\n                </CardHeader>\n                <CardContent>\n                  <Skeleton className=\"h-8 w-16 mb-2\" />\n                  <Skeleton className=\"h-3 w-32\" />\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : overviewStats ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {/* Projects Card */}\n            <Card className=\"hover:shadow-md transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"text-sm font-medium text-slate-600\"></CardTitle>\n                  <Target className=\"w-5 h-5 text-blue-600\" />\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-slate-900\">{overviewStats.projects.total}</div>\n                <div className=\"flex items-center gap-2 mt-2 text-sm\">\n                  <Badge variant=\"outline\" className=\"text-green-600 border-green-200\">\n                    {overviewStats.projects.onTrack} \n                  </Badge>\n                  {overviewStats.projects.delayed > 0 && (\n                    <Badge variant=\"outline\" className=\"text-amber-600 border-amber-200\">\n                      {overviewStats.projects.delayed} \n                    </Badge>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Tasks Card */}\n            <Card className=\"hover:shadow-md transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"text-sm font-medium text-slate-600\"></CardTitle>\n                  <BarChart3 className=\"w-5 h-5 text-purple-600\" />\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-slate-900\">{overviewStats.tasks.total}</div>\n                <div className=\"flex items-center gap-2 mt-2 text-sm\">\n                  <span className=\"text-green-600\">{overviewStats.tasks.completed} </span>\n                  <span className=\"text-slate-400\"></span>\n                  <span className=\"text-blue-600\">{overviewStats.tasks.inProgress} </span>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Inspections Card */}\n            <Card className=\"hover:shadow-md transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"text-sm font-medium text-slate-600\"></CardTitle>\n                  <FileCheck className=\"w-5 h-5 text-teal-600\" />\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-slate-900\">{overviewStats.inspections.total}</div>\n                <div className=\"flex items-center gap-2 mt-2 text-sm\">\n                  <span className=\"text-green-600\">{overviewStats.inspections.completed} </span>\n                  <span className=\"text-slate-400\"></span>\n                  <span className=\"text-amber-600\">{overviewStats.inspections.pending} </span>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Defects Card */}\n            <Card className=\"hover:shadow-md transition-shadow\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"text-sm font-medium text-slate-600\"></CardTitle>\n                  <AlertCircle className=\"w-5 h-5 text-red-600\" />\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-slate-900\">{overviewStats.defects.open}</div>\n                <div className=\"flex items-center gap-2 mt-2 text-sm\">\n                  {overviewStats.defects.critical > 0 && (\n                    <Badge variant=\"destructive\" className=\"text-xs\">\n                      {overviewStats.defects.critical} \n                    </Badge>\n                  )}\n                  <span className=\"text-slate-600\"> {overviewStats.defects.total}</span>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        ) : null}\n\n        {/* Main Content Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Project Timeline Overview */}\n          <Card className=\"lg:col-span-1\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Calendar className=\"w-5 h-5 text-blue-600\" />\n                    \n                  </CardTitle>\n                  <CardDescription></CardDescription>\n                </div>\n                <Link href=\"/projects\">\n                  <Button variant=\"ghost\" size=\"sm\">\n                     <ArrowRight className=\"w-4 h-4 ml-1\" />\n                  </Button>\n                </Link>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {timelineLoading ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map(i => (\n                    <div key={i} className=\"space-y-2\">\n                      <Skeleton className=\"h-4 w-full\" />\n                      <Skeleton className=\"h-2 w-full\" />\n                    </div>\n                  ))}\n                </div>\n              ) : timelineData && timelineData.summary.total > 0 ? (\n                <div className=\"space-y-4\">\n                  {/* Summary */}\n                  <div className=\"grid grid-cols-3 gap-3\">\n                    <div className=\"text-center p-3 bg-green-50 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-green-600\">{timelineData.summary.onTrack}</div>\n                      <div className=\"text-xs text-green-700 mt-1\"></div>\n                    </div>\n                    <div className=\"text-center p-3 bg-amber-50 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-amber-600\">{timelineData.summary.atRisk}</div>\n                      <div className=\"text-xs text-amber-700 mt-1\"></div>\n                    </div>\n                    <div className=\"text-center p-3 bg-red-50 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-red-600\">{timelineData.summary.behindSchedule}</div>\n                      <div className=\"text-xs text-red-700 mt-1\"></div>\n                    </div>\n                  </div>\n\n                  {/* Project List */}\n                  <div className=\"space-y-3 max-h-[300px] overflow-y-auto\">\n                    {timelineData.projects.slice(0, 5).map((project) => (\n                      <div key={project.id} className=\"border rounded-lg p-3 hover:bg-slate-50 transition-colors\">\n                        <div className=\"flex items-start justify-between mb-2\">\n                          <div className=\"flex-1\">\n                            <Link href={`/projects/${project.id}`}>\n                              <h4 className=\"font-medium text-slate-900 hover:text-blue-600 transition-colors\">\n                                {project.name}\n                              </h4>\n                            </Link>\n                            <div className=\"flex items-center gap-2 mt-1\">\n                              <Badge className={getTimelineStatusColor(project.timelineStatus)}>\n                                {getTimelineStatusLabel(project.timelineStatus)}\n                              </Badge>\n                              <span className=\"text-xs text-slate-500\">\n                                 {project.daysRemaining} \n                              </span>\n                            </div>\n                          </div>\n                          <div className=\"text-right\">\n                            <div className=\"text-lg font-bold text-slate-900\">{Math.round(project.progress)}%</div>\n                            <div className=\"text-xs text-slate-500\"></div>\n                          </div>\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Progress value={project.progress} className=\"h-2\" />\n                          <div className=\"flex justify-between text-xs text-slate-500\">\n                            <span></span>\n                            <span> {Math.round(project.expectedProgress)}%</span>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  <Calendar className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p></p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Team Performance Metrics */}\n          <Card className=\"lg:col-span-1\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Users className=\"w-5 h-5 text-purple-600\" />\n                    \n                  </CardTitle>\n                  <CardDescription></CardDescription>\n                </div>\n                <Link href=\"/admin/users\">\n                  <Button variant=\"ghost\" size=\"sm\">\n                     <ArrowRight className=\"w-4 h-4 ml-1\" />\n                  </Button>\n                </Link>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {teamLoading ? (\n                <div className=\"space-y-4\">\n                  {[1, 2, 3].map(i => (\n                    <Skeleton key={i} className=\"h-16 w-full\" />\n                  ))}\n                </div>\n              ) : teamData && teamData.summary.teamSize > 0 ? (\n                <div className=\"space-y-4\">\n                  {/* Team Summary */}\n                  <div className=\"grid grid-cols-2 gap-3 p-4 bg-slate-50 rounded-lg\">\n                    <div>\n                      <div className=\"text-sm text-slate-600\"></div>\n                      <div className=\"text-2xl font-bold text-slate-900\">{teamData.summary.avgCompletionRate}%</div>\n                    </div>\n                    <div>\n                      <div className=\"text-sm text-slate-600\"></div>\n                      <div className=\"text-2xl font-bold text-slate-900\">{teamData.summary.avgOnTimeRate}%</div>\n                    </div>\n                  </div>\n\n                  {/* Top Performers */}\n                  <div className=\"space-y-3 max-h-[300px] overflow-y-auto\">\n                    {teamData.members.slice(0, 5).map((member) => (\n                      <div key={member.userId} className=\"border rounded-lg p-3 hover:bg-slate-50 transition-colors\">\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-medium text-sm\">\n                              {member.userName.charAt(0).toUpperCase()}\n                            </div>\n                            <div>\n                              <div className=\"font-medium text-slate-900\">{member.userName}</div>\n                              <div className=\"text-xs text-slate-500\">{member.role}</div>\n                            </div>\n                          </div>\n                          <div className=\"text-right\">\n                            <div className=\"flex items-center gap-1\">\n                              {member.completionRate >= 80 ? (\n                                <TrendingUp className=\"w-4 h-4 text-green-600\" />\n                              ) : (\n                                <TrendingDown className=\"w-4 h-4 text-amber-600\" />\n                              )}\n                              <span className=\"font-bold text-slate-900\">{member.completionRate}%</span>\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-3 gap-2 text-xs\">\n                          <div className=\"text-center p-2 bg-blue-50 rounded\">\n                            <div className=\"font-bold text-blue-600\">{member.totalTasks}</div>\n                            <div className=\"text-blue-700\"></div>\n                          </div>\n                          <div className=\"text-center p-2 bg-green-50 rounded\">\n                            <div className=\"font-bold text-green-600\">{member.completedTasks}</div>\n                            <div className=\"text-green-700\"></div>\n                          </div>\n                          <div className=\"text-center p-2 bg-blue-50 rounded\">\n                            <div className=\"font-bold text-blue-600\">{member.inProgressTasks}</div>\n                            <div className=\"text-blue-700\"></div>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  <Users className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p></p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* QC Status Summary */}\n          <Card className=\"lg:col-span-1\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <FileCheck className=\"w-5 h-5 text-teal-600\" />\n                     QC\n                  </CardTitle>\n                  <CardDescription></CardDescription>\n                </div>\n                <Link href=\"/inspections\">\n                  <Button variant=\"ghost\" size=\"sm\">\n                     <ArrowRight className=\"w-4 h-4 ml-1\" />\n                  </Button>\n                </Link>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {qcLoading ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-32 w-full\" />\n                  <Skeleton className=\"h-32 w-full\" />\n                </div>\n              ) : qcData ? (\n                <div className=\"space-y-4\">\n                  {/* Inspections */}\n                  <div className=\"border rounded-lg p-4\">\n                    <h4 className=\"font-medium text-slate-900 mb-3\"></h4>\n                    <div className=\"grid grid-cols-2 gap-3 mb-3\">\n                      <div className=\"text-center p-3 bg-green-50 rounded-lg\">\n                        <div className=\"text-2xl font-bold text-green-600\">{qcData.inspections.passed}</div>\n                        <div className=\"text-xs text-green-700 mt-1\"></div>\n                      </div>\n                      <div className=\"text-center p-3 bg-red-50 rounded-lg\">\n                        <div className=\"text-2xl font-bold text-red-600\">{qcData.inspections.failed}</div>\n                        <div className=\"text-xs text-red-700 mt-1\"></div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-slate-600\"></span>\n                      <span className=\"font-bold text-slate-900\">{qcData.inspections.passRate}%</span>\n                    </div>\n                    <Progress value={qcData.inspections.passRate} className=\"h-2 mt-2\" />\n                    <div className=\"mt-2 text-xs text-slate-500\">\n                      : {qcData.inspections.pending} \n                    </div>\n                  </div>\n\n                  {/* Defects */}\n                  <div className=\"border rounded-lg p-4\">\n                    <h4 className=\"font-medium text-slate-900 mb-3\"></h4>\n                    <div className=\"grid grid-cols-3 gap-2 mb-3\">\n                      <div className=\"text-center p-2 bg-red-50 rounded\">\n                        <div className=\"text-xl font-bold text-red-600\">{qcData.defects.critical}</div>\n                        <div className=\"text-xs text-red-700 mt-1\"></div>\n                      </div>\n                      <div className=\"text-center p-2 bg-amber-50 rounded\">\n                        <div className=\"text-xl font-bold text-amber-600\">{qcData.defects.high}</div>\n                        <div className=\"text-xs text-amber-700 mt-1\"></div>\n                      </div>\n                      <div className=\"text-center p-2 bg-yellow-50 rounded\">\n                        <div className=\"text-xl font-bold text-yellow-600\">{qcData.defects.medium}</div>\n                        <div className=\"text-xs text-yellow-700 mt-1\"></div>\n                      </div>\n                      <div className=\"text-center p-2 bg-blue-50 rounded\">\n                        <div className=\"text-xl font-bold text-blue-600\">{qcData.defects.low}</div>\n                        <div className=\"text-xs text-blue-700 mt-1\"></div>\n                      </div>\n                    </div>\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-slate-600\"> (30 )</span>\n                        <span className=\"font-medium text-green-600\">{qcData.defects.resolvedLast30Days}</span>\n                      </div>\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-slate-600\"></span>\n                        <span className=\"font-medium text-slate-900\">{qcData.defects.avgResolutionTime} </span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  <FileCheck className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p> QC</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Recent Activities */}\n          <Card className=\"lg:col-span-1\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Activity className=\"w-5 h-5 text-indigo-600\" />\n                    \n                  </CardTitle>\n                  <CardDescription></CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {activitiesLoading ? (\n                <div className=\"space-y-3\">\n                  {[1, 2, 3, 4, 5].map(i => (\n                    <div key={i} className=\"flex items-start gap-3\">\n                      <Skeleton className=\"w-8 h-8 rounded-full\" />\n                      <div className=\"flex-1 space-y-2\">\n                        <Skeleton className=\"h-4 w-full\" />\n                        <Skeleton className=\"h-3 w-24\" />\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : activities.length > 0 ? (\n                <div className=\"space-y-3 max-h-[400px] overflow-y-auto\">\n                  {activities.map((activity) => (\n                    <div key={activity.id} className=\"flex items-start gap-3 p-2 hover:bg-slate-50 rounded-lg transition-colors\">\n                      <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white flex-shrink-0\">\n                        {getActivityIcon(activity.action)}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm text-slate-900\">\n                              <span className=\"font-medium\">{activity.userName || ''}</span>\n                              {' '}\n                              <span className=\"text-slate-600\">{activity.action}</span>\n                            </p>\n                            {activity.projectName && (\n                              <p className=\"text-xs text-slate-500 mt-1\">\n                                : {activity.projectName}\n                                {activity.taskName && `  : ${activity.taskName}`}\n                              </p>\n                            )}\n                          </div>\n                          <Tooltip>\n                            <TooltipTrigger>\n                              <span className=\"text-xs text-slate-400 whitespace-nowrap\">\n                                {formatDistanceToNow(new Date(activity.createdAt), { addSuffix: true, locale: th })}\n                              </span>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              {format(new Date(activity.createdAt), 'PPpp', { locale: th })}\n                            </TooltipContent>\n                          </Tooltip>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  <Activity className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p></p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n    </div>\n  );\n}\n",
    "client/src/pages/Tasks.tsx": "import { useState } from \"react\";\nimport { trpc } from \"@/lib/trpc\";\nimport { QueryErrorBoundary } from \"@/components/QueryErrorBoundary\";\nimport { LoadingState } from \"@/components/LoadingState\";\nimport { EmptyState } from \"@/components/EmptyState\";\nimport { usePermissions } from \"@/hooks/usePermissions\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/StatusBadge\";\nimport { ProgressBar } from \"@/components/ProgressBar\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Loader2, Calendar, User, Building2, CheckSquare, X, PieChart as PieChartIcon, Flag, Tag } from \"lucide-react\";\nimport { TaskCardSkeleton } from \"@/components/skeletons\";\nimport { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from \"@/components/LazyChart\";\nimport { SearchBar } from \"@/components/SearchBar\";\nimport { FilterBar, FilterOptions } from \"@/components/FilterBar\";\nimport { Link } from \"wouter\";\nimport {\n  Pagination,\n  PaginationContent,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n} from \"@/components/ui/pagination\";\nimport FloatingActionButton from \"@/components/FloatingActionButton\";\nimport NewTaskDialog from \"@/components/NewTaskDialog\";\nimport { SwipeableCard } from \"@/components/SwipeableCard\";\nimport { PullToRefresh } from \"@/components/PullToRefresh\";\nimport { Plus, Edit, Trash2, CheckCircle, Download, FileText } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { parseDate } from \"@/lib/dateUtils\";\nimport { useLocation } from \"wouter\";\nimport { exportTasksToExcel } from \"@/lib/excelExport\";\nimport { ExportButton } from \"@/components/ExportButton\";\n\nexport default function Tasks() {\n  const { canCreate, canEdit } = usePermissions('tasks');\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [filters, setFilters] = useState<FilterOptions>({});\n  const [displayStatusFilter, setDisplayStatusFilter] = useState<string>(\"all\");\n  const [projectFilter, setProjectFilter] = useState<number | undefined>(undefined);\n  const [assigneeFilter, setAssigneeFilter] = useState<number | undefined>(undefined);\n  const [selectedTasks, setSelectedTasks] = useState<Set<number>>(new Set());\n  const [showBulkStatusDialog, setShowBulkStatusDialog] = useState(false);\n  const [showBulkAssignDialog, setShowBulkAssignDialog] = useState(false);\n  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);\n  const [bulkStatus, setBulkStatus] = useState<string>(\"\");\n  const [bulkAssignee, setBulkAssignee] = useState<string>(\"\");\n  const [showNewTaskDialog, setShowNewTaskDialog] = useState(false);\n  const [currentPage, setCurrentPage] = useState(1);\n  const [pageSize, setPageSize] = useState(25);\n\n  // Use search query with filters\n  const searchQuery = trpc.task.search.useQuery({\n    query: searchTerm,\n    projectId: projectFilter,\n    status: displayStatusFilter !== 'all' ? displayStatusFilter : undefined,\n    assigneeId: assigneeFilter,\n  });\n  \n  const myTasksQuery = trpc.task.myTasks.useQuery();\n  const allTasksQuery = trpc.task.list.useQuery({ page: currentPage, pageSize });\n  const projectsQuery = trpc.project.list.useQuery({});\n  const utils = trpc.useUtils();\n  \n  const handleRefresh = async () => {\n    await searchQuery.refetch();\n    await utils.task.myTasks.invalidate();\n  };\n\n  const bulkUpdateStatusMutation = trpc.task.bulkUpdateStatus.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.updated}/${data.total} `);\n      setSelectedTasks(new Set());\n      setShowBulkStatusDialog(false);\n      utils.task.myTasks.invalidate();\n    },\n    onError: (error) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  const bulkAssignMutation = trpc.task.bulkAssign.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.assigned}/${data.total} `);\n      setSelectedTasks(new Set());\n      setShowBulkAssignDialog(false);\n      utils.task.myTasks.invalidate();\n    },\n    onError: (error) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  const bulkDeleteMutation = trpc.task.bulkDelete.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.deletedCount} `);\n      setSelectedTasks(new Set());\n      setShowBulkDeleteDialog(false);\n      utils.task.myTasks.invalidate();\n      searchQuery.refetch();\n    },\n    onError: (error) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  const [, navigate] = useLocation();\n\n  const updateTaskStatusMutation = trpc.task.update.useMutation({\n    onSuccess: () => {\n      toast.success('');\n      utils.task.myTasks.invalidate();\n    },\n    onError: (error: any) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  const deleteTaskMutation = trpc.task.delete.useMutation({\n    onSuccess: () => {\n      toast.success('');\n      utils.task.myTasks.invalidate();\n    },\n    onError: (error: any) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  const handleCompleteTask = (taskId: number) => {\n    updateTaskStatusMutation.mutate({ id: taskId, status: 'completed' });\n  };\n\n  const handleEditTask = (taskId: number) => {\n    navigate(`/tasks/${taskId}`);\n  };\n\n  const handleDeleteTask = (taskId: number) => {\n    if (confirm('?')) {\n      deleteTaskMutation.mutate({ id: taskId });\n    }\n  };\n\n  // Use search results if any filter is active, otherwise use paginated tasks\n  const hasActiveFilter = searchTerm || projectFilter || displayStatusFilter !== 'all' || assigneeFilter;\n  const tasks = hasActiveFilter ? (searchQuery.data || []) : (allTasksQuery.data?.items || []);\n  const pagination = !hasActiveFilter ? allTasksQuery.data?.pagination : undefined;\n  const projects = projectsQuery.data?.items || [];\n  \n  // Extract unique assignees from tasks\n  const members = Array.from(\n    new Map(\n      tasks\n        .filter((t: any) => t.assigneeId && t.assigneeName)\n        .map((t: any) => [t.assigneeId, { userId: t.assigneeId, userName: t.assigneeName }])\n    ).values()\n  );\n\n  // Tasks are already filtered by the search query\n  const filteredTasks = tasks;\n\n  const stats = {\n    total: tasks.length,\n    not_started: tasks.filter((t: any) => (t as any).displayStatus === \"not_started\").length,\n    in_progress: tasks.filter((t: any) => (t as any).displayStatus === \"in_progress\").length,\n    delayed: tasks.filter((t: any) => (t as any).displayStatus === \"delayed\").length,\n    completed: tasks.filter((t: any) => (t as any).displayStatus === \"completed\").length,\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"completed\":\n        return \"bg-green-100 text-green-800\";\n      case \"in_progress\":\n        return \"bg-blue-100 text-blue-800\";\n      case \"pending_pre_inspection\":\n      case \"pending_final_inspection\":\n        return \"bg-yellow-100 text-yellow-800\";\n      case \"rectification_needed\":\n        return \"bg-red-100 text-red-800\";\n      case \"ready_to_start\":\n        return \"bg-purple-100 text-purple-800\";\n      default:\n        return \"bg-gray-100 text-gray-800\";\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    return status.split(\"_\").map((word) => word.charAt(0).toUpperCase() + word.slice(1)).join(\" \");\n  };\n\n  const toggleTaskSelection = (taskId: number) => {\n    const newSelection = new Set(selectedTasks);\n    if (newSelection.has(taskId)) {\n      newSelection.delete(taskId);\n    } else {\n      newSelection.add(taskId);\n    }\n    setSelectedTasks(newSelection);\n  };\n\n  const selectAllTasks = () => {\n    if (selectedTasks.size === filteredTasks.length) {\n      setSelectedTasks(new Set());\n    } else {\n      setSelectedTasks(new Set(filteredTasks.map((t: any) => t.id)));\n    }\n  };\n\n  const handleBulkUpdateStatus = () => {\n    if (!bulkStatus) {\n      toast.error(\"\");\n      return;\n    }\n    bulkUpdateStatusMutation.mutate({\n      taskIds: Array.from(selectedTasks),\n      status: bulkStatus as any,\n    });\n  };\n\n  const handleBulkAssign = () => {\n    if (!bulkAssignee) {\n      toast.error(\"\");\n      return;\n    }\n    bulkAssignMutation.mutate({\n      taskIds: Array.from(selectedTasks),\n      assigneeId: parseInt(bulkAssignee),\n    });\n  };\n\n  const handleBulkDelete = () => {\n    bulkDeleteMutation.mutate({\n      taskIds: Array.from(selectedTasks),\n    });\n  };\n\n  if (myTasksQuery.isLoading) {\n    return (\n      <div className=\"container mx-auto py-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold text-gray-900\"></h1>\n          <div className=\"flex items-center gap-2\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-gray-400\" />\n          </div>\n        </div>\n        <TaskCardSkeleton />\n      </div>\n    );\n  }\n\n  return (\n    <PullToRefresh onRefresh={handleRefresh}>\n      <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">My Tasks</h1>\n          <p className=\"text-gray-600 mt-1\">View tasks from your projects</p>\n        </div>\n      </div>\n\n      {/* Bulk Action Toolbar */}\n      {selectedTasks.size > 0 && canEdit && (\n        <Card className=\"bg-blue-50 border-blue-200\">\n          <CardContent className=\"flex items-center justify-between py-4\">\n            <div className=\"flex items-center gap-3\">\n              <CheckSquare className=\"w-5 h-5 text-blue-600\" />\n              <span className=\"font-medium text-blue-900\">\n                 {selectedTasks.size} \n              </span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowBulkStatusDialog(true)}\n              >\n                \n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowBulkAssignDialog(true)}\n              >\n                \n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowBulkDeleteDialog(true)}\n                className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-1\" />\n                \n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setSelectedTasks(new Set())}\n              >\n                <X className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Search and Filter - Sticky */}\n      <div className=\"sticky top-0 z-10 bg-white dark:bg-gray-900 py-4 -mt-4 mb-2 shadow-sm space-y-4\">\n        <div className=\"flex flex-col md:flex-row items-start md:items-center gap-4\">\n          <SearchBar\n            placeholder=\"...\"\n            onSearch={setSearchTerm}\n            className=\"w-full md:max-w-md\"\n          />\n        </div>\n        \n        {/* Filter Controls */}\n        <div className=\"flex flex-col md:flex-row gap-3\">\n          {/* Project Filter */}\n          <div className=\"flex-1\">\n            <Select\n              value={projectFilter?.toString() || \"all\"}\n              onValueChange={(value) => setProjectFilter(value === \"all\" ? undefined : parseInt(value))}\n            >\n              <SelectTrigger>\n                <SelectValue placeholder=\"\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\"></SelectItem>\n                {projects.map((project: any) => (\n                  <SelectItem key={project.id} value={project.id.toString()}>\n                    {project.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Status Filter */}\n          <div className=\"flex-1\">\n            <Select\n              value={displayStatusFilter}\n              onValueChange={setDisplayStatusFilter}\n            >\n              <SelectTrigger>\n                <SelectValue placeholder=\"\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\"></SelectItem>\n                <SelectItem value=\"not_started\"></SelectItem>\n                <SelectItem value=\"in_progress\"></SelectItem>\n                <SelectItem value=\"delayed\"></SelectItem>\n                <SelectItem value=\"completed\"></SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Assignee Filter */}\n          <div className=\"flex-1\">\n            <Select\n              value={assigneeFilter?.toString() || \"all\"}\n              onValueChange={(value) => setAssigneeFilter(value === \"all\" ? undefined : parseInt(value))}\n            >\n              <SelectTrigger>\n                <SelectValue placeholder=\"\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\"></SelectItem>\n                {members.map((member: any) => (\n                  <SelectItem key={member.userId} value={member.userId.toString()}>\n                    {member.userName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {canEdit && filteredTasks.length > 0 && (\n            <div className=\"flex items-center gap-2\">\n              <Checkbox\n                checked={selectedTasks.size === filteredTasks.length && filteredTasks.length > 0}\n                onCheckedChange={selectAllTasks}\n                className=\"border-2\"\n              />\n              <span className=\"text-sm text-muted-foreground\">\n                {selectedTasks.size === filteredTasks.length && filteredTasks.length > 0\n                  ? \"\"\n                  : \"\"}\n              </span>\n            </div>\n          )}\n          {filteredTasks.length > 0 && projectFilter && (\n            <>\n              <ExportButton projectId={projectFilter} />\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Task Overview Dashboard */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <PieChartIcon className=\"h-5 w-5\" />\n            <CardTitle>Task Overview</CardTitle>\n          </div>\n          <CardDescription></CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col md:flex-row items-center gap-8\">\n            {/* Pie Chart */}\n            <div className=\"w-full md:w-1/2 h-[300px]\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <PieChart>\n                  <Pie\n                    data={[\n                      { name: '', value: stats.not_started, color: '#9CA3AF' },\n                      { name: '', value: stats.in_progress, color: '#00366D' },\n                      { name: '', value: stats.delayed, color: '#EF4444' },\n                      { name: '', value: stats.completed, color: '#00CE81' },\n                    ]}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    labelLine={false}\n                    label={(entry: any) => entry.value > 0 ? `${entry.name} ${((entry.value / stats.total) * 100).toFixed(0)}%` : ''}\n                    outerRadius={100}\n                    fill=\"#8884d8\"\n                    dataKey=\"value\"\n                  >\n                    {[\n                      { name: '', value: stats.not_started, color: '#9CA3AF' },\n                      { name: '', value: stats.in_progress, color: '#00366D' },\n                      { name: '', value: stats.delayed, color: '#EF4444' },\n                      { name: '', value: stats.completed, color: '#00CE81' },\n                    ].map((entry, index: any) => (\n                      <Cell key={`cell-${index}`} fill={entry.color} />\n                    ))}\n                  </Pie>\n                  <Tooltip />\n                </PieChart>\n              </ResponsiveContainer>\n            </div>\n            \n            {/* Stat Cards */}\n            <div className=\"grid grid-cols-2 gap-4 w-full md:w-1/2\">\n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setDisplayStatusFilter(displayStatusFilter === 'not_started' ? 'all' : 'not_started')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-gray-600\">{stats.not_started}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setDisplayStatusFilter(displayStatusFilter === 'in_progress' ? 'all' : 'in_progress')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold\" style={{ color: '#00366D' }}>{stats.in_progress}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setDisplayStatusFilter(displayStatusFilter === 'delayed' ? 'all' : 'delayed')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-red-600\">{stats.delayed}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setDisplayStatusFilter(displayStatusFilter === 'completed' ? 'all' : 'completed')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold\" style={{ color: '#00CE81' }}>{stats.completed}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Old Task Overview Cards - Keep for backward compatibility but hide */}\n      <div className=\"hidden grid-cols-2 md:grid-cols-5 gap-4\">\n        <Card\n          className=\"cursor-pointer hover:shadow-md transition-shadow\"\n          onClick={() => setDisplayStatusFilter(\"all\")}\n        >\n          <CardHeader className=\"pb-3\">\n            <CardDescription></CardDescription>\n            <CardTitle className=\"text-3xl\">{stats.total}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div className=\"bg-gray-500 h-2 rounded-full transition-all\" style={{ width: \"100%\" }} />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card\n          className=\"cursor-pointer hover:shadow-md transition-shadow\"\n          onClick={() => setDisplayStatusFilter(\"not_started\")}\n        >\n          <CardHeader className=\"pb-3\">\n            <CardDescription></CardDescription>\n            <CardTitle className=\"text-3xl\">{stats.not_started}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div\n                className=\"bg-gray-400 h-2 rounded-full transition-all\"\n                style={{ width: `${stats.total > 0 ? (stats.not_started / stats.total) * 100 : 0}%` }}\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card\n          className=\"cursor-pointer hover:shadow-md transition-shadow\"\n          onClick={() => setDisplayStatusFilter(\"in_progress\")}\n        >\n          <CardHeader className=\"pb-3\">\n            <CardDescription className=\"flex items-center gap-1\">\n              <span className=\"text-[#00366D]\"></span> \n            </CardDescription>\n            <CardTitle className=\"text-3xl text-[#00366D]\">{stats.in_progress}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div\n                className=\"bg-[#00366D] h-2 rounded-full transition-all\"\n                style={{ width: `${stats.total > 0 ? (stats.in_progress / stats.total) * 100 : 0}%` }}\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card\n          className=\"cursor-pointer hover:shadow-md transition-shadow\"\n          onClick={() => setDisplayStatusFilter(\"delayed\")}\n        >\n          <CardHeader className=\"pb-3\">\n            <CardDescription className=\"flex items-center gap-1\">\n              <span className=\"text-red-600\"></span> \n            </CardDescription>\n            <CardTitle className=\"text-3xl text-red-600\">{stats.delayed}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div\n                className=\"bg-red-500 h-2 rounded-full transition-all\"\n                style={{ width: `${stats.total > 0 ? (stats.delayed / stats.total) * 100 : 0}%` }}\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card\n          className=\"cursor-pointer hover:shadow-md transition-shadow\"\n          onClick={() => setDisplayStatusFilter(\"completed\")}\n        >\n          <CardHeader className=\"pb-3\">\n            <CardDescription className=\"flex items-center gap-1\">\n              <span className=\"text-[#00CE81]\"></span> \n            </CardDescription>\n            <CardTitle className=\"text-3xl text-[#00CE81]\">{stats.completed}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"w-full bg-gray-200 rounded-full h-2\">\n              <div\n                className=\"bg-[#00CE81] h-2 rounded-full transition-all\"\n                style={{ width: `${stats.total > 0 ? (stats.completed / stats.total) * 100 : 0}%` }}\n              />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Clear Filter Button */}\n      {displayStatusFilter !== \"all\" && (\n        <div className=\"flex justify-center\">\n          <Button variant=\"outline\" onClick={() => setDisplayStatusFilter(\"all\")}>\n            \n          </Button>\n        </div>\n      )}\n\n      {/* Tasks List */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        {filteredTasks.map((task: any) => (\n          <div key={task.id} className=\"relative\">\n            {canEdit && (\n              <div className=\"absolute top-3 left-3 z-10\">\n                <Checkbox\n                  checked={selectedTasks.has(task.id)}\n                  onCheckedChange={() => toggleTaskSelection(task.id)}\n                  onClick={(e) => e.stopPropagation()}\n                  className=\"bg-white border-2\"\n                />\n              </div>\n            )}\n            <SwipeableCard\n              leftActions={[\n                {\n                  icon: <CheckCircle className=\"w-5 h-5\" />,\n                  label: '',\n                  color: 'bg-green-500',\n                  onAction: () => handleCompleteTask(task.id),\n                },\n              ]}\n              rightActions={[\n                {\n                  icon: <Edit className=\"w-5 h-5\" />,\n                  label: '',\n                  color: 'bg-blue-500',\n                  onAction: () => handleEditTask(task.id),\n                },\n                {\n                  icon: <Trash2 className=\"w-5 h-5\" />,\n                  label: '',\n                  color: 'bg-red-500',\n                  onAction: () => handleDeleteTask(task.id),\n                },\n              ]}\n            >\n              <Link href={`/tasks/${task.id}`}>\n                <Card className=\"hover:shadow-lg transition-shadow cursor-pointer h-full\">\n                  <CardHeader>\n                    <div className=\"flex justify-between items-start mb-2\">\n                      <CardTitle className={`text-lg ${canEdit ? 'ml-8' : ''}`}>{task.name}</CardTitle>\n                      <StatusBadge \n                        status={task.status}\n                        label={(task as any).displayStatusLabel || getStatusLabel(task.status)}\n                      />\n                    </div>\n                    {task.description && (\n                      <CardDescription className=\"line-clamp-2\">{task.description}</CardDescription>\n                    )}\n                  </CardHeader>\n                  <CardContent className=\"space-y-2.5\">\n                    {/* Project Name - Compact */}\n                    {task.projectName && (\n                      <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                        <Building2 className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                        <span className=\"truncate\">{task.projectName}</span>\n                      </div>\n                    )}\n\n                    {/* Progress Bar - Larger for visibility */}\n                    <ProgressBar \n                      value={task.progress}\n                      showLabel={true}\n                      size=\"sm\"\n                    />\n\n                    {/* Due Date - Show only end date for simplicity */}\n                    {task.endDate && (\n                      <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                        <Calendar className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                        <span>: {parseDate(task.endDate).toLocaleDateString('th-TH', { month: 'short', day: 'numeric', year: 'numeric' })}</span>\n                      </div>\n                    )}\n\n                    {/* Assignee - Compact */}\n                    {task.assigneeName && (\n                      <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                        <User className=\"w-3.5 h-3.5 flex-shrink-0\" />\n                        <span className=\"truncate\">{task.assigneeName}</span>\n                      </div>\n                    )}\n\n                    {/* Priority and Category Badges */}\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      {task.priority && (\n                        <div className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-xs ${\n                          task.priority === 'urgent' ? 'bg-red-100 text-red-700' :\n                          task.priority === 'high' ? 'bg-orange-100 text-orange-700' :\n                          task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :\n                          'bg-gray-100 text-gray-700'\n                        }`}>\n                          <Flag className=\"w-3 h-3\" />\n                          <span>\n                            {task.priority === 'urgent' ? '' :\n                             task.priority === 'high' ? '' :\n                             task.priority === 'medium' ? '' :\n                             ''}\n                          </span>\n                        </div>\n                      )}\n                      {task.category && (\n                        <div className=\"flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-700\">\n                          <Tag className=\"w-3 h-3\" />\n                          <span>{task.category}</span>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              </Link>\n            </SwipeableCard>\n          </div>\n        ))}\n      </div>\n\n      {filteredTasks.length === 0 && (\n        <div className=\"text-center py-12\">\n          <p className=\"text-gray-500\">No tasks found</p>\n        </div>\n      )}\n\n      {/* Pagination */}\n      {!hasActiveFilter && pagination && pagination.totalPages > 1 && (\n        <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4 mt-6\">\n          <div className=\"text-sm text-gray-600\">\n             {tasks.length}  {pagination.totalItems} \n          </div>\n          <div className=\"flex items-center gap-4\">\n            <Select value={pageSize.toString()} onValueChange={(value) => {\n              setPageSize(Number(value));\n              setCurrentPage(1);\n            }}>\n              <SelectTrigger className=\"w-[120px]\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"10\">10 / </SelectItem>\n                <SelectItem value=\"25\">25 / </SelectItem>\n                <SelectItem value=\"50\">50 / </SelectItem>\n                <SelectItem value=\"100\">100 / </SelectItem>\n              </SelectContent>\n            </Select>\n            <Pagination>\n              <PaginationContent>\n                <PaginationItem>\n                  <PaginationPrevious \n                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\n                    className={!pagination.hasPrevious ? 'pointer-events-none opacity-50' : 'cursor-pointer'}\n                  />\n                </PaginationItem>\n                {Array.from({ length: Math.min(5, pagination.totalPages) }, (_, i) => {\n                  let pageNum;\n                  if (pagination.totalPages <= 5) {\n                    pageNum = i + 1;\n                  } else if (currentPage <= 3) {\n                    pageNum = i + 1;\n                  } else if (currentPage >= pagination.totalPages - 2) {\n                    pageNum = pagination.totalPages - 4 + i;\n                  } else {\n                    pageNum = currentPage - 2 + i;\n                  }\n                  return (\n                    <PaginationItem key={pageNum}>\n                      <PaginationLink\n                        onClick={() => setCurrentPage(pageNum)}\n                        isActive={currentPage === pageNum}\n                        className=\"cursor-pointer\"\n                      >\n                        {pageNum}\n                      </PaginationLink>\n                    </PaginationItem>\n                  );\n                })}\n                <PaginationItem>\n                  <PaginationNext \n                    onClick={() => setCurrentPage(p => Math.min(pagination.totalPages, p + 1))}\n                    className={!pagination.hasMore ? 'pointer-events-none opacity-50' : 'cursor-pointer'}\n                  />\n                </PaginationItem>\n              </PaginationContent>\n            </Pagination>\n          </div>\n        </div>\n      )}\n\n      {/* Bulk Update Status Dialog */}\n      <Dialog open={showBulkStatusDialog} onOpenChange={setShowBulkStatusDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle></DialogTitle>\n            <DialogDescription>\n               ({selectedTasks.size} )\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <Select value={bulkStatus} onValueChange={setBulkStatus}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"todo\"></SelectItem>\n                <SelectItem value=\"ready_to_start\"></SelectItem>\n                <SelectItem value=\"in_progress\"></SelectItem>\n                <SelectItem value=\"pending_pre_inspection\"></SelectItem>\n                <SelectItem value=\"pending_final_inspection\"></SelectItem>\n                <SelectItem value=\"rectification_needed\"></SelectItem>\n                <SelectItem value=\"completed\"></SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowBulkStatusDialog(false)}>\n              \n            </Button>\n            <Button\n              onClick={handleBulkUpdateStatus}\n              disabled={bulkUpdateStatusMutation.isPending}\n            >\n              {bulkUpdateStatusMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n              \n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Bulk Assign Dialog */}\n      <Dialog open={showBulkAssignDialog} onOpenChange={setShowBulkAssignDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle></DialogTitle>\n            <DialogDescription>\n               ({selectedTasks.size} )\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <Select value={bulkAssignee} onValueChange={setBulkAssignee}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"\" />\n              </SelectTrigger>\n              <SelectContent>\n                {members.map((member: any) => (\n                  <SelectItem key={member.userId} value={member.userId.toString()}>\n                    {member.userName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowBulkAssignDialog(false)}>\n              \n            </Button>\n            <Button\n              onClick={handleBulkAssign}\n              disabled={bulkAssignMutation.isPending}\n            >\n              {bulkAssignMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n              \n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Bulk Delete Dialog */}\n      <Dialog open={showBulkDeleteDialog} onOpenChange={setShowBulkDeleteDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"text-red-600\"></DialogTitle>\n            <DialogDescription>\n               ({selectedTasks.size} )?\n              <br />\n              <span className=\"text-red-600 font-semibold\"></span>\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowBulkDeleteDialog(false)}>\n              \n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleBulkDelete}\n              disabled={bulkDeleteMutation.isPending}\n            >\n              {bulkDeleteMutation.isPending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n              \n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Floating Action Button - Mobile */}\n      {canCreate && (\n        <FloatingActionButton\n          onClick={() => setShowNewTaskDialog(true)}\n          icon={Plus}\n          label=\"\"\n        />\n      )}\n\n      {/* New Task Dialog */}\n      {showNewTaskDialog && (\n        <NewTaskDialog projectId={undefined} />\n      )}\n      </div>\n    </PullToRefresh>\n  );\n}\n",
    "client/src/pages/Defects.tsx": "import { useState } from \"react\";\nimport { useAuth } from \"@/_core/hooks/useAuth\";\nimport { trpc } from \"@/lib/trpc\";\nimport { QueryErrorBoundary } from \"@/components/QueryErrorBoundary\";\nimport { LoadingState } from \"@/components/LoadingState\";\nimport { EmptyState } from \"@/components/EmptyState\";\nimport { useLocation, Link } from \"wouter\";\nimport {\n  Pagination,\n  PaginationContent,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n} from \"@/components/ui/pagination\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Loader2, Search, AlertTriangle, CheckCircle2, Upload, X, Image as ImageIcon, Clock, FileWarning, TrendingUp, RefreshCw, XCircle, PieChart as PieChartIcon, Plus, CheckSquare, Trash2, Edit, UserPlus } from \"lucide-react\";\nimport { DefectCardSkeleton } from \"@/components/skeletons\";\nimport FloatingActionButton from \"@/components/FloatingActionButton\";\nimport { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from \"@/components/LazyChart\";\nimport { SwipeableCard } from \"@/components/SwipeableCard\";\nimport { PullToRefresh } from \"@/components/PullToRefresh\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { toast } from \"sonner\";\nimport { usePermissions, useCanDeleteDefect } from \"@/hooks/usePermissions\";\nimport { BeforeAfterComparison } from \"@/components/BeforeAfterComparison\";\nimport { FileUpload } from \"@/components/FileUpload\";\nimport { ExportButton } from \"@/components/ExportButton\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { BulkActionToolbar } from \"@/components/BulkActionToolbar\";\n\nexport default function Defects() {\n  const [, setLocation] = useLocation();\n  // Permission checks\n  const permissions = usePermissions('defects');\n  const canDeleteDefect = useCanDeleteDefect();\n  \n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"all\");\n  const [severityFilter, setSeverityFilter] = useState<string>(\"all\");\n  const [selectedDefect, setSelectedDefect] = useState<any>(null);\n  const [selectedDefects, setSelectedDefects] = useState<Set<number>>(new Set());\n  const [showBulkStatusDialog, setShowBulkStatusDialog] = useState(false);\n  const [showBulkAssignDialog, setShowBulkAssignDialog] = useState(false);\n  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);\n  const [resolutionComment, setResolutionComment] = useState(\"\");\n  \n  // Dashboard queries\n  const utils = trpc.useUtils();\n  const metricsQuery = trpc.defect.getMetrics.useQuery();\n  const statsByStatusQuery = trpc.defect.getStatsByStatus.useQuery();\n  const statsByTypeQuery = trpc.defect.getStatsByType.useQuery();\n  const statsByPriorityQuery = trpc.defect.getStatsByPriority.useQuery();\n  \n  const handleRefresh = async () => {\n    await Promise.all([\n      utils.defect.getMetrics.invalidate(),\n      utils.defect.getStatsByStatus.invalidate(),\n      utils.defect.getStatsByType.invalidate(),\n      utils.defect.getStatsByPriority.invalidate(),\n      utils.defect.list.invalidate(),\n    ]);\n  };\n  const metrics = metricsQuery.data || { total: 0, open: 0, closed: 0, pendingVerification: 0, overdue: 0 };\n  \n  // RCA & Action Plan states\n  const [showRCAForm, setShowRCAForm] = useState(false);\n  const [showActionPlanForm, setShowActionPlanForm] = useState(false);\n  const [rootCause, setRootCause] = useState(\"\");\n  const [analysisMethod, setAnalysisMethod] = useState(\"5_whys\");\n  const [correctiveAction, setCorrectiveAction] = useState(\"\");\n  const [preventiveAction, setPreventiveAction] = useState(\"\");\n  \n  // Fix Thai text input timeout - track composition state\n  const [isComposing, setIsComposing] = useState(false);\n  const [dueDate, setDueDate] = useState(\"\");\n  const [assignedTo, setAssignedTo] = useState<number | null>(null);\n  const [afterPhotos, setAfterPhotos] = useState<File[]>([]);\n  const [uploadingAfterPhotos, setUploadingAfterPhotos] = useState(false);\n  \n  // Verification states\n  const [showVerificationForm, setShowVerificationForm] = useState(false);\n  const [verificationComment, setVerificationComment] = useState(\"\");\n  \n  // Effectiveness Check states\n  const [showEffectivenessForm, setShowEffectivenessForm] = useState(false);\n  const [effectivenessComment, setEffectivenessComment] = useState(\"\");\n  \n  // Implementation states (for \"implemented\" status)\n  const [showImplementationForm, setShowImplementationForm] = useState(false);\n  const [implementationMethod, setImplementationMethod] = useState(\"\");\n  const [implementationPhotos, setImplementationPhotos] = useState<File[]>([]);\n  const [uploadingImplementationPhotos, setUploadingImplementationPhotos] = useState(false);\n  const [resolutionNotes, setResolutionNotes] = useState(\"\");\n  \n  // Closure states (for \"closed\" status)\n  const [showClosureForm, setShowClosureForm] = useState(false);\n  const [closureNotes, setClosureNotes] = useState(\"\");\n  \n  // Inline status change state\n  const [updatingDefectId, setUpdatingDefectId] = useState<number | null>(null);\n  \n  // Pagination states\n  const [currentPage, setCurrentPage] = useState(1);\n  const [pageSize, setPageSize] = useState(25);\n\n  const allDefectsQuery = trpc.defect.allDefects.useQuery({ page: currentPage, pageSize });\n  const updateDefectMutation = trpc.defect.update.useMutation();\n  const usersQuery = trpc.user.list.useQuery();\n\n  // Bulk operations mutations\n  const bulkUpdateStatusMutation = trpc.defect.bulkUpdateStatus.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.updated}/${data.total} `);\n      setSelectedDefects(new Set());\n      setShowBulkStatusDialog(false);\n      allDefectsQuery.refetch();\n    },\n    onError: () => {\n      toast.error(\"\");\n    },\n  });\n\n  const bulkAssignMutation = trpc.defect.bulkAssign.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.assigned}/${data.total} `);\n      setSelectedDefects(new Set());\n      setShowBulkAssignDialog(false);\n      allDefectsQuery.refetch();\n    },\n    onError: () => {\n      toast.error(\"\");\n    },\n  });\n\n  const bulkDeleteMutation = trpc.defect.bulkDelete.useMutation({\n    onSuccess: (data) => {\n      toast.success(` ${data.deleted}/${data.total} `);\n      setSelectedDefects(new Set());\n      setShowBulkDeleteDialog(false);\n      allDefectsQuery.refetch();\n    },\n    onError: () => {\n      toast.error(\"\");\n    },\n  });\n\n  const defects = allDefectsQuery.data?.items || [];\n  const pagination = allDefectsQuery.data?.pagination;\n\n  // Bulk operation handlers\n  const toggleDefectSelection = (defectId: number) => {\n    const newSelection = new Set(selectedDefects);\n    if (newSelection.has(defectId)) {\n      newSelection.delete(defectId);\n    } else {\n      newSelection.add(defectId);\n    }\n    setSelectedDefects(newSelection);\n  };\n\n  const selectAllDefects = () => {\n    if (selectedDefects.size === filteredDefects.length) {\n      setSelectedDefects(new Set());\n    } else {\n      setSelectedDefects(new Set(filteredDefects.map((d: any) => d.id)));\n    }\n  };\n\n  const handleBulkAssign = (assigneeId: number) => {\n    bulkAssignMutation.mutate({\n      defectIds: Array.from(selectedDefects),\n      assigneeId,\n    });\n  };\n\n  const handleBulkUpdateStatus = (status: string) => {\n    bulkUpdateStatusMutation.mutate({\n      defectIds: Array.from(selectedDefects),\n      status: status as any,\n    });\n  };\n\n  const handleBulkDelete = () => {\n    bulkDeleteMutation.mutate({\n      defectIds: Array.from(selectedDefects),\n    });\n  };\n\n  let filteredDefects = defects.filter((d: any) =>\n    d.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    (d.taskName && d.taskName.toLowerCase().includes(searchTerm.toLowerCase())) ||\n    (d.checklistTemplateName && d.checklistTemplateName.toLowerCase().includes(searchTerm.toLowerCase()))\n  );\n\n  if (statusFilter !== \"all\") {\n    filteredDefects = filteredDefects.filter((d: any) => d.status === statusFilter);\n  }\n\n  if (typeFilter !== \"all\") {\n    filteredDefects = filteredDefects.filter((d: any) => d.type === typeFilter);\n  }\n\n  if (severityFilter !== \"all\") {\n    filteredDefects = filteredDefects.filter((d: any) => d.severity === severityFilter);\n  }\n\n  const getSeverityColor = (severity: string) => {\n    switch (severity) {\n      case \"critical\":\n        return \"bg-red-100 text-red-800\";\n      case \"high\":\n        return \"bg-orange-100 text-orange-800\";\n      case \"medium\":\n        return \"bg-yellow-100 text-yellow-800\";\n      case \"low\":\n        return \"bg-blue-100 text-blue-800\";\n      default:\n        return \"bg-gray-100 text-gray-800\";\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"reported\":\n        return \"bg-orange-100 text-orange-800\";\n      case \"analysis\":\n        return \"bg-yellow-100 text-yellow-800\";\n      case \"in_progress\":\n        return \"bg-blue-100 text-blue-800\";\n      case \"resolved\":\n        return \"bg-green-100 text-green-800\";\n      case \"closed\":\n        return \"bg-gray-100 text-gray-800\";\n      default:\n        return \"bg-gray-100 text-gray-800\";\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    const labels: Record<string, string> = {\n      reported: \"\",\n      analysis: \"\",\n      in_progress: \"\",\n      resolved: \"\",\n      closed: \"\",\n    };\n    return labels[status] || status;\n  };\n\n  const getTypeColor = (type: string) => {\n    switch (type) {\n      case \"CAR\":\n        return \"bg-yellow-100 text-yellow-800\";\n      case \"PAR\":\n        return \"bg-blue-100 text-blue-800\";\n      case \"NCR\":\n        return \"bg-red-100 text-red-800\";\n      default:\n        return \"bg-gray-100 text-gray-800\";\n    }\n  };\n\n  // Helper functions for inline status buttons\n  const getNextStatus = (currentStatus: string): string | null => {\n    const statusFlow: Record<string, string> = {\n      reported: 'analysis',\n      analysis: 'in_progress',\n      in_progress: 'resolved',\n      resolved: 'closed',\n    };\n    return statusFlow[currentStatus] || null;\n  };\n\n  const getStatusButtonContent = (status: string) => {\n    switch (status) {\n      case 'reported':\n        return (\n          <>\n            <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n            \n          </>\n        );\n      case 'analysis':\n        return (\n          <>\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            \n          </>\n        );\n      case 'in_progress':\n        return (\n          <>\n            <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n            \n          </>\n        );\n      case 'resolved':\n        return (\n          <>\n            <XCircle className=\"w-4 h-4 mr-2\" />\n            \n          </>\n        );\n      default:\n        return null;\n    }\n  };\n\n  const handleQuickStatusChange = async (defectId: number, currentStatus: string) => {\n    // Instead of immediate status change, navigate to DefectDetail page\n    // where users can fill in all required information before saving\n    setLocation(`/defects/${defectId}`);\n  };\n\n  const handleUpdateDefect = async (newStatus: string) => {\n    if (!selectedDefect) return;\n\n    try {\n      await updateDefectMutation.mutateAsync({\n        id: selectedDefect.id,\n        status: newStatus as any,\n        resolutionComment: resolutionComment || undefined,\n      });\n\n      toast.success(\"Defect updated successfully\");\n      setSelectedDefect(null);\n      setResolutionComment(\"\");\n      allDefectsQuery.refetch();\n    } catch (error: any) {\n      toast.error(\"Failed to update defect\");\n    }\n  };\n\n  const handleSaveRCA = async () => {\n    if (!selectedDefect || !rootCause.trim()) {\n      toast.error(\"Please fill in root cause\");\n      return;\n    }\n\n    try {\n      await updateDefectMutation.mutateAsync({\n        id: selectedDefect.id,\n        rootCause,\n        status: \"analysis\" as any,\n      });\n\n      toast.success(\"RCA saved successfully\");\n      setShowRCAForm(false);\n      setShowActionPlanForm(true);\n      allDefectsQuery.refetch();\n    } catch (error: any) {\n      toast.error(\"Failed to save RCA\");\n    }\n  };\n\n  const uploadAttachmentMutation = trpc.defect.uploadAttachment.useMutation();\n  const getAttachmentsByTypeQuery = trpc.defect.getAttachmentsByType.useQuery(\n    { \n      defectId: selectedDefect?.id || 0,\n      attachmentType: 'before'\n    },\n    { enabled: !!selectedDefect?.id && showVerificationForm }\n  );\n  const getAfterAttachmentsQuery = trpc.defect.getAttachmentsByType.useQuery(\n    { \n      defectId: selectedDefect?.id || 0,\n      attachmentType: 'after'\n    },\n    { enabled: !!selectedDefect?.id && showVerificationForm }\n  );\n\n  const handleSaveActionPlan = async () => {\n    if (!selectedDefect || !correctiveAction.trim()) {\n      toast.error(\"Please fill in corrective action\");\n      return;\n    }\n\n    try {\n      // Save action plan first\n      await updateDefectMutation.mutateAsync({\n        id: selectedDefect.id,\n        correctiveAction,\n        preventiveAction: preventiveAction || undefined,\n        dueDate: dueDate ? new Date(dueDate) : undefined,\n        assignedTo: assignedTo || undefined,\n        status: \"in_progress\" as any,\n      });\n\n      // Upload after photos if any\n      if (afterPhotos.length > 0) {\n        setUploadingAfterPhotos(true);\n        \n        for (const photo of afterPhotos) {\n          // Upload to S3\n          const formData = new FormData();\n          formData.append('file', photo);\n          \n          const uploadResponse = await fetch('/api/upload', {\n            method: 'POST',\n            body: formData,\n          });\n          \n          if (!uploadResponse.ok) {\n            throw new Error(`Failed to upload ${photo.name}`);\n          }\n          \n          const { url, key } = await uploadResponse.json();\n          \n          // Save attachment record\n          await uploadAttachmentMutation.mutateAsync({\n            defectId: selectedDefect.id,\n            fileUrl: url,\n            fileKey: key,\n            fileName: photo.name,\n            fileType: photo.type,\n            fileSize: photo.size,\n            attachmentType: 'after' as const,\n          });\n        }\n        \n        setUploadingAfterPhotos(false);\n      }\n\n      toast.success(\"Action Plan saved successfully\");\n      setShowActionPlanForm(false);\n      setSelectedDefect(null);\n      // Reset form\n      setRootCause(\"\");\n      setCorrectiveAction(\"\");\n      setPreventiveAction(\"\");\n      setDueDate(\"\");\n      setAssignedTo(null);\n      setAfterPhotos([]);\n      allDefectsQuery.refetch();\n    } catch (error: any) {\n      setUploadingAfterPhotos(false);\n      console.error('Error saving Action Plan:', error);\n      toast.error(\"Failed to save Action Plan: \" + (error as Error).message);\n    }\n  };\n\n  const handleSaveImplementation = async () => {\n    if (!selectedDefect || !implementationMethod.trim() || !resolutionNotes.trim()) {\n      toast.error(\"\");\n      return;\n    }\n\n    try {\n      // Upload implementation photos first if any\n      let photoUrls: string[] = [];\n      if (implementationPhotos.length > 0) {\n        setUploadingImplementationPhotos(true);\n        \n        for (const photo of implementationPhotos) {\n          const formData = new FormData();\n          formData.append('file', photo);\n          \n          const uploadResponse = await fetch('/api/upload', {\n            method: 'POST',\n            body: formData,\n          });\n          \n          if (!uploadResponse.ok) {\n            throw new Error(`Failed to upload ${photo.name}`);\n          }\n          \n          const { url, key } = await uploadResponse.json();\n          photoUrls.push(url);\n          \n          // Save attachment record\n          await uploadAttachmentMutation.mutateAsync({\n            defectId: selectedDefect.id,\n            fileUrl: url,\n            fileKey: key,\n            fileName: photo.name,\n            fileType: photo.type,\n            fileSize: photo.size,\n            attachmentType: 'supporting' as const,\n          });\n        }\n        \n        setUploadingImplementationPhotos(false);\n      }\n\n      // Update defect with implementation details\n      await updateDefectMutation.mutateAsync({\n        id: selectedDefect.id,\n        implementationMethod,\n        afterPhotos: photoUrls.length > 0 ? JSON.stringify(photoUrls) : undefined,\n        resolutionNotes,\n        status: \"resolved\" as any,\n      });\n\n      toast.success(\"\");\n      setShowImplementationForm(false);\n      setSelectedDefect(null);\n      // Reset form\n      setImplementationMethod(\"\");\n      setImplementationPhotos([]);\n      setResolutionNotes(\"\");\n      allDefectsQuery.refetch();\n    } catch (error: any) {\n      setUploadingImplementationPhotos(false);\n      console.error('Error saving Implementation:', error);\n      toast.error(\": \" + (error as Error).message);\n    }\n  };\n\n  const stats = {\n    total: defects.length,\n    critical: defects.filter((d: any) => d.severity === \"critical\").length,\n    high: defects.filter((d: any) => d.severity === \"high\").length,\n    open: defects.filter((d: any) => d.status === \"reported\").length,\n  };\n\n  if (allDefectsQuery.isLoading) {\n    return (\n      <div className=\"container mx-auto py-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold text-gray-900\"></h1>\n          <div className=\"flex items-center gap-2\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-gray-400\" />\n          </div>\n        </div>\n        <DefectCardSkeleton />\n      </div>\n    );\n  }\n\n  return (\n    <PullToRefresh onRefresh={handleRefresh}>\n      <div className=\"space-y-6\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-3xl font-bold\">Defect Tracking</h1>\n        <p className=\"text-gray-600 mt-1\">Monitor and manage construction defects</p>\n      </div>\n\n      {/* Dashboard Metrics with Pie Chart */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center gap-2\">\n            <PieChartIcon className=\"h-5 w-5\" />\n            <CardTitle>Defect Tracking Overview</CardTitle>\n          </div>\n          <CardDescription> Defect </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col md:flex-row items-center gap-8\">\n            {/* Pie Chart */}\n            <div className=\"w-full md:w-1/2 h-[300px]\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <PieChart>\n                  <Pie\n                    data={[\n                      { name: '', value: metrics.pendingVerification, color: '#FBBF24' },\n                      { name: '', value: metrics.open, color: '#F97316' },\n                      { name: '', value: metrics.closed, color: '#10B981' },\n                      { name: '', value: metrics.overdue, color: '#EF4444' },\n                    ]}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    labelLine={false}\n                    label={(entry: any) => `${entry.name} ${((entry.value / metrics.total) * 100).toFixed(0)}%`}\n                    outerRadius={100}\n                    fill=\"#8884d8\"\n                    dataKey=\"value\"\n                  >\n                    {[\n                      { name: '', value: metrics.pendingVerification, color: '#FBBF24' },\n                      { name: '', value: metrics.open, color: '#F97316' },\n                      { name: '', value: metrics.closed, color: '#10B981' },\n                      { name: '', value: metrics.overdue, color: '#EF4444' },\n                    ].map((entry, index: any) => (\n                      <Cell key={`cell-${index}`} fill={entry.color} />\n                    ))}\n                  </Pie>\n                  <Tooltip />\n                </PieChart>\n              </ResponsiveContainer>\n            </div>\n            \n            {/* Stat Cards */}\n            <div className=\"grid grid-cols-2 gap-4 w-full md:w-1/2\">\n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setStatusFilter(statusFilter === 'resolved' ? 'all' : 'resolved')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-yellow-600\">{metrics.pendingVerification}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setStatusFilter(statusFilter === 'all' ? 'all' : 'all')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-orange-600\">{metrics.open}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => setStatusFilter(statusFilter === 'closed' ? 'all' : 'closed')}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-green-600\">{metrics.closed}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n              \n              <Card \n                className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                onClick={() => {\n                  setStatusFilter('all');\n                  toast.info(' Defect ');\n                }}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"text-2xl font-bold text-red-600\">{metrics.overdue}</div>\n                  <div className=\"text-sm text-muted-foreground\"></div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Filters */}\n      <div className=\"flex flex-col md:flex-row gap-4\">\n        <Input\n          placeholder=\" Defects...\"\n          value={searchTerm}\n          onChange={(e) => setSearchTerm(e.target.value)}\n          className=\"flex-1\"\n        />\n        {filteredDefects.length > 0 && filteredDefects[0]?.projectId && (\n          <ExportButton projectId={filteredDefects[0].projectId} type=\"defects\" />\n        )}\n        <Select value={typeFilter} onValueChange={setTypeFilter}>\n          <SelectTrigger className=\"w-full md:w-40\">\n            <SelectValue placeholder=\"\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\"></SelectItem>\n            <SelectItem value=\"CAR\">CAR</SelectItem>\n            <SelectItem value=\"PAR\">PAR</SelectItem>\n            <SelectItem value=\"NCR\">NCR</SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={severityFilter} onValueChange={setSeverityFilter}>\n          <SelectTrigger className=\"w-full md:w-48\">\n            <SelectValue placeholder=\"\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\"></SelectItem>\n            <SelectItem value=\"critical\"></SelectItem>\n            <SelectItem value=\"high\"></SelectItem>\n            <SelectItem value=\"medium\"></SelectItem>\n            <SelectItem value=\"low\"></SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={statusFilter} onValueChange={setStatusFilter}>\n          <SelectTrigger className=\"w-full md:w-48\">\n            <SelectValue placeholder=\"\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\"></SelectItem>\n            <SelectItem value=\"reported\"></SelectItem>\n            <SelectItem value=\"analysis\"></SelectItem>\n            <SelectItem value=\"in_progress\"></SelectItem>\n            <SelectItem value=\"resolved\"></SelectItem>\n            <SelectItem value=\"closed\"></SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Defects List */}\n      <div className=\"space-y-3\">\n        {filteredDefects.length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <p className=\"text-center text-gray-500\">\n                {defects.length === 0 ? \"No defects reported\" : \"No defects match your filter\"}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <>\n            {/* Select All Checkbox */}\n            {permissions.canEdit && filteredDefects.length > 0 && (\n              <div className=\"flex items-center gap-3 mb-4 p-3 bg-muted/50 rounded-lg\">\n                <Checkbox\n                  checked={selectedDefects.size === filteredDefects.length && filteredDefects.length > 0}\n                  onCheckedChange={selectAllDefects}\n                  className=\"border-2\"\n                />\n                <span className=\"text-sm font-medium\">\n                  {selectedDefects.size === filteredDefects.length && filteredDefects.length > 0\n                    ? ` ${selectedDefects.size} `\n                    : ` (${filteredDefects.length} )`}\n                </span>\n              </div>\n            )}\n\n            {filteredDefects.map((defect: any) => {\n              const nextStatus = getNextStatus(defect.status);\n              const canEdit = permissions.canEdit;\n              \n              const swipeLeftActions: any[] = [];\n              const swipeRightActions: any[] = [];\n            \n            // Add status change action if available\n            if (canEdit && nextStatus) {\n              const getStatusIcon = (status: string) => {\n                switch (status) {\n                  case 'reported':\n                    return <CheckCircle2 className=\"h-5 w-5\" />;\n                  case 'analysis':\n                    return <RefreshCw className=\"h-5 w-5\" />;\n                  case 'in_progress':\n                    return <CheckCircle2 className=\"h-5 w-5\" />;\n                  case 'resolved':\n                    return <XCircle className=\"h-5 w-5\" />;\n                  default:\n                    return <CheckCircle2 className=\"h-5 w-5\" />;\n                }\n              };\n              \n              const getStatusButtonText = (status: string) => {\n                switch (status) {\n                  case 'reported':\n                    return '';\n                  case 'analysis':\n                    return '';\n                  case 'in_progress':\n                    return '';\n                  case 'resolved':\n                    return '';\n                  default:\n                    return '';\n                }\n              };\n              \n              swipeLeftActions.push({\n                label: getStatusButtonText(defect.status),\n                color: \"#10b981\",\n                icon: getStatusIcon(defect.status),\n                onAction: () => handleQuickStatusChange(defect.id, defect.status),\n              });\n            }\n            \n            return (\n              <div key={defect.id} className=\"relative\">\n                {/* Selection Checkbox */}\n                {permissions.canEdit && (\n                  <div className=\"absolute top-3 left-3 z-10\">\n                    <Checkbox\n                      checked={selectedDefects.has(defect.id)}\n                      onCheckedChange={() => toggleDefectSelection(defect.id)}\n                      onClick={(e) => e.stopPropagation()}\n                      className=\"bg-white border-2 shadow-sm\"\n                    />\n                  </div>\n                )}\n\n                <SwipeableCard\n                  leftActions={swipeLeftActions}\n                  rightActions={swipeRightActions}\n                  disabled={updatingDefectId === defect.id}\n                >\n                <Card \n                  className=\"hover:shadow-md transition cursor-pointer\"\n                  onClick={() => setLocation(`/defects/${defect.id}`)}\n                >\n                    <CardContent className=\"pt-4 pb-14\">\n                      <div className=\"space-y-2.5\">\n                        {/* Title with Icon */}\n                        <div className=\"flex items-start gap-2\">\n                          <AlertTriangle className=\"w-4 h-4 text-red-600 flex-shrink-0 mt-0.5\" />\n                          <h3 className=\"font-semibold text-base leading-tight flex-1\">{defect.title}</h3>\n                        </div>\n                        \n                        {/* Description - Compact */}\n                        {defect.description && (\n                          <p className=\"text-xs text-muted-foreground line-clamp-2 pl-6\">{defect.description}</p>\n                        )}\n                        \n                        {/* Badges - Horizontal scroll on mobile */}\n                        <div className=\"flex gap-1.5 overflow-x-auto pb-1 scrollbar-hide\">\n                          <Badge className={`${getTypeColor(defect.type)} text-xs px-2 py-0.5`}>\n                            {defect.type}\n                          </Badge>\n                          <Badge className={`${getSeverityColor(defect.severity)} text-xs px-2 py-0.5`}>\n                            {defect.severity.toUpperCase()}\n                          </Badge>\n                          <StatusBadge \n                            status={defect.status}\n                            label={getStatusLabel(defect.status)}\n                            className=\"text-xs px-2 py-0.5\"\n                          />\n                        </div>\n                        \n                        {/* Metadata - Single line */}\n                        <div className=\"text-xs text-muted-foreground space-y-0.5\">\n                          <div className=\"truncate\">\n                            : {defect.taskName || 'Unknown Task'}\n                          </div>\n                          <div className=\"truncate\">\n                            {new Date(defect.createdAt).toLocaleDateString('th-TH', { month: 'short', day: 'numeric', year: 'numeric' })}\n                          </div>\n                        </div>\n                      </div>\n                    </CardContent>\n                </Card>\n                \n                {/* Inline status change button */}\n                {canEdit && nextStatus && (\n                  <div className=\"absolute bottom-4 right-4 z-10\">\n                    <Button\n                      size=\"sm\"\n                      onClick={(e) => {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        handleQuickStatusChange(defect.id, defect.status);\n                      }}\n                      disabled={updatingDefectId === defect.id}\n                      className=\"shadow-md\"\n                    >\n                      {updatingDefectId === defect.id ? (\n                        <Loader2 className=\"w-4 h-4 animate-spin\" />\n                      ) : (\n                        getStatusButtonContent(defect.status)\n                      )}\n                    </Button>\n                  </div>\n                )}\n              </SwipeableCard>\n              </div>\n            );\n          })}\n\n          {/* Bulk Action Toolbar */}\n          <BulkActionToolbar\n            selectedCount={selectedDefects.size}\n            onClearSelection={() => setSelectedDefects(new Set())}\n            onBulkAssign={handleBulkAssign}\n            onBulkUpdateStatus={handleBulkUpdateStatus}\n            onBulkDelete={handleBulkDelete}\n            assigneeOptions={usersQuery.data?.map((u: any) => ({ id: u.id, name: u.name || u.email })) || []}\n            statusOptions={[\n              { value: 'reported', label: '' },\n              { value: 'assigned', label: '' },\n              { value: 'in_progress', label: '' },\n              { value: 'resolved', label: '' },\n              { value: 'verified', label: '' },\n              { value: 'closed', label: '' },\n            ]}\n          />\n          </>\n        )}\n      </div>\n\n      {/* Defect Detail Dialog */}\n      <Dialog open={!!selectedDefect && !showRCAForm && !showActionPlanForm && !showImplementationForm} onOpenChange={(open) => !open && setSelectedDefect(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"w-5 h-5 text-orange-600\" />\n              {selectedDefect?.type || 'Defect'} Details\n            </DialogTitle>\n            <DialogDescription>{selectedDefect?.title}</DialogDescription>\n          </DialogHeader>\n\n          {selectedDefect && (\n            <div className=\"space-y-4\">\n              {/* Type Badge */}\n              {selectedDefect.type && (\n                <div>\n                  <Label className=\"text-xs font-semibold\">Type</Label>\n                  <div className=\"mt-1\">\n                    <Badge className={selectedDefect.type === 'CAR' ? 'bg-yellow-100 text-yellow-800' : selectedDefect.type === 'PAR' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}>\n                      {selectedDefect.type}\n                    </Badge>\n                  </div>\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs font-semibold\">Severity</Label>\n                  <div className=\"mt-1\">\n                    <Badge className={`${getSeverityColor(selectedDefect.severity)}`}>\n                      {selectedDefect.severity.toUpperCase()}\n                    </Badge>\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-xs font-semibold\">Status</Label>\n                  <div className=\"mt-1\">\n                    <StatusBadge \n                      status={selectedDefect.status}\n                      label={getStatusLabel(selectedDefect.status)}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {selectedDefect.description && (\n                <div>\n                  <Label className=\"text-xs font-semibold\">Description</Label>\n                  <p className=\"text-sm text-gray-600 mt-1\">{selectedDefect.description}</p>\n                </div>\n              )}\n\n              {/* Show RCA if exists */}\n              {selectedDefect.rootCause && (\n                <div className=\"bg-blue-50 p-3 rounded-md border border-blue-200\">\n                  <Label className=\"text-xs font-semibold text-blue-900\"> (RCA)</Label>\n                  <p className=\"text-sm text-blue-800 mt-1\">{selectedDefect.rootCause}</p>\n                </div>\n              )}\n\n              {/* Show Action Plan if exists */}\n              {selectedDefect.correctiveAction && (\n                <div className=\"bg-green-50 p-3 rounded-md border border-green-200\">\n                  <Label className=\"text-xs font-semibold text-green-900\"> (Corrective Action)</Label>\n                  <p className=\"text-sm text-green-800 mt-1\">{selectedDefect.correctiveAction}</p>\n                  {selectedDefect.preventiveAction && (\n                    <>\n                      <Label className=\"text-xs font-semibold text-green-900 mt-2 block\"> (Preventive Action)</Label>\n                      <p className=\"text-sm text-green-800 mt-1\">{selectedDefect.preventiveAction}</p>\n                    </>\n                  )}\n                  {selectedDefect.dueDate && (\n                    <p className=\"text-xs text-[#00CE81] mt-2\">: {new Date(selectedDefect.dueDate).toLocaleDateString('th-TH')}</p>\n                  )}\n                </div>\n              )}\n\n              {/* Before-After Photos Comparison */}\n              {selectedDefect.beforePhotos && selectedDefect.afterPhotos && (() => {\n                try {\n                  const beforePhotos = JSON.parse(selectedDefect.beforePhotos);\n                  const afterPhotos = JSON.parse(selectedDefect.afterPhotos);\n                  if (Array.isArray(beforePhotos) && beforePhotos.length > 0 && Array.isArray(afterPhotos) && afterPhotos.length > 0) {\n                    return (\n                      <div className=\"border-t pt-4\">\n                        <BeforeAfterComparison\n                          beforePhotos={beforePhotos}\n                          afterPhotos={afterPhotos}\n                        />\n                      </div>\n                    );\n                  }\n                } catch (e) {\n                  console.error('Error parsing photos:', e);\n                }\n                return null;\n              })()}\n\n              {/* Action Buttons based on status */}\n              <div className=\"flex gap-2\">\n                {selectedDefect.status === \"reported\" && (\n                  <Button\n                    onClick={() => setShowRCAForm(true)}\n                    className=\"flex-1 bg-[#00366D] hover:bg-blue-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {selectedDefect.status === \"analysis\" && !selectedDefect.correctiveAction && (\n                  <Button\n                    onClick={() => setShowActionPlanForm(true)}\n                    className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {(selectedDefect.status === \"in_progress\" || (selectedDefect.status === \"analysis\" && selectedDefect.correctiveAction)) && (\n                  <Button\n                    onClick={() => handleUpdateDefect(\"in_progress\")}\n                    disabled={updateDefectMutation.isPending}\n                    className=\"flex-1 bg-orange-600 hover:bg-orange-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {selectedDefect.status === \"in_progress\" && (\n                  <Button\n                    onClick={() => setShowImplementationForm(true)}\n                    disabled={updateDefectMutation.isPending}\n                    className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {selectedDefect.status === \"resolved\" && (\n                  <Button\n                    onClick={() => handleUpdateDefect(\"closed\")}\n                    disabled={updateDefectMutation.isPending}\n                    className=\"flex-1 bg-[#00366D] hover:bg-blue-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {selectedDefect.status === \"resolved\" && false && (\n                  <Button\n                    onClick={() => setShowVerificationForm(true)}\n                    disabled={updateDefectMutation.isPending}\n                    className=\"flex-1 bg-purple-600 hover:bg-purple-700\"\n                  >\n                    \n                  </Button>\n                )}\n                {selectedDefect.status === \"resolved\" && false && (\n                  <Button\n                    onClick={() => setShowEffectivenessForm(true)}\n                    disabled={updateDefectMutation.isPending}\n                    className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                  >\n                    \n                  </Button>\n                )}\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* RCA Form Dialog */}\n      <Dialog open={showRCAForm} onOpenChange={setShowRCAForm}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Search className=\"w-5 h-5 text-[#00366D]\" />\n               (Root Cause Analysis)\n            </DialogTitle>\n            <DialogDescription>\n              : {selectedDefect?.title}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"analysisMethod\" className=\"text-sm font-semibold\">\n                \n              </Label>\n              <Select value={analysisMethod} onValueChange={setAnalysisMethod}>\n                <SelectTrigger className=\"mt-1\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"5_whys\">5 Whys ( 5 )</SelectItem>\n                  <SelectItem value=\"fishbone\">Fishbone Diagram ()</SelectItem>\n                  <SelectItem value=\"pareto\">Pareto Analysis ()</SelectItem>\n                  <SelectItem value=\"other\"></SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"rootCause\" className=\"text-sm font-semibold\">\n                 (Root Cause) <span className=\"text-red-500\">*</span>\n              </Label>\n              <p className=\"text-xs text-gray-500 mt-1\">\n                \n              </p>\n              <Textarea\n                id=\"rootCause\"\n                placeholder=\":  ...\"\n                value={rootCause}\n                onChange={(e) => setRootCause(e.target.value)}\n                onCompositionStart={() => setIsComposing(true)}\n                onCompositionEnd={() => setIsComposing(false)}\n                className=\"mt-2\"\n                rows={6}\n              />\n            </div>\n\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowRCAForm(false)}\n                className=\"flex-1\"\n              >\n                \n              </Button>\n              <Button\n                onClick={handleSaveRCA}\n                disabled={!rootCause.trim() || updateDefectMutation.isPending}\n                className=\"flex-1 bg-[#00366D] hover:bg-blue-700\"\n              >\n                {updateDefectMutation.isPending ? \"...\" : \" RCA \"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Action Plan Form Dialog */}\n      <Dialog open={showActionPlanForm} onOpenChange={setShowActionPlanForm}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"w-5 h-5 text-[#00CE81]\" />\n               (Action Plan)\n            </DialogTitle>\n            <DialogDescription>\n              : {selectedDefect?.title}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"correctiveAction\" className=\"text-sm font-semibold\">\n                 (Corrective Action) <span className=\"text-red-500\">*</span>\n              </Label>\n              <p className=\"text-xs text-gray-500 mt-1\">\n                \n              </p>\n              <Textarea\n                id=\"correctiveAction\"\n                placeholder=\":  ...\"\n                onCompositionStart={() => setIsComposing(true)}\n                onCompositionEnd={() => setIsComposing(false)}\n                value={correctiveAction}\n                onChange={(e) => setCorrectiveAction(e.target.value)}\n                className=\"mt-2\"\n                rows={4}\n              />\n            </div>\n\n            {(selectedDefect?.type === 'PAR' || selectedDefect?.type === 'NCR') && (\n              <div>\n                <Label htmlFor=\"preventiveAction\" className=\"text-sm font-semibold\">\n                   (Preventive Action)\n                </Label>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  \n                </p>\n              <Textarea\n                id=\"preventiveAction\"\n                placeholder=\":   ...\"\n                onCompositionStart={() => setIsComposing(true)}\n                onCompositionEnd={() => setIsComposing(false)}\n                  value={preventiveAction}\n                  onChange={(e) => setPreventiveAction(e.target.value)}\n                  className=\"mt-2\"\n                  rows={4}\n                />\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"dueDate\" className=\"text-sm font-semibold\">\n                  \n                </Label>\n                <Input\n                  id=\"dueDate\"\n                  type=\"date\"\n                  value={dueDate}\n                  onChange={(e) => setDueDate(e.target.value)}\n                  className=\"mt-1\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"assignedTo\" className=\"text-sm font-semibold\">\n                  \n                </Label>\n                <Select value={assignedTo?.toString() || \"\"} onValueChange={(v) => setAssignedTo(parseInt(v))}>\n                  <SelectTrigger className=\"mt-1\">\n                    <SelectValue placeholder=\"\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {usersQuery.data?.map((user: any) => (\n                      <SelectItem key={user.id} value={user.id.toString()}>\n                        {user.name || user.email}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            {/* After Photos Upload Section */}\n            <div className=\"space-y-3 p-5 rounded-lg border bg-card\">\n              <h3 className=\"font-semibold text-base flex items-center gap-2\">\n                <ImageIcon className=\"h-5 w-5\" />\n                 (After Photos)\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                 ( JPG, PNG, HEIC  10MB/)\n              </p>\n              \n              {/* File Upload Component */}\n              <FileUpload\n                onFilesSelected={setAfterPhotos}\n                maxFiles={10}\n                maxSizeMB={10}\n                acceptedTypes={[\"image/jpeg\", \"image/png\", \"image/webp\", \"image/jpg\", \"image/heic\"]}\n                multiple={true}\n              />\n            </div>\n\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowActionPlanForm(false)}\n                className=\"flex-1\"\n              >\n                \n              </Button>\n              <Button\n                onClick={handleSaveActionPlan}\n                disabled={!correctiveAction.trim() || updateDefectMutation.isPending || uploadingAfterPhotos}\n                className=\"flex-1 bg-green-600 hover:bg-green-700\"\n              >\n                {(updateDefectMutation.isPending || uploadingAfterPhotos) ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    {uploadingAfterPhotos ? '...' : '...'}\n                  </>\n                ) : (\n                  \"\"\n                )}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Verification Form Dialog */}\n      <Dialog open={showVerificationForm} onOpenChange={setShowVerificationForm}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"w-5 h-5 text-purple-600\" />\n              Verification - {selectedDefect?.type}\n            </DialogTitle>\n            <DialogDescription>\n              Review implementation and compare Before/After photos: {selectedDefect?.title}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-6\">\n            {/* Before/After Photos Comparison */}\n            <div className=\"space-y-4\">\n   \n\n... ()",
    "client/src/pages/InspectionDetail.tsx": "import { useAuth } from \"@/_core/hooks/useAuth\";\nimport { trpc } from \"@/lib/trpc\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Loader2,\n  ArrowLeft,\n  CheckCircle2,\n  XCircle,\n  MinusCircle,\n  Calendar,\n  User,\n  FileText,\n  Image as ImageIcon,\n  AlertTriangle,\n  Download,\n} from \"lucide-react\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { th } from \"date-fns/locale\";\nimport { useState, useMemo, useEffect } from \"react\";\nimport { ImageGalleryViewer } from \"@/components/MobileDocumentViewer\";\nimport { useIsMobile } from \"@/hooks/useMobile\";\nimport { toast } from \"sonner\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Pencil, Filter } from \"lucide-react\";\n\n// Helper functions\nconst getResultIcon = (result: string) => {\n  switch (result) {\n    case \"pass\":\n      return <CheckCircle2 className=\"h-5 w-5 text-green-600\" />;\n    case \"fail\":\n      return <XCircle className=\"h-5 w-5 text-red-600\" />;\n    case \"na\":\n      return <MinusCircle className=\"h-5 w-5 text-gray-400\" />;\n    default:\n      return null;\n  }\n};\n\nconst getResultBadge = (result: string) => {\n  const resultMap = {\n    pass: { label: \"\", variant: \"default\" as const },\n    fail: { label: \"\", variant: \"destructive\" as const },\n    na: { label: \"N/A\", variant: \"secondary\" as const },\n  };\n  const config = resultMap[result as keyof typeof resultMap];\n  return config ? <Badge variant={config.variant}>{config.label}</Badge> : null;\n};\n\nconst getStatusBadge = (status: string) => {\n  const statusMap = {\n    not_started: { label: \"\", variant: \"secondary\" as const },\n    pending_inspection: { label: \"\", variant: \"default\" as const },\n    in_progress: { label: \"\", variant: \"default\" as const },\n    completed: { label: \"\", variant: \"default\" as const },\n    failed: { label: \"\", variant: \"destructive\" as const },\n  };\n  const config = statusMap[status as keyof typeof statusMap] || statusMap.not_started;\n  return <Badge variant={config.variant}>{config.label}</Badge>;\n};\n\nconst getStageBadge = (stage: string) => {\n  const stageMap = {\n    pre_execution: { label: \"\", color: \"bg-blue-100 text-blue-800\" },\n    in_progress: { label: \"\", color: \"bg-yellow-100 text-yellow-800\" },\n    post_execution: { label: \"\", color: \"bg-green-100 text-green-800\" },\n  };\n  const config = stageMap[stage as keyof typeof stageMap] || stageMap.pre_execution;\n  return <Badge className={config.color}>{config.label}</Badge>;\n};\n\nconst parsePhotoUrls = (photoUrls: string | null): string[] => {\n  if (!photoUrls) return [];\n  try {\n    return JSON.parse(photoUrls);\n  } catch {\n    return [];\n  }\n};\n\n/**\n * Inspection Detail Page\n *  /\n */\nexport default function InspectionDetail() {\n  const { user, loading: authLoading } = useAuth();\n  const [, params] = useRoute(\"/inspections/:inspectionId\");\n  const [, navigate] = useLocation();\n  const inspectionId = params?.inspectionId ? parseInt(params.inspectionId) : null;\n  const [selectedImage, setSelectedImage] = useState<string | null>(null);\n  const [galleryOpen, setGalleryOpen] = useState(false);\n  const [galleryImages, setGalleryImages] = useState<Array<{ url: string; fileName?: string }>>([]);\n  const [galleryInitialIndex, setGalleryInitialIndex] = useState(0);\n  const isMobile = useIsMobile();\n\n  // Edit checklist item state - track editing state for each item\n  const [editingItemId, setEditingItemId] = useState<number | null>(null);\n  const [itemStates, setItemStates] = useState<Record<number, { result: \"pass\" | \"fail\" | \"na\"; comments: string }>>({});\n\n  // Filter state\n  const [stageFilter, setStageFilter] = useState<string>(\"all\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n\n  // Fetch inspection detail (MUST be declared before using inspection variable)\n  const { data: inspection, isLoading, refetch } = trpc.checklist.getInspectionDetail.useQuery(\n    { inspectionId: inspectionId! },\n    { enabled: !!inspectionId }\n  );\n\n  const pdfMutation = trpc.checklist.generateInspectionPDF.useMutation();\n\n  // Update checklist item mutation\n  const updateItemMutation = trpc.checklist.updateChecklistItem.useMutation({\n    onSuccess: () => {\n      toast.success(\"\");\n      // Clear editing state\n      setEditingItemId(null);\n      refetch();\n    },\n    onError: (error) => {\n      toast.error(`: ${error.message}`);\n    },\n  });\n\n  // Initialize item states from inspection data\n  useEffect(() => {\n    if (inspection?.items) {\n      const initialStates: Record<number, { result: \"pass\" | \"fail\" | \"na\"; comments: string }> = {};\n      inspection.items.forEach((item: any) => {\n        initialStates[item.id] = {\n          result: item.result,\n          comments: item.comments || \"\",\n        };\n      });\n      setItemStates(initialStates);\n    }\n  }, [inspection?.items]);\n\n  // Filter items by stage and status\n  const filteredItems = useMemo(() => {\n    if (!inspection?.items) {\n      console.log('[InspectionDetail] No inspection.items found');\n      return [];\n    }\n    console.log(`[InspectionDetail] Total items: ${inspection.items.length}, Stage: ${inspection.stage}, Filters: stage=${stageFilter}, status=${statusFilter}`);\n    const filtered = inspection.items.filter((item: any) => {\n      const stageMatch = stageFilter === \"all\" || inspection.stage === stageFilter;\n      const statusMatch = statusFilter === \"all\" || item.result === statusFilter;\n      return stageMatch && statusMatch;\n    });\n    console.log(`[InspectionDetail] Filtered items: ${filtered.length}`);\n    return filtered;\n  }, [inspection?.items, inspection?.stage, stageFilter, statusFilter]);\n\n  // Handle update item state\n  const handleUpdateItemState = (itemId: number, field: \"result\" | \"comments\", value: any) => {\n    setItemStates(prev => ({\n      ...prev,\n      [itemId]: {\n        ...prev[itemId],\n        [field]: value,\n      },\n    }));\n  };\n\n  // Handle save item\n  const handleSaveItem = (item: any) => {\n    const state = itemStates[item.id];\n    if (!state) return;\n    \n    updateItemMutation.mutate({\n      itemResultId: item.id,\n      result: state.result,\n      comments: state.comments,\n    });\n  };\n\n  // Check if item has changes\n  const hasChanges = (item: any) => {\n    const state = itemStates[item.id];\n    if (!state) return false;\n    return state.result !== item.result || state.comments !== (item.comments || \"\");\n  };\n\n  const handleDownloadPDF = async () => {\n    if (!inspectionId) return;\n    \n    const toastId = toast.loading(\" PDF...\");\n    \n    try {\n      const result = await pdfMutation.mutateAsync({ inspectionId });\n      \n      if (result?.html) {\n        toast.success(\" PDF \", { id: toastId });\n        \n        // Open HTML in new window for printing\n        const printWindow = window.open(\"\", \"_blank\");\n        if (printWindow) {\n          printWindow.document.write(result.html);\n          printWindow.document.close();\n          // Trigger print dialog after a short delay\n          setTimeout(() => {\n            printWindow.print();\n          }, 500);\n        } else {\n          toast.error(\"  popup\", { id: toastId });\n        }\n      } else {\n        toast.error(\" PDF\", { id: toastId });\n      }\n    } catch (error: any) {\n      console.error(\"Error generating PDF:\", error);\n      const errorMessage = error?.message || \" PDF\";\n      toast.error(errorMessage, { id: toastId });\n    }\n  };\n\n  if (authLoading || isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!inspection) {\n    return (\n      <div className=\"container py-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <p className=\"text-center text-muted-foreground\"></p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container py-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigate(`/inspections`)}\n            className=\"mb-2\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            \n          </Button>\n          <h1 className=\"text-3xl font-bold\"> #{inspection.id}</h1>\n        </div>\n        <Button onClick={handleDownloadPDF} disabled={pdfMutation.isPending}>\n          {pdfMutation.isPending ? (\n            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n          ) : (\n            <Download className=\"h-4 w-4 mr-2\" />\n          )}\n           PDF\n        </Button>\n      </div>\n\n      {/* Inspection Info */}\n      <Card>\n        <CardHeader>\n          <CardTitle></CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <FileText className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">:</span>\n              <span>{inspection.projectName || \"-\"}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <FileText className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">:</span>\n              <span>{inspection.taskName || \"-\"}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <FileText className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">Checklist:</span>\n              <span>{inspection.templateName || \"-\"}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-medium\">:</span>\n              {getStageBadge(inspection.stage)}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-medium\">:</span>\n              {getStatusBadge(inspection.status)}\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">:</span>\n              <span>{inspection.inspectorName || \"-\"}</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">:</span>\n              <span>\n                {inspection.inspectedAt\n                  ? format(new Date(inspection.inspectedAt), \"dd MMM yyyy HH:mm\", { locale: th })\n                  : \"-\"}\n              </span>\n            </div>\n          </div>\n\n          {inspection.generalComments && (\n            <>\n              <Separator />\n              <div>\n                <span className=\"font-medium\">:</span>\n                <p className=\"mt-2 text-muted-foreground\">{inspection.generalComments}</p>\n              </div>\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Checklist Items */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle></CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <Filter className=\"h-4 w-4 text-muted-foreground\" />\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-[150px]\">\n                  <SelectValue placeholder=\"\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\"></SelectItem>\n                  <SelectItem value=\"pass\"></SelectItem>\n                  <SelectItem value=\"fail\"></SelectItem>\n                  <SelectItem value=\"na\">N/A</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {filteredItems && filteredItems.length > 0 ? (\n            <div className=\"space-y-4\">\n              {filteredItems.map((item: any, index: number) => {\n                const photos = parsePhotoUrls(item.photoUrls);\n                const isEditing = editingItemId === item.id;\n                const currentState = itemStates[item.id] || { result: item.result, comments: item.comments || \"\" };\n                const canEdit = user && (user.role === \"admin\" || user.role === \"qc_inspector\");\n                \n                return (\n                  <div key={item.id} className=\"border rounded-lg p-4 space-y-3\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-sm font-medium text-muted-foreground\">#{index + 1}</span>\n                          <h3 className=\"font-medium\">{item.itemName}</h3>\n                        </div>\n                      </div>\n                      {!isEditing && (\n                        <div className=\"flex items-center gap-2\">\n                          {getResultIcon(item.result)}\n                          {getResultBadge(item.result)}\n                          {canEdit && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setEditingItemId(item.id)}\n                            >\n                              <Pencil className=\"h-4 w-4\" />\n                            </Button>\n                          )}\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Editing mode */}\n                    {isEditing && canEdit && (\n                      <div className=\"space-y-3 bg-muted/30 p-4 rounded-lg\">\n                        <div className=\"space-y-2\">\n                          <Label className=\"text-sm font-medium\"></Label>\n                          <RadioGroup \n                            value={currentState.result} \n                            onValueChange={(value: any) => handleUpdateItemState(item.id, \"result\", value)}\n                            className=\"flex gap-4\"\n                          >\n                            <div className=\"flex items-center space-x-2\">\n                              <RadioGroupItem value=\"pass\" id={`pass-${item.id}`} />\n                              <Label htmlFor={`pass-${item.id}`} className=\"flex items-center gap-2 cursor-pointer font-normal\">\n                                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                                \n                              </Label>\n                            </div>\n                            <div className=\"flex items-center space-x-2\">\n                              <RadioGroupItem value=\"fail\" id={`fail-${item.id}`} />\n                              <Label htmlFor={`fail-${item.id}`} className=\"flex items-center gap-2 cursor-pointer font-normal\">\n                                <XCircle className=\"h-4 w-4 text-red-600\" />\n                                \n                              </Label>\n                            </div>\n                            <div className=\"flex items-center space-x-2\">\n                              <RadioGroupItem value=\"na\" id={`na-${item.id}`} />\n                              <Label htmlFor={`na-${item.id}`} className=\"flex items-center gap-2 cursor-pointer font-normal\">\n                                <MinusCircle className=\"h-4 w-4 text-gray-400\" />\n                                N/A\n                              </Label>\n                            </div>\n                          </RadioGroup>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <Label htmlFor={`comments-${item.id}`} className=\"text-sm font-medium\">/</Label>\n                          <Textarea\n                            id={`comments-${item.id}`}\n                            value={currentState.comments}\n                            onChange={(e) => handleUpdateItemState(item.id, \"comments\", e.target.value)}\n                            placeholder=\" ()\"\n                            rows={3}\n                            className=\"resize-none\"\n                          />\n                        </div>\n                        <div className=\"flex gap-2 justify-end\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              setEditingItemId(null);\n                              // Reset to original values\n                              setItemStates(prev => ({\n                                ...prev,\n                                [item.id]: {\n                                  result: item.result,\n                                  comments: item.comments || \"\",\n                                },\n                              }));\n                            }}\n                          >\n                            \n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            onClick={() => {\n                              handleSaveItem(item);\n                              setEditingItemId(null);\n                            }}\n                            disabled={updateItemMutation.isPending || !hasChanges(item)}\n                          >\n                            {updateItemMutation.isPending ? (\n                              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                            ) : null}\n                            \n                          </Button>\n                        </div>\n                      </div>\n                    )}\n\n                    {/* View mode - show comments if exists */}\n                    {!isEditing && item.comments && (\n                      <div className=\"text-sm text-muted-foreground bg-muted/30 p-3 rounded\">\n                        <span className=\"font-medium\">: </span>\n                        {item.comments}\n                      </div>\n                    )}\n\n\n\n                    {photos.length > 0 && (\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n                        {photos.map((photoUrl: string, photoIndex: number) => (\n                          <div\n                            key={photoIndex}\n                            className=\"relative aspect-square rounded-lg overflow-hidden border cursor-pointer hover:opacity-80 transition-opacity\"\n                            onClick={() => {\n                              setGalleryImages(photos.map(url => ({ url })));\n                              setGalleryInitialIndex(photoIndex);\n                              setGalleryOpen(true);\n                            }}\n                          >\n                            <img\n                              src={photoUrl}\n                              alt={`Photo ${photoIndex + 1}`}\n                              className=\"w-full h-full object-cover\"\n                            />\n                            <div className=\"absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/10 transition-colors\">\n                              <ImageIcon className=\"h-6 w-6 text-white opacity-0 hover:opacity-100\" />\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              {inspection.items && inspection.items.length > 0 \n                ? \"\" \n                : \"\"}\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n\n\n      {/* Image Gallery */}\n      <ImageGalleryViewer\n        open={galleryOpen}\n        images={galleryImages}\n        initialIndex={galleryInitialIndex}\n        onClose={() => setGalleryOpen(false)}\n      />\n    </div>\n  );\n}\n",
    "package.json": "{\n  \"name\": \"construction_management_app\",\n  \"version\": \"1.0.0\",\n  \"type\": \"module\",\n  \"license\": \"MIT\",\n  \"scripts\": {\n    \"dev\": \"ulimit -n 65536 && NODE_OPTIONS='--max-old-space-size=4096' nodemon\",\n    \"dev:notsc\": \"ulimit -n 65536 && NODE_ENV=development NODE_OPTIONS='--max-old-space-size=4096' TSC_COMPILE_ON_ERROR=true nodemon\",\n    \"build\": \"NODE_ENV=production NODE_OPTIONS='--max-old-space-size=4096' vite build && esbuild server/_core/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist\",\n    \"build:analyze\": \"NODE_ENV=production vite build --mode analyze\",\n    \"start\": \"NODE_ENV=production node --max-old-space-size=4096 dist/index.js\",\n    \"check\": \"tsc --noEmit\",\n    \"check:watch\": \"tsc --noEmit --watch\",\n    \"type-check\": \"tsc --noEmit\",\n    \"type-check:watch\": \"tsc --noEmit --watch\",\n    \"type-check:strict\": \"tsc --noEmit --strict\",\n    \"validate\": \"pnpm type-check\",\n    \"format\": \"prettier --write .\",\n    \"test\": \"vitest run\",\n    \"test:watch\": \"vitest\",\n    \"test:ui\": \"vitest --ui\",\n    \"test:integration\": \"vitest run tests/integration\",\n    \"test:e2e\": \"playwright test\",\n    \"test:e2e:ui\": \"playwright test --ui\",\n    \"test:e2e:headed\": \"playwright test --headed\",\n    \"test:e2e:debug\": \"playwright test --debug\",\n    \"db:push\": \"drizzle-kit generate && drizzle-kit migrate\",\n    \"health\": \"bash scripts/health-check.sh\",\n    \"monitor:memory\": \"bash scripts/monitor-memory.sh\",\n    \"monitor:memory:node\": \"node scripts/monitor-memory.mjs\",\n    \"load:test\": \"node scripts/load-test.mjs\",\n    \"cleanup\": \"bash scripts/cleanup-processes.sh\",\n    \"reset\": \"bash scripts/emergency-reset.sh\",\n    \"predev\": \"lsof -ti:3001 | xargs kill -9 2>/dev/null || true\",\n    \"prepare\": \"husky\"\n  },\n  \"dependencies\": {\n    \"@aws-sdk/client-s3\": \"^3.693.0\",\n    \"@aws-sdk/s3-request-presigner\": \"^3.693.0\",\n    \"@dnd-kit/core\": \"^6.3.1\",\n    \"@dnd-kit/sortable\": \"^10.0.0\",\n    \"@dnd-kit/utilities\": \"^3.2.2\",\n    \"@hookform/resolvers\": \"^5.2.2\",\n    \"@pdf-lib/fontkit\": \"^1.1.1\",\n    \"@radix-ui/react-accordion\": \"^1.2.12\",\n    \"@radix-ui/react-alert-dialog\": \"^1.1.15\",\n    \"@radix-ui/react-aspect-ratio\": \"^1.1.7\",\n    \"@radix-ui/react-avatar\": \"^1.1.10\",\n    \"@radix-ui/react-checkbox\": \"^1.3.3\",\n    \"@radix-ui/react-collapsible\": \"^1.1.12\",\n    \"@radix-ui/react-context-menu\": \"^2.2.16\",\n    \"@radix-ui/react-dialog\": \"^1.1.15\",\n    \"@radix-ui/react-dropdown-menu\": \"^2.1.16\",\n    \"@radix-ui/react-hover-card\": \"^1.1.15\",\n    \"@radix-ui/react-label\": \"^2.1.7\",\n    \"@radix-ui/react-menubar\": \"^1.1.16\",\n    \"@radix-ui/react-navigation-menu\": \"^1.2.14\",\n    \"@radix-ui/react-popover\": \"^1.1.15\",\n    \"@radix-ui/react-progress\": \"^1.1.7\",\n    \"@radix-ui/react-radio-group\": \"^1.3.8\",\n    \"@radix-ui/react-scroll-area\": \"^1.2.10\",\n    \"@radix-ui/react-select\": \"^2.2.6\",\n    \"@radix-ui/react-separator\": \"^1.1.7\",\n    \"@radix-ui/react-slider\": \"^1.3.6\",\n    \"@radix-ui/react-slot\": \"^1.2.3\",\n    \"@radix-ui/react-switch\": \"^1.2.6\",\n    \"@radix-ui/react-tabs\": \"^1.1.13\",\n    \"@radix-ui/react-toggle\": \"^1.1.10\",\n    \"@radix-ui/react-toggle-group\": \"^1.1.11\",\n    \"@radix-ui/react-tooltip\": \"^1.2.8\",\n    \"@tanstack/react-query\": \"^5.90.2\",\n    \"@tremor/react\": \"^3.18.7\",\n    \"@trpc/client\": \"^11.6.0\",\n    \"@trpc/react-query\": \"^11.6.0\",\n    \"@trpc/server\": \"^11.6.0\",\n    \"@types/node-cron\": \"^3.0.11\",\n    \"axios\": \"^1.12.0\",\n    \"clamscan\": \"^2.4.0\",\n    \"class-variance-authority\": \"^0.7.1\",\n    \"clsx\": \"^2.1.1\",\n    \"cmdk\": \"^1.1.1\",\n    \"cookie\": \"^1.0.2\",\n    \"cookie-parser\": \"^1.4.7\",\n    \"csurf\": \"^1.11.0\",\n    \"date-fns\": \"^4.1.0\",\n    \"dotenv\": \"^17.2.2\",\n    \"drizzle-orm\": \"^0.44.7\",\n    \"embla-carousel-react\": \"^8.6.0\",\n    \"exceljs\": \"^4.4.0\",\n    \"express\": \"^4.21.2\",\n    \"express-rate-limit\": \"^8.2.1\",\n    \"framer-motion\": \"^12.23.22\",\n    \"frappe-gantt\": \"^1.0.4\",\n    \"html2canvas\": \"^1.4.1\",\n    \"idb\": \"^8.0.3\",\n    \"input-otp\": \"^1.4.2\",\n    \"jose\": \"6.1.0\",\n    \"jspdf\": \"^3.0.3\",\n    \"jspdf-autotable\": \"^5.0.2\",\n    \"lucide-react\": \"^0.453.0\",\n    \"multer\": \"^2.0.2\",\n    \"mysql2\": \"^3.15.0\",\n    \"nanoid\": \"^5.1.5\",\n    \"next-themes\": \"^0.4.6\",\n    \"node-cron\": \"^4.2.1\",\n    \"nodemailer\": \"^7.0.10\",\n    \"pdfkit\": \"^0.17.2\",\n    \"react\": \"^19.1.1\",\n    \"react-day-picker\": \"^9.11.1\",\n    \"react-dom\": \"^19.1.1\",\n    \"react-gantt-chart\": \"0.3.0-rc.11\",\n    \"react-hook-form\": \"^7.64.0\",\n    \"react-resizable-panels\": \"^3.0.6\",\n    \"react-window\": \"^2.2.3\",\n    \"recharts\": \"^2.15.4\",\n    \"socket.io\": \"^4.8.1\",\n    \"socket.io-client\": \"^4.8.1\",\n    \"sonner\": \"^2.0.7\",\n    \"streamdown\": \"^1.4.0\",\n    \"superjson\": \"^1.13.3\",\n    \"tailwind-merge\": \"^3.3.1\",\n    \"tailwindcss-animate\": \"^1.0.7\",\n    \"vaul\": \"^1.1.2\",\n    \"web-push\": \"^3.6.7\",\n    \"wouter\": \"^3.3.5\",\n    \"zod\": \"^4.1.12\"\n  },\n  \"devDependencies\": {\n    \"@builder.io/vite-plugin-jsx-loc\": \"^0.1.1\",\n    \"@eslint/js\": \"^9.39.1\",\n    \"@playwright/test\": \"^1.56.1\",\n    \"@tailwindcss/typography\": \"^0.5.15\",\n    \"@tailwindcss/vite\": \"^4.1.3\",\n    \"@types/cookie-parser\": \"^1.4.10\",\n    \"@types/express\": \"4.17.21\",\n    \"@types/frappe-gantt\": \"^0.9.0\",\n    \"@types/multer\": \"^2.0.0\",\n    \"@types/node\": \"^24.7.0\",\n    \"@types/nodemailer\": \"^7.0.3\",\n    \"@types/pdfkit\": \"^0.17.3\",\n    \"@types/react\": \"^19.1.16\",\n    \"@types/react-dom\": \"^19.1.9\",\n    \"@types/react-window\": \"^2.0.0\",\n    \"@types/web-push\": \"^3.6.4\",\n    \"@typescript-eslint/eslint-plugin\": \"^8.46.4\",\n    \"@typescript-eslint/parser\": \"^8.46.4\",\n    \"@vitejs/plugin-react\": \"^5.0.4\",\n    \"@vitest/ui\": \"^4.0.9\",\n    \"add\": \"^2.0.6\",\n    \"autoprefixer\": \"^10.4.20\",\n    \"drizzle-kit\": \"^0.31.7\",\n    \"esbuild\": \"^0.25.0\",\n    \"eslint\": \"^9.39.1\",\n    \"husky\": \"^9.1.7\",\n    \"lint-staged\": \"^16.2.6\",\n    \"nodemon\": \"^3.1.11\",\n    \"playwright\": \"^1.56.1\",\n    \"pnpm\": \"^10.15.1\",\n    \"postcss\": \"^8.4.47\",\n    \"prettier\": \"^3.6.2\",\n    \"rollup-plugin-visualizer\": \"^6.0.5\",\n    \"sharp\": \"^0.34.5\",\n    \"tailwindcss\": \"^4.1.14\",\n    \"tsx\": \"^4.20.6\",\n    \"tw-animate-css\": \"^1.4.0\",\n    \"typescript\": \"5.9.3\",\n    \"vite\": \"^7.2.2\",\n    \"vite-plugin-manus-runtime\": \"^0.0.55\",\n    \"vite-plugin-pwa\": \"^1.1.0\",\n    \"vitest\": \"^4.0.9\",\n    \"workbox-window\": \"^7.3.0\"\n  },\n  \"packageManager\": \"pnpm@10.4.1+sha512.c753b6c3ad7afa13af388fa6d808035a008e30ea9993f58c6663e2bc5ff21679aa834db094987129aa4d488b86df57f7b634981b2f827cdcacc698cc0cfb88af\",\n  \"lint-staged\": {\n    \"*.{ts,tsx}\": [\n      \"prettier --write\",\n      \"eslint --fix\"\n    ],\n    \"*.{json,md}\": [\n      \"prettier --write\"\n    ]\n  },\n  \"pnpm\": {\n    \"patchedDependencies\": {\n      \"wouter@3.7.1\": \"patches/wouter@3.7.1.patch\"\n    },\n    \"overrides\": {\n      \"tailwindcss>nanoid\": \"3.3.7\"\n    },\n    \"onlyBuiltDependencies\": [\n      \"sharp\"\n    ]\n  }\n}\n",
    "tsconfig.json": "{\n  \"include\": [\"client/src/**/*\", \"shared/**/*\", \"server/**/*\"],\n  \"exclude\": [\"node_modules\", \"build\", \"dist\", \"**/*.test.ts\"],\n  \"compilerOptions\": {\n    \"incremental\": true,\n    \"tsBuildInfoFile\": \"./node_modules/typescript/tsbuildinfo\",\n    \"noEmit\": true,\n    \"module\": \"ESNext\",\n    \"strict\": true,\n    \"noImplicitAny\": true,\n    \"strictNullChecks\": true,\n    \"strictFunctionTypes\": true,\n    \"strictBindCallApply\": true,\n    \"strictPropertyInitialization\": true,\n    \"noImplicitThis\": true,\n    \"alwaysStrict\": true,\n    \"noUnusedLocals\": false,\n    \"noUnusedParameters\": false,\n    \"noImplicitReturns\": true,\n    \"noFallthroughCasesInSwitch\": true,\n    \"lib\": [\"esnext\", \"dom\", \"dom.iterable\"],\n    \"jsx\": \"preserve\",\n    \"esModuleInterop\": true,\n    \"skipLibCheck\": true,\n    \"skipDefaultLibCheck\": true,\n    \"allowImportingTsExtensions\": true,\n    \"moduleResolution\": \"bundler\",\n    \"baseUrl\": \".\",\n    \"types\": [\"node\", \"vite/client\"],\n    \"paths\": {\n      \"@/*\": [\"./client/src/*\"],\n      \"@shared/*\": [\"./shared/*\"]\n    }\n  }\n}\n",
    "vite.config.ts": "import { jsxLocPlugin } from \"@builder.io/vite-plugin-jsx-loc\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport react from \"@vitejs/plugin-react\";\nimport fs from \"node:fs\";\nimport path from \"path\";\nimport { defineConfig } from \"vite\";\nimport { vitePluginManusRuntime } from \"vite-plugin-manus-runtime\";\nimport { VitePWA } from \"vite-plugin-pwa\";\nimport { visualizer } from \"rollup-plugin-visualizer\";\n\n\nconst plugins = [\n  react(),\n  tailwindcss(),\n  jsxLocPlugin(),\n  vitePluginManusRuntime(),\n  // Bundle analyzer - run with ANALYZE=true pnpm build\n  process.env.ANALYZE === 'true' && visualizer({\n    filename: './dist/stats.html',\n    open: false,\n    gzipSize: true,\n    brotliSize: true,\n  }),\n  VitePWA({\n    registerType: \"autoUpdate\",\n    includeAssets: [\"favicon.ico\", \"apple-touch-icon.png\", \"mask-icon.svg\"],\n    manifest: {\n      name: \"Construction Management & QC Platform\",\n      short_name: \"ConstructionQC\",\n      description: \" (QC) \",\n      theme_color: \"#ffffff\",\n      background_color: \"#ffffff\",\n      display: \"standalone\",\n      orientation: \"portrait\",\n      icons: [\n        {\n          src: \"pwa-192x192.png\",\n          sizes: \"192x192\",\n          type: \"image/png\",\n        },\n        {\n          src: \"pwa-512x512.png\",\n          sizes: \"512x512\",\n          type: \"image/png\",\n        },\n        {\n          src: \"pwa-512x512.png\",\n          sizes: \"512x512\",\n          type: \"image/png\",\n          purpose: \"any maskable\",\n        },\n      ],\n    },\n    workbox: {\n      globPatterns: [\"**/*.{js,css,html,ico,png,svg,woff,woff2}\"],\n      maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5 MB\n      runtimeCaching: [\n        {\n          urlPattern: /^https:\\/\\/fonts\\.googleapis\\.com\\/.*/i,\n          handler: \"CacheFirst\",\n          options: {\n            cacheName: \"google-fonts-cache\",\n            expiration: {\n              maxEntries: 10,\n              maxAgeSeconds: 60 * 60 * 24 * 365, // 1 year\n            },\n            cacheableResponse: {\n              statuses: [0, 200],\n            },\n          },\n        },\n        {\n          urlPattern: /^https:\\/\\/fonts\\.gstatic\\.com\\/.*/i,\n          handler: \"CacheFirst\",\n          options: {\n            cacheName: \"gstatic-fonts-cache\",\n            expiration: {\n              maxEntries: 10,\n              maxAgeSeconds: 60 * 60 * 24 * 365, // 1 year\n            },\n            cacheableResponse: {\n              statuses: [0, 200],\n            },\n          },\n        },\n        {\n          urlPattern: /^\\/api\\/trpc\\/.*/i,\n          handler: \"NetworkFirst\",\n          options: {\n            cacheName: \"api-cache\",\n            networkTimeoutSeconds: 10,\n            expiration: {\n              maxEntries: 50,\n              maxAgeSeconds: 60 * 5, // 5 minutes\n            },\n            cacheableResponse: {\n              statuses: [0, 200],\n            },\n          },\n        },\n      ],\n    },\n    devOptions: {\n      enabled: true,\n      type: \"module\",\n    },\n  }),\n];\n\nexport default defineConfig({\n  plugins,\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  envDir: path.resolve(import.meta.dirname),\n  root: path.resolve(import.meta.dirname, \"client\"),\n  publicDir: path.resolve(import.meta.dirname, \"client\", \"public\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n    rollupOptions: {\n      output: {\n        manualChunks: (id): string | undefined => {\n          if (id.includes('node_modules')) {\n            // React core\n            if (id.includes('react') || id.includes('react-dom') || id.includes('scheduler')) {\n              return 'react-vendor';\n            }\n            // tRPC and React Query\n            if (id.includes('@trpc') || id.includes('@tanstack/react-query')) {\n              return 'trpc-vendor';\n            }\n            // Charts\n            if (id.includes('recharts') || id.includes('d3-')) {\n              return 'chart-vendor';\n            }\n            // Radix UI components\n            if (id.includes('@radix-ui')) {\n              return 'ui-vendor';\n            }\n            // Icons\n            if (id.includes('lucide-react')) {\n              return 'icon-vendor';\n            }\n            // Date utilities\n            if (id.includes('date-fns')) {\n              return 'date-vendor';\n            }\n            // Form handling\n            if (id.includes('react-hook-form') || id.includes('zod') || id.includes('@hookform')) {\n              return 'form-vendor';\n            }\n            // Gantt chart (split separately due to size)\n            if (id.includes('frappe-gantt') || id.includes('gantt')) {\n              return 'gantt-vendor';\n            }\n            // Other large libraries\n            if (id.includes('framer-motion')) {\n              return 'animation-vendor';\n            }\n            if (id.includes('xlsx')) {\n              return 'xlsx-vendor';\n            }\n            // PDF generation\n            if (id.includes('jspdf') || id.includes('html2canvas')) {\n              return 'pdf-vendor';\n            }\n            // Socket.io\n            if (id.includes('socket.io-client')) {\n              return 'socket-vendor';\n            }\n            // Everything else\n            return 'vendor';\n          }\n          return undefined;\n        },\n      },\n    },\n    chunkSizeWarningLimit: 1500,\n    sourcemap: false,\n    minify: 'esbuild',\n    target: 'es2020',\n    // Additional optimization settings\n    cssCodeSplit: true, // Split CSS into separate files\n    reportCompressedSize: true, // Report compressed bundle sizes\n    // Tree shaking optimization\n    modulePreload: {\n      polyfill: false, // Disable polyfill for modern browsers\n    },\n  },\n  server: {\n    host: true,\n    hmr: false,\n    allowedHosts: [\n      \".manuspre.computer\",\n      \".manus.computer\",\n      \".manus-asia.computer\",\n      \".manuscomputer.ai\",\n      \".manusvm.computer\",\n      \"localhost\",\n      \"127.0.0.1\",\n    ],\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n    watch: {\n      usePolling: false,\n      ignored: [\n        \"**/node_modules/**\",\n        \"**/.git/**\",\n        \"**/dist/**\",\n        \"**/build/**\",\n        \"**/.cache/**\",\n        \"**/coverage/**\",\n        \"**/server/**\",\n        \"**/drizzle/**\",\n        \"**/todo.md\",\n        \"**/ideas.md\",\n        \"**/*.log\",\n      ],\n    },\n  },\n});\n"
  },
  "todo_summary": "# Construction Management & QC Platform - TODO List\n\n##  \n\n**:**   95%  \n**:**    \n**:**    \n**:**   3 \n\n---\n\n##  \n\n###  Core Features (100%)\n- [x]  (Projects Management)\n- [x]  (Tasks Management)\n- [x]  Task Dependencies (Finish-to-Start)\n- [x]  Task Assignment  Status Workflow\n- [x]  Checklist Templates (3 stages: Pre, In-progress, Post)\n- [x]  QC Inspection Workflow (Pass/Fail/N/A)\n- [x]  Defect/Rectification Workflow  Re-inspection\n- [x]  Task Comments  @mention\n- [x]  File Attachments (S3 Storage)\n- [x]  Activity Log  Notifications\n- [x]  Deadline Reminders  Overdue Notifications\n- [x]  Follow Task\n- [x] \n- [x]  Plan vs Actual Progress\n- [x]  (On Track/Ahead/Behind)\n- [x]  Task Dependencies\n- [x]  Draft Project Support\n\n###  User Management (100%)\n- [x]  (User Management)\n- [x]  (Admin/PM/QC/Worker)\n- [x] \n- [x]  Bulk User Import (CSV/Excel)\n- [x]  Granular Permissions Management\n- [x]  User Activity Log  Filtering\n- [x]  Role Templates (5 default templates)\n- [x]  Export Activity Log (Excel/PDF)\n- [x]  Role-based Permissions (Admin/PM/QC/Worker)\n\n###  Frontend UI (100%)\n- [x] Dashboard  Statistics  Charts\n- [x] Project Dashboard  Overview Cards\n- [x] Mobile-responsive Task List  Detail Views\n- [x] QC Inspection Interface (Step-by-step Workflow)\n- [x] Defect Tracking UI  Before/After Photos\n- [x] Notification Center  Real-time Updates\n- [x] Gantt Chart Visualization (Standard + Enhanced)\n- [x] File Upload  Camera Integration\n- [x] Checklist Template Builder  Edit Functionality\n- [x] Inspection History  Detail Views\n- [x] PDF Report Generation  Inspections\n- [x] Digital Signature Functionality\n- [x] User Profile  Settings\n- [x] Tasks Overview Widget  Filtering\n- [x] Inspections Overview Widget  Status Breakdown\n- [x] Defects Overview Widget  Priority Tracking\n- [x] Recent Activity Feed Component\n- [x] Upcoming Milestones Component\n- [x] Quality Metrics & Trends Component\n- [x] Timeline/Gantt Chart Integration\n- [x] Document Status Component\n- [x] Advanced Analytics Component\n\n###  Notification & Escalation (100%)\n- [x]  Checklist Item \n- [x]  Escalation Rules Management\n- [x]  Escalation Logs\n- [x]  Cron Job  Escalation\n- [x]  Escalation  Failed Inspections\n- [x]  Escalation  Unresolved Defects\n- [x]  Escalation  Overdue Tasks\n- [x] UI  Escalation Rules (Admin Only)\n- [x] UI  Escalation Logs\n\n###  Analytics & Reports (100%)\n- [x] Inspection Statistics (Pass/Fail Rate, Trends)\n- [x] Pass/Fail Rate Chart\n- [x] Defect Categories Breakdown\n- [x] Timeline Trends Chart\n- [x] Inspector Performance Table\n- [x] Checklist Item Statistics\n- [x] Advanced Analytics Dashboard\n- [x] Export Functionality (Excel/PDF)\n\n###  Performance & Optimization (100%)\n- [x] Database Query Optimization ( N+1 Problems)\n- [x] Database Indexes  Queries \n- [x] Batch Queries (getBatchProjectStats, getBatchChecklistTemplateItems)\n- [x] Lazy Loading  Pagination (Projects, Tasks, Inspections, Defects)\n- [x] Image Optimization (Compression, Lazy Loading, Thumbnails)\n- [x] Bundle Size Optimization (Code Splitting, Dynamic Imports)\n- [x] Skeleton Loaders  Components\n- [x] Loading Indicators  Mutations\n\n###  Security & Error Handling (100%)\n- [x] Centralized Error Handling (Client + Server)\n- [x] ErrorBoundary  Component Tree\n- [x] User-friendly Error Messages ()\n- [x] Input Validation (Zod Schemas)\n- [x] Input Sanitization (HTML, SQL, XSS)\n- [x] SQL Injection Prevention (Drizzle ORM)\n- [x] File Upload Security (Type, Size, Extension Validation)\n- [x] Rate Limiting Middleware\n- [x] Security Headers (XSS, Clickjacking, MIME Sniffing)\n- [x] Structured Logging  Backend\n- [x] Error Tracking System (error_logs Table)\n- [x] Error Tracking Dashboard  Admin\n- [x] CSRF Protection\n- [x] Virus Scanning (ClamAV)  File Uploads\n\n###  Mobile Experience (100%)\n- [x] Touch Gestures (Swipe, Long Press, Pinch Zoom)\n- [x] Pull-to-Refresh Component\n- [x] Load More Button Component\n- [x] MobileCamera Component  Preview\n- [x] Image Compression Utility\n- [x] Offline Queue (useOfflineQueue Hook)\n- [x] Conflict Resolution  Offline Sync\n- [x] OfflineSyncStatus Component\n- [x] PWA Support  Offline Capabilities\n- [x] Mobile Bottom Navigation\n\n###  UX Improvements (100%)\n- [x] Breadcrumbs Navigation System\n- [x] Keyboard Shortcuts (Ctrl+K, G+I, etc.)\n- [x] Keyboard Shortcuts Help Modal (?  Ctrl+/)\n- [x] Offline Indicator\n\n###  Testing (70%)\n- [x] Unit Tests  Business Logic (63 tests)\n- [x] Tests  tRPC Procedures\n- [x] Tests  Database Helpers\n- [x] Integration Tests  Critical Workflows\n- [x] E2E Tests  Playwright\n\n---\n\n##  Service Layer Refactoring (100%)\n- [x]  db/client.ts  connection pooling\n- [x]  project.service.ts  CRUD operations\n- [x]  task.service.ts  Dependencies  Comments\n- [x]  defect.service.ts  Attachments\n- [x]  user.service.ts  Auth  Activity Logs\n- [x]  notification.service.ts  Templates\n- [x]  strict typing  proper error handling  service\n- [x]  business logic  routers\n\n---\n\n##  \n\n### 1.  Tasks -  2  3 \n**:**    \n**:**  (Inspection Detail)  1   2  3   \n**:**\n-  event handler  InspectionDetail.tsx\n-  state management  editing mode\n- \n\n### 2. TypeScript Errors - 296 Errors\n**:**    \n**:**  TypeScript errors   type definition issues  \n**:**\n-  `pnpm tsc --noEmit`  errors \n-  type definitions \n-  type imports \n\n### 3. Sample Data - Incomplete\n**:**   (70%)  \n**:**   database schema mismatch  \n**:**\n-   QC Templates (4 templates, 44 items)\n-   Project \" 5 \"\n-   Tasks (16 tasks)\n-   Database Migration ( 4 columns  taskChecklists)\n\n**:**\n-   Task Dependencies\n-   QC Inspections  Templates\n-   Defects  (3 defects)\n-   Inspection Workflow\n-   Defect Workflow\n\n---\n\n##   (Priority 2)\n\n### Testing Coverage\n- [ ] E2E Tests  Mobile Workflows\n- [ ] Load Testing  Load \n- [ ] Performance Benchmarks\n\n### UX Improvements\n- [ ]  Empty States  Call-to-Action \n- [ ]  Illustrations  Empty States\n- [ ]  Field-level Error Messages\n- [ ] Undo Functionality  Critical Actions\n- [ ] Confirmation Dialogs  Destructive Actions\n\n### Mobile Experience\n- [ ] Infinite Scroll  Mobile View\n- [ ] GPS Accuracy  Location Tagging\n- [ ] Location Accuracy Indicator\n- [ ] Manual Location Correction\n- [ ]  Touch Gestures  Mobile Devices\n- [ ]  Mobile Navigation  Mobile Devices\n\n### Dashboard Enhancement\n- [ ] Custom Widgets System\n- [ ]  Pagination  (100+ records)\n\n---\n\n##   Routes \n\n###  (Sidebar Navigation)\n1. **Dashboard**  `/dashboard` \n2. **Projects**  `/projects` \n3. **Tasks**  `/tasks` \n4. **Inspections**  `/inspections` \n5. **Defects**  `/defects` \n6. **Templates**  `/templates` \n7. **Reports**  `/reports` \n8. **Escalation Settings**  `/escalation-settings`  (Admin Only)\n9. **Escalation Logs**  `/escalation-logs`  (Admin Only)\n10. **User Management**  `/user-management`  (Admin Only)\n11. **Analytics**  `/analytics` \n\n### Hidden/Utility Routes ( Menu)\n- `/notifications` - Notification Center\n- `/profile` - User Profile\n- `/settings` - Settings\n- `/settings/notifications` - Notification Settings\n- `/projects/new` - New Project Form\n- `/tasks/new` - New Task Form\n- `/templates/new` - New Template Form\n- `/projects/:id` - Project Detail\n- `/tasks/:id` - Task Detail\n- `/defects/:id` - Defect Detail\n- `/inspections/:inspectionId` - Inspection Detail\n- `/tasks/:taskId/inspections` - Inspection History\n- `/bulk-user-import` - Bulk User Import\n- `/permissions-management` - Permissions Management\n- `/user-activity-log` - User Activity Log\n- `/role-templates` - Role Templates\n- `/gantt` - Gantt Chart\n- `/inspection-statistics` - Inspection Statistics\n- `/error-tracking` - Error Tracking Dashboard\n\n### Deprecated/Removed Routes\n-  `/ceo-dashboard` -  ()\n-  `/qc` -  `/inspections`\n-  `/qc-inspection` -  `/inspections`\n-  `/checklist-templates` -  `/templates`\n-  `/dashboard-old` -  `/dashboard` \n\n---\n\n##  Database Schema\n\n** Tables:** 38 tables\n\n### Core Tables\n- `users` - \n- `projects` - \n- `tasks` - \n- `taskDependencies` - \n- `taskAssignments` - \n- `taskComments` - \n- `taskAttachments` - \n- `taskFollowers` - \n\n### QC & Inspection Tables\n- `checklistTemplates` - Template \n- `checklistTemplateItems` -  Template\n- `taskChecklists` - \n- `checklistItemResults` - \n- `qcChecklists` - QC Checklist (Legacy)\n- `qcChecklistItems` - QC Checklist Items (Legacy)\n- `qcInspections` - QC Inspections (Legacy)\n- `qcInspectionResults` - QC Ins"
}