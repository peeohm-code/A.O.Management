{
  "summary": {
    "project_info": {
      "name": "Construction Management & QC Platform",
      "path": "/home/ubuntu/construction_management_app"
    },
    "critical_issues": [],
    "file_statistics": {
      "large_files": [
        {
          "path": "server/db.ts",
          "lines": 7618
        },
        {
          "path": "client/src/pages/Defects.tsx",
          "lines": 1866
        },
        {
          "path": "client/src/pages/DefectDetail.tsx",
          "lines": 1730
        },
        {
          "path": "client/src/pages/ComponentShowcase.tsx",
          "lines": 1437
        },
        {
          "path": "client/src/pages/QCInspection.tsx",
          "lines": 1136
        },
        {
          "path": "client/src/pages/Tasks.tsx",
          "lines": 936
        },
        {
          "path": "client/src/pages/TaskDetail.tsx",
          "lines": 864
        },
        {
          "path": "client/src/components/projects/ActiveProjectsList.tsx",
          "lines": 829
        },
        {
          "path": "drizzle/schema.ts",
          "lines": 812
        },
        {
          "path": "server/routers.ts",
          "lines": 741
        },
        {
          "path": "client/src/components/ui/sidebar.tsx",
          "lines": 734
        },
        {
          "path": "server/routers/checklistRouter.ts",
          "lines": 719
        },
        {
          "path": "server/routers/defectRouter.ts",
          "lines": 719
        },
        {
          "path": "client/src/pages/AdvancedAnalytics.tsx",
          "lines": 676
        },
        {
          "path": "client/src/pages/ChecklistTemplates.tsx",
          "lines": 669
        },
        {
          "path": "client/src/components/GanttChart.tsx",
          "lines": 625
        },
        {
          "path": "client/src/components/ChecklistsTab.tsx",
          "lines": 602
        },
        {
          "path": "server/repositories/project.repository.ts",
          "lines": 594
        },
        {
          "path": "server/routers/taskRouter.ts",
          "lines": 592
        },
        {
          "path": "client/src/pages/Dashboard.tsx",
          "lines": 580
        }
      ]
    },
    "code_health": {
      "typescript_errors": 0,
      "test_status": "needs_check"
    }
  },
  "critical_files": {
    "schema": {
      "path": "/home/ubuntu/construction_management_app/drizzle/schema.ts",
      "size": 32806,
      "lines": 812,
      "content_preview": "import { mysqlTable, mysqlSchema, AnyMySqlColumn, index, int, varchar, text, timestamp, mysqlEnum, tinyint } from \"drizzle-orm/mysql-core\"\nimport { sql } from \"drizzle-orm\"\n\nexport const activityLog = mysqlTable(\"activityLog\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tprojectId: int(),\n\ttaskId: int(),\n\tdefectId: int(),\n\taction: varchar({ length: 100 }).notNull(),\n\tresourceType: varchar({ length: 50 }),\n\tresourceId: int(),\n\toldValue: text(),\n\tnewValue: text(),\n\tipAddress: varchar({ length: 45 }),\n\tuserAgent: text(),\n\tdetails: text(),\n\tcreatedAt: timestamp({ mode: 'date' }).default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"userIdx\").on(table.userId),\n\tindex(\"projectIdx\").on(table.projectId),\n\tindex(\"taskIdx\").on(table.taskId),\n\tindex(\"defectIdx\").on(table.defectId),\n\tindex(\"actionIdx\").on(table.action),\n\tindex(\"createdAtIdx\").on(table.createdAt),\n]);\n\nexport const alertThresholds = mysqlTable(\"alertThresholds\", {\n\tid: int().autoincrement().notNull(),\n\tuserId: int().notNull(),\n\tmetricType: mysqlEnum(['cpu','memory']).notNull(),\n\tthreshold: int().notNull(),\n\tisEnabled: tinyint().default(1).notNull(),\n\tcreatedAt: timestamp({ mode: 'date' }).default(sql`CURRENT_TIMESTAMP`).notNull(),\n\tupdatedAt: timestamp({ mode: 'date' }).defaultNow().onUpdateNow().notNull(),\n},\n(table) => [\n\tindex(\"userMetricIdx\").on(table.userId, table.metricType),\n]);\n\nexport const approvalSteps = mysqlTable(\"approvalSteps\", {\n\tid: int().autoincrement().notNull(),\n\tapprovalId: int().notNull(),\n\tapproverId: int().notNull(),\n\tstatus: mysqlEnum(['pending','approved','rejected']).default('pending').notNull(),\n\tcomments: text(),\n\tsignatureData: text(),\n\tapprovedAt: timestamp({ mode: 'date' }),\n\tcreatedAt: timestamp({ mode: 'date' }).default(sql`CURRENT_TIMESTAMP`).notNull(),\n},\n(table) => [\n\tindex(\"approvalIdx\").on(table.approvalId),\n\tindex(\"approverIdx\").on(table.approverId),\n]);\n\nexport const approvals = mysqlTable(\"approvals\", {\n\tid: int().autoincrement().notNul"
    },
    "main_router": {
      "path": "/home/ubuntu/construction_management_app/server/routers.ts",
      "size": 22910,
      "lines": 741,
      "content_preview": "import { z } from \"zod\";\nimport { canEditDefect, canDeleteDefect } from \"@shared/permissions\";\nimport { TRPCError } from \"@trpc/server\";\nimport { boolToInt } from \"./utils/typeHelpers.js\";\nimport { COOKIE_NAME } from \"@shared/const\";\nimport {\n  validateTaskCreateInput,\n  validateTaskUpdateInput,\n  validateInspectionSubmission,\n  validateDefectCreateInput,\n  validateDefectUpdateInput,\n} from \"@shared/validationUtils\";\nimport { systemRouter } from \"./_core/systemRouter\";\nimport {\n  protectedProcedure,\n  publicProcedure,\n  router,\n  roleBasedProcedure,\n} from \"./_core/trpc\";\nimport * as db from \"./db\";\nimport * as analyticsService from \"./services/analytics.service\";\nimport {\n  generateProjectExport,\n  generateProjectReport,\n} from \"./downloadProject\";\nimport { generateArchiveExcel } from \"./excelExport\";\nimport { storagePut } from \"./storage\";\nimport {\n  getTaskDisplayStatus,\n  getTaskDisplayStatusLabel,\n  getTaskDisplayStatusColor,\n} from \"./taskStatusHelper\";\nimport { notifyOwner } from \"./_core/notification\";\nimport { checkArchiveWarnings } from \"./archiveNotifications\";\nimport { emitNotification } from \"./_core/socket\";\nimport { createNotification } from \"./notificationService\";\nimport {\n  projectSchema,\n  taskSchema,\n  defectSchema,\n  inspectionSchema,\n} from \"@shared/validations\";\nimport { healthRouter } from \"./monitoring/healthRouter\";\nimport { optimizationRouter } from \"./optimization/optimizationRouter\";\nimport { cacheRouter } from \"./cache/cacheRouter\";\nimport { databaseRouter } from \"./database/databaseRouter\";\nimport { performanceRouter } from \"./performance/performanceRouter\";\nimport { getHealthStatus, formatBytes } from \"./health\";\nimport { exportRouter } from \"./exportRouter\";\nimport { monitoringRouter } from \"./routers/monitoring\";\nimport { teamRouter } from \"./routers/teamRouter\";\nimport { userManagementRouter } from \"./routers/userManagementRouter\";\nimport { roleTemplatesRouter } from \"./routers/roleTemplatesRouter\";\nimport { escalationRouter } from"
    },
    "db_main": {
      "path": "/home/ubuntu/construction_management_app/server/db.ts",
      "size": 224174,
      "lines": 7618,
      "content_preview": "import { eq, and, or, isNull, isNotNull, sql, desc, asc, count, inArray, notInArray, like, gte, lte, lt, ne } from \"drizzle-orm\";\nimport { bigIntToNumber } from \"./utils/bigint\";\nimport { boolToInt } from \"./utils/typeHelpers.js\";\nimport { drizzle } from \"drizzle-orm/mysql2\";\nimport mysql, { type Pool } from \"mysql2/promise\";\nimport {\n  InsertUser,\n  users,\n  projects,\n  projectMembers,\n  tasks,\n  taskDependencies,\n  checklistTemplates,\n  checklistTemplateItems,\n  taskChecklists,\n  checklistItemResults,\n  defects,\n  defectAttachments,\n  InsertDefectAttachment,\n  defectInspections,\n  InsertDefectInspection,\n  taskComments,\n  taskAttachments,\n  taskFollowers,\n  notifications,\n  activityLog,\n  categoryColors,\n  signatures,\n  queryLogs,\n  dbStatistics,\n  InsertQueryLog,\n  InsertDbStatistic,\n  memoryLogs,\n  oomEvents,\n  pushSubscriptions,\n  InsertPushSubscription,\n  scheduledNotifications,\n  notificationSettings,\n  taskAssignments,\n  alertThresholds,\n  InsertAlertThreshold,\n  escalationRules,\n  escalationLogs,\n} from \"../drizzle/schema\";\nimport { ENV } from \"./_core/env\";\nimport { createNotification as sendNotification } from \"./notificationService\";\nimport { logger } from \"./logger\";\n\n// Use Pool type from mysql2/promise for proper typing\nlet _db: ReturnType<typeof drizzle> | null = null;\nlet _pool: Pool | null = null;\n\n// Lazily create the drizzle instance with connection pooling\nexport async function getDb() {\n  if (!_db && process.env.DATABASE_URL) {\n    try {\n      // Create connection pool with optimized settings\n      _pool = mysql.createPool({\n        uri: process.env.DATABASE_URL,\n        connectionLimit: 10, // Maximum 10 concurrent connections\n        waitForConnections: true,\n        queueLimit: 0,\n        enableKeepAlive: true,\n        keepAliveInitialDelay: 10000,\n        maxIdle: 5, // Maximum idle connections\n        idleTimeout: 60000, // Close idle connections after 60s\n      });\n      console.log(\"[Database] Connection pool created with limit: 10\");\n  "
    },
    "todo": {
      "path": "/home/ubuntu/construction_management_app/todo.md",
      "size": 25532,
      "lines": 598,
      "content_preview": "# Construction Management & QC Platform - à¹à¸œà¸™à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸£à¸°à¸šà¸š\n\n## ðŸŽ¯ à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¸«à¸¥à¸±à¸\nà¹à¸à¹‰à¹„à¸‚à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸£à¸°à¸šà¸šà¸•à¸²à¸¡à¹à¸œà¸™ 3 à¸£à¸°à¸¢à¸° (6-9 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ) à¹€à¸žà¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸²à¸§à¸´à¸à¸¤à¸•, à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸ªà¸–à¸²à¸›à¸±à¸•à¸¢à¸à¸£à¸£à¸¡, à¹à¸¥à¸°à¹€à¸žà¸´à¹ˆà¸¡à¸„à¸¸à¸“à¸ à¸²à¸žà¹‚à¸„à¹‰à¸”\n\n---\n\n## ðŸ“Š à¸ªà¸–à¸²à¸™à¸°à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™\n- **TypeScript Errors:** 21 errors âœ… (à¸¥à¸”à¸¥à¸‡à¸ˆà¸²à¸ 79 â†’ 21)\n- **Failing Tests:** 32 failed tests (à¸ˆà¸²à¸ 212 tests) âš ï¸\n- **Monolithic Files:** \n  - server/routers.ts: 3,937 à¸šà¸£à¸£à¸—à¸±à¸” âš ï¸\n  - server/db.ts: 7,626 à¸šà¸£à¸£à¸—à¸±à¸” (à¸¡à¸µ repositories à¹à¸¥à¹‰à¸§) âœ…\n- **Notification Error:** à¹à¸à¹‰à¹„à¸‚à¹à¸¥à¹‰à¸§ âœ…\n- **Repository Layer:** à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ 10 repositories âœ…\n\n---\n\n## Phase 1: à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸²à¸§à¸´à¸à¸¤à¸• (2-3 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ)\n\n### 1.1 à¹à¸à¹‰à¹„à¸‚ Notification Error\n- [x] à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸£à¸°à¸šà¸¸à¸ªà¸²à¹€à¸«à¸•à¸¸à¸‚à¸­à¸‡ notification error\n- [x] à¹à¸à¹‰à¹„à¸‚ notification service à¹à¸¥à¸° API endpoints (à¹à¸à¹‰ recipientId â†’ userId)\n- [x] à¸—à¸”à¸ªà¸­à¸šà¸£à¸°à¸šà¸šà¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (in-app, real-time)\n  - [x] inspection-notification.test.ts (6/6 passed)\n  - [x] escalation.test.ts (9/9 passed)\n  - [x] à¹à¸à¹‰à¹„à¸‚ test assertions à¸ªà¸³à¸«à¸£à¸±à¸š tinyint fields (0/1 à¹à¸—à¸™ false/true)\n\n### 1.2 à¹à¸à¹‰à¹„à¸‚ TypeScript Errors (79 â†’ 21 errors) âœ…\n- [x] à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡ TypeScript errors (à¸ªà¸£à¹‰à¸²à¸‡ TYPESCRIPT_ERRORS_ANALYSIS.md)\n- [x] à¹à¸à¹‰à¹„à¸‚ type errors à¹ƒà¸™ repositories (schema field mismatches)\n- [x] à¹à¸à¹‰à¹„à¸‚ type errors à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™à¹ƒà¸™ server/db.ts (dueDate, escalation types)\n- [x] à¹à¸à¹‰à¹„à¸‚ type errors à¹ƒà¸™ client/src/pages/*.tsx (à¹à¸à¹‰à¹„à¸‚ 6 pages à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢)\n  - [x] à¹à¸à¹‰à¹„à¸‚ NewDashboard.tsx property mismatches\n  - [x] à¹à¸à¹‰à¹„à¸‚ QCInspection.tsx property mismatches\n  - [x] à¹à¸à¹‰à¹„à¸‚ Reports.tsx property mismatches\n  - [x] à¹à¸à¹‰à¹„à¸‚ RoleTemplates.tsx property mismatches\n  - [x] à¹à¸à¹‰à¹„à¸‚ Tasks.tsx property mismatches\n  - [x] à¹à¸à¹‰à¹„à¸‚ Templates.tsx property mismatches\n- [x] à¹à¸à¹‰à¹„à¸‚ virusScanner type declaration\n- [ ] à¹à¸à¹‰à¹„à¸‚ vite.config.ts plugin types (14 errors - dependency version mismatch, à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸œà¸¥à¸•à¹ˆà¸­ runtime)\n- [ ] à¹à¸à¹‰à¹„à¸‚ server/db.ts Drizzle type inference (7 errors - legacy code, à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸œà¸¥à¸•à¹ˆà¸­ runtime)\n\n### 1.3 à¹€à¸£à¸´à¹ˆà¸¡à¹à¸¢à¸ Routers à¹€à¸›à¹‡à¸™ Feature-based Modules\n- [ ] à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ server/routers.ts (3,937 à¸šà¸£à¸£à¸—à¸±à¸”)\n- [ ] à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ server"
    },
    "routers": [
      {
        "path": "/home/ubuntu/construction_management_app/server/routers/projectRouter.ts",
        "size": 14948,
        "lines": 495,
        "content_preview": "import { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { protectedProcedure, publicProcedure, router, roleBasedProcedure } from \"../_core/trpc\";\nimport * as db from \"../db\";\nimport { canEditProject, canDeleteProject, logAuthorizationFailure } from \"../rbac\";\nimport { logProjectAudit, getClientIp, getUserAgent } from \"../auditTrail\";\nimport { emitNotification } from \"../_core/socket\";\nimport * as analyticsService from \"../services/analytics.service\";\nimport { generateArchiveExcel } from \"../excelExport\";\nimport { projectSchema, taskSchema, defectSchema, inspectionSchema } from \"@shared/validations\";\nimport { \n  updateProjectSchema, \n  getProjectSchema, \n  deleteProjectSchema,\n  addProjectMemberSchema,\n  removeProjectMemberSchema,\n  paginationSchema,\n  projectStatusSchema\n} from \"@shared/validation\";\n\n/**\n * Project Router\n * Auto-generated from server/routers.ts\n */\nexport const projectRouter = router({\n  getNextProjectCode: protectedProcedure.query(async () => {\n    "
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/routers/taskRouter.ts",
        "size": 18249,
        "lines": 592,
        "content_preview": "import { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { protectedProcedure, publicProcedure, router, roleBasedProcedure } from \"../_core/trpc\";\nimport * as db from \"../db\";\nimport { canEditTask, canDeleteTask, logAuthorizationFailure } from \"../rbac\";\nimport { logTaskAudit, getClientIp, getUserAgent } from \"../auditTrail\";\nimport { validateTaskCreateInput, validateTaskUpdateInput, validateInspectionSubmission, validateDefectCreateInput, validateDefectUpdateInput } from \"@shared/validationUtils\";\nimport { getTaskDisplayStatus, getTaskDisplayStatusLabel, getTaskDisplayStatusColor } from \"../taskStatusHelper\";\nimport { emitNotification } from \"../_core/socket\";\nimport { createNotification } from \"../notificationService\";\nimport { logger } from \"../logger\";\nimport { projectSchema, taskSchema, defectSchema, inspectionSchema } from \"@shared/validations\";\nimport {\n  createTaskSchema,\n  updateTaskSchema,\n  getTaskSchema,\n  deleteTaskSchema,\n  getTasksByProjectSchema,\n  pagi"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/routers/defectRouter.ts",
        "size": 22101,
        "lines": 719,
        "content_preview": "import { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { protectedProcedure, publicProcedure, router, roleBasedProcedure } from \"../_core/trpc\";\nimport * as db from \"../db\";\nimport { validateTaskCreateInput, validateTaskUpdateInput, validateInspectionSubmission, validateDefectCreateInput, validateDefectUpdateInput } from \"@shared/validationUtils\";\nimport { canEditDefect, canDeleteDefect, logAuthorizationFailure } from \"../rbac\";\nimport { logDefectAudit, getClientIp, getUserAgent } from \"../auditTrail\";\nimport { notifyOwner } from \"../_core/notification\";\nimport { createNotification } from \"../notificationService\";\nimport { logger } from \"../logger\";\nimport {\n  createDefectSchema,\n  updateDefectSchema,\n  getDefectSchema,\n  deleteDefectSchema,\n  getDefectsByTaskSchema,\n  getDefectsByProjectSchema,\n  defectStatusSchema,\n  defectTypeSchema,\n  paginationSchema\n} from \"@shared/validation\";\n\n/**\n * Defect Router\n * Auto-generated from server/routers.ts\n */\nexport const defe"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/routers/inspectionRouter.ts",
        "size": 4155,
        "lines": 125,
        "content_preview": "import { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { protectedProcedure, publicProcedure, router, roleBasedProcedure } from \"../_core/trpc\";\nimport * as db from \"../db\";\n\n/**\n * Inspection Router\n * Auto-generated from server/routers.ts\n */\nexport const inspectionRouter = router({\n  // List inspections by project with pagination\n  listByProject: protectedProcedure\n    .input(z.object({\n      projectId: z.number(),\n      page: z.number().int().min(1).default(1),\n      pageSize: z.number().int().min(1).max(100).default(25),\n    }))\n    .query(async ({ input }) => {\n      const { projectId, page = 1, pageSize = 25 } = input;\n      const offset = (page - 1) * pageSize;\n\n      // Get all inspections for the project\n      const allInspections = await db.getTaskChecklistsByProject(projectId);\n      const totalItems = allInspections.length;\n\n      // Apply pagination\n      const paginatedInspections = allInspections.slice(offset, offset + pageSize);\n\n      const totalPag"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/routers/checklistRouter.ts",
        "size": 23427,
        "lines": 719,
        "content_preview": "import { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { protectedProcedure, publicProcedure, router, roleBasedProcedure } from \"../_core/trpc\";\nimport { canEditInspection, logAuthorizationFailure } from \"../rbac\";\nimport { logInspectionAudit, getClientIp, getUserAgent } from \"../auditTrail\";\nimport * as db from \"../db\";\nimport { validateTaskCreateInput, validateTaskUpdateInput, validateInspectionSubmission, validateDefectCreateInput, validateDefectUpdateInput } from \"@shared/validationUtils\";\nimport { createNotification } from \"../notificationService\";\nimport { logger } from \"../logger\";\n\n/**\n * Checklist Router\n * Auto-generated from server/routers.ts\n */\nexport const checklistRouter = router({\n  templates: protectedProcedure.query(async () => {\n    // Return all templates grouped by stage\n    const preExecution = await db.getChecklistTemplatesByStage(\"pre_execution\");\n    const inProgress = await db.getChecklistTemplatesByStage(\"in_progress\");\n    const postExecut"
      }
    ],
    "services": [
      {
        "path": "/home/ubuntu/construction_management_app/server/services/project.service.ts",
        "size": 7220,
        "lines": 227,
        "content_preview": "/**\n * Project Service\n * \n * Handles project-related business logic with proper data integrity:\n * - createProject: Creates project and automatically adds creator as project manager\n * - deleteProject: Deletes project and all related data (members, tasks, dependencies, etc.)\n * \n * Uses toNumber() helper for safe ID conversions and constants from utils/constants.ts\n */\n\nimport { eq, inArray, and } from \"drizzle-orm\";\nimport { getDb } from \"../db\";\nimport {\n  projects,\n  projectMembers,\n  tasks,\n  taskDependencies,\n  taskFollowers,\n  taskAttachments,\n  taskComments,\n  taskChecklists,\n  checklistItemResults,\n  defects,\n  notifications,\n  activityLog,\n  taskAssignments,\n} from \"../../drizzle/schema\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { PROJECT_STATUS } from \"../constants/statuses\";\nimport { logger } from \"../logger\";\n\n/**\n * Generate next available project code in format AO-YYYY-XXX\n */\nasync function generate"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/services/task.service.ts",
        "size": 8133,
        "lines": 272,
        "content_preview": "import { and, desc, eq, inArray, sql, asc } from \"drizzle-orm\";\nimport { getDb } from \"../db/client\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { logger } from \"../logger\";\nimport {\n  tasks,\n  taskDependencies,\n  taskComments,\n  type Task,\n  type InsertTask,\n  type TaskDependency,\n  type InsertTaskDependency,\n  type TaskComment,\n  type InsertTaskComment,\n} from \"../../drizzle/schema\";\n\n/**\n * Task Service\n * Handles all task-related operations including dependencies and comments\n */\n\n// ============================================================================\n// Task CRUD Operations\n// ============================================================================\n\nexport async function createTask(data: InsertTask): Promise<Task> {\n  return await withTransaction(async (tx) => {\n    const [result] = await tx.insert(tasks).values(data);\n    const taskId = bigIntToNumber(result.insertId);\n    const [created] = await tx"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/services/defect.service.ts",
        "size": 14371,
        "lines": 428,
        "content_preview": "import { and, desc, eq, inArray, sql } from \"drizzle-orm\";\nimport { getDb } from \"../db/client\";\nimport { bigIntToNumber } from \"../utils/bigint\";\nimport { withTransaction } from \"../utils/transaction\";\nimport { logger } from \"../logger\";\nimport {\n  defects,\n  defectAttachments,\n  activityLog,\n  tasks,\n  type Defect,\n  type InsertDefect,\n  type DefectAttachment,\n  type InsertDefectAttachment,\n} from \"../../drizzle/schema\";\n\n/**\n * Defect Service\n * Handles all defect-related operations including attachments\n */\n\n// ============================================================================\n// Defect CRUD Operations\n// ============================================================================\n\nexport async function createDefect(data: InsertDefect): Promise<Defect> {\n  return await withTransaction(async (tx) => {\n    const [result] = await tx.insert(defects).values(data);\n    const defectId = bigIntToNumber(result.insertId);\n    \n    // Create activity log entry\n    await tx.insert(ac"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/services/inspection.service.ts",
        "size": 10334,
        "lines": 296,
        "content_preview": "/**\n * Inspection Service\n * \n * Handles inspection-related business logic with proper transaction management:\n * - submitInspection: Atomic submission of inspection results with automatic defect creation\n * \n * Uses toNumber() helper for safe ID conversions and constants from utils/constants.ts\n */\n\nimport { eq, and } from \"drizzle-orm\";\nimport { getDb } from \"../db\";\nimport {\n  tasks,\n  taskChecklists,\n  checklistItemResults,\n  defects,\n  projectMembers,\n} from \"../../drizzle/schema\";\nimport { toNumber } from \"../utils/db-helpers\";\nimport {\n  INSPECTION_RESULT,\n  CHECKLIST_STATUS,\n  TASK_STATUS,\n  DEFECT_SEVERITY,\n  DEFECT_STATUS,\n  NOTIFICATION_TYPE,\n  ACTIVITY_TYPE,\n} from \"../utils/constants\";\nimport { logger } from \"../logger\";\nimport { createNotification, logActivity } from \"../db\";\n\n/**\n * Submit inspection results with transaction support\n * \n * @param data Inspection submission data\n * @returns Object with success status and statistics\n * \n * @throws Error if database is unav"
      }
    ],
    "repositories": [
      {
        "path": "/home/ubuntu/construction_management_app/server/repositories/project.repository.ts",
        "size": 15761,
        "lines": 594,
        "content_preview": "import { eq, and, desc, count, like, isNull, sql, inArray } from \"drizzle-orm\";\nimport {\n  projects,\n  projectMembers,\n  tasks,\n  checklistTemplates,\n} from \"../../drizzle/schema\";\nimport { BaseRepository } from \"./base.repository\";\nimport { bigIntToNumber } from \"../utils/bigint\";\n\n/**\n * Project Repository\n * \n * Handles all project-related database operations\n */\nexport class ProjectRepository extends BaseRepository {\n  /**\n   * Generate unique project code for the current year\n   */\n  async generateProjectCode(): Promise<string> {\n    this.ensureDatabaseAvailable();\n    if (!this.db) throw new Error(\"Database not available\");\n\n    const currentYear = new Date().getFullYear();\n    const prefix = `AO-${currentYear}-`;\n\n    // Get the latest project code for this year\n    const latestProjects = await this.db\n      .select({ code: projects.code })\n      .from(projects)\n      .where(like(projects.code, `${prefix}%`))\n      .orderBy(desc(projects.code))\n      .limit(1);\n\n    if (latestPr"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/repositories/task.repository.ts",
        "size": 12036,
        "lines": 465,
        "content_preview": "import { eq, and, desc, asc, count, inArray } from \"drizzle-orm\";\nimport {\n  tasks,\n  taskDependencies,\n  taskComments,\n  taskAttachments,\n  taskFollowers,\n  taskAssignments,\n  activityLog,\n} from \"../../drizzle/schema\";\nimport { BaseRepository } from \"./base.repository\";\nimport { bigIntToNumber } from \"../utils/bigint\";\n\n/**\n * Task Repository\n * \n * Handles all task-related database operations including:\n * - Task CRUD operations\n * - Task dependencies management\n * - Task comments and attachments\n * - Task followers and assignments\n * - Bulk operations\n */\nexport class TaskRepository extends BaseRepository {\n  /**\n   * Create new task\n   */\n  async createTask(data: {\n    projectId: number;\n    parentTaskId?: number;\n    name: string;\n    description?: string;\n    category?: string;\n    status?: string;\n    priority?: string;\n    startDate?: string | Date;\n    endDate?: string | Date;\n    assigneeId?: number;\n    createdBy: number;\n  }) {\n    this.ensureDatabaseAvailable();\n    if (!"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/repositories/defect.repository.ts",
        "size": 15156,
        "lines": 512,
        "content_preview": "import { eq, and, desc, count, sql, inArray } from \"drizzle-orm\";\nimport {\n  defects,\n  defectAttachments,\n  defectInspections,\n  tasks,\n  taskChecklists,\n  checklistTemplates,\n  users,\n  InsertDefectAttachment,\n  InsertDefectInspection,\n} from \"../../drizzle/schema\";\nimport { BaseRepository } from \"./base.repository\";\n\n/**\n * Defect Repository\n * \n * Handles all defect-related database operations including:\n * - Defect CRUD operations (CAR/PAR/NCR)\n * - Defect attachments management\n * - Defect inspections and reinspections\n * - Defect statistics and metrics\n */\nexport class DefectRepository extends BaseRepository {\n  /**\n   * Create new defect\n   */\n  async createDefect(data: {\n    projectId: number;\n    taskId: number;\n    checklistItemResultId?: number;\n    title: string;\n    description?: string;\n    photoUrls?: string;\n    severity: \"low\" | \"medium\" | \"high\" | \"critical\";\n    reportedBy: number;\n    assignedTo?: number;\n    type?: \"CAR\" | \"PAR\" | \"NCR\";\n    checklistId?: number;\n"
      },
      {
        "path": "/home/ubuntu/construction_management_app/server/repositories/inspection.repository.ts",
        "size": 15504,
        "lines": 514,
        "content_preview": "import { eq, desc, and, inArray, sql } from \"drizzle-orm\";\nimport {\n  taskChecklists,\n  checklistItemResults,\n  checklistTemplates,\n  checklistTemplateItems,\n  tasks,\n  projects,\n  users,\n  signatures,\n} from \"../../drizzle/schema\";\nimport { BaseRepository } from \"./base.repository\";\nimport { bigIntToNumber } from \"../utils/bigint\";\n\n/**\n * Inspection Repository\n * \n * Handles all inspection-related database operations including:\n * - Task checklists (inspections)\n * - Checklist item results\n * - Reinspections\n * - Signatures\n * - Inspection requests\n */\nexport class InspectionRepository extends BaseRepository {\n  /**\n   * Create task checklist (inspection)\n   */\n  async createTaskChecklist(data: {\n    taskId: number;\n    templateId: number;\n    stage: \"pre_execution\" | \"in_progress\" | \"post_execution\";\n  }) {\n    this.ensureDatabaseAvailable();\n    if (!this.db) throw new Error(\"Database not available\");\n\n    // Create the task checklist\n    const result = await this.db.insert(taskChe"
      }
    ],
    "frontend_pages": [
      {
        "path": "/home/ubuntu/construction_management_app/client/src/pages/Dashboard.tsx",
        "size": 27913,
        "lines": 580,
        "content_preview": "import { useAuth } from \"@/_core/hooks/useAuth\";\nimport { trpc } from \"@/lib/trpc\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Activity,\n  AlertCircle,\n  AlertTriangle,\n  ArrowRight,\n  BarChart3,\n  CheckCircle2,\n  Clock,\n  TrendingUp,\n  TrendingDown,\n  Users,\n  Target,\n  Calendar,\n  FileCheck,\n  XCircle,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { useMemo } from \"react\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { th } from \"date-fns/locale\";\n\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Progress } from \"@/components/ui/progress\";\n\n/**\n * Enhanced Dashboard - Construction Management & QC Platform\n * \n * New Widgets:\n * - Project Timeline Overview (on track, at risk, behind sched"
      },
      {
        "path": "/home/ubuntu/construction_management_app/client/src/pages/ProjectDetail.tsx",
        "size": 20374,
        "lines": 536,
        "content_preview": "import { trpc } from \"@/lib/trpc\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Loader2, MapPin, Calendar, DollarSign, Users, Trash2, Archive, Download, FileSpreadsheet, FileText } from \"lucide-react\";\nimport { Link, useLocation, useParams } from \"wouter\";\nimport { parseDate } from \"@/lib/dateUtils\";\nimport { lazy, Suspense, useState } from \"react\";\n\n// Lazy load GanttChart component\nconst GanttChart = lazy(() => import(\"@/components/GanttChart\"));\nconst EnhancedGanttChart = lazy(() => import(\"@/components/EnhancedGanttChart\"));\nimport NewTaskDialog from \"@/components/NewTaskDialog\";\nimport { CategoryColorPicker } from \"@/components/CategoryColorPicker\";\nimport { QCTab } from \"@/components/QCTab\";\nimport { ArchiveHistoryTimeline } from \"@/components/A"
      },
      {
        "path": "/home/ubuntu/construction_management_app/client/src/pages/DefectDetail.tsx",
        "size": 71388,
        "lines": 1730,
        "content_preview": "import { useParams, useLocation, Link } from \"wouter\";\nimport { useState } from \"react\";\nimport { trpc } from \"@/lib/trpc\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft, Calendar, User, FileText, AlertTriangle, CheckCircle2, XCircle, Edit, RefreshCw, History, Clock, Image, Upload, Trash2, X, ChevronLeft, ChevronRight, Maximize2, GitCompare, Download, Wrench } from \"lucide-react\";\nimport jsPDF from \"jspdf\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { toast } from \"sonner\";\nimport {"
      },
      {
        "path": "/home/ubuntu/construction_management_app/client/src/pages/TaskDetail.tsx",
        "size": 33712,
        "lines": 864,
        "content_preview": "import { useParams } from \"wouter\";\nimport { useState } from \"react\";\nimport { trpc } from \"@/lib/trpc\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Loader2, Calendar, User, MessageSquare, FileText, Trash2, ArrowLeft, Building2, TrendingUp, TrendingDown, Minus, Upload, File, Image as ImageIcon, X, CheckSquare, AlertTriangle, Clock, Edit } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { parseDate, daysBetween } from \"@/lib/dateUtils\";\nimport { useLocation, Link } from \"wouter\";\nimport { useAuth } from \"@/_core/hooks/useAuth\";\nimport { us"
      }
    ],
    "shared_types": [
      {
        "path": "/home/ubuntu/construction_management_app/shared/types.ts",
        "size": 158,
        "lines": 7,
        "content_preview": "/**\n * Unified type exports\n * Import shared types from this single entry point.\n */\n\nexport type * from \"../drizzle/schema\";\nexport * from \"./_core/errors\";\n"
      },
      {
        "path": "/home/ubuntu/construction_management_app/shared/validation.ts",
        "size": 13546,
        "lines": 456,
        "content_preview": "/**\n * Shared Zod Validation Schemas\n * Purpose: Centralized input validation to prevent SQL injection and invalid data\n */\n\nimport { z } from 'zod';\n\n// ============================================\n// COMMON VALIDATORS\n// ============================================\n\nexport const idSchema = z.number().int().positive();\nexport const optionalIdSchema = z.number().int().positive().optional();\nexport const stringSchema = z.string().min(1).max(255);\nexport const optionalStringSchema = z.string().min(1).max(255).optional();\nexport const textSchema = z.string().max(10000);\nexport const optionalTextSchema = z.string().max(10000).optional();\nexport const emailSchema = z.string().email().max(320);\nexport const urlSchema = z.string().url().max(500);\nexport const dateStringSchema = z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/);\nexport const optionalDateStringSchema = z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/).optional();\nexport const timestampSchema = z.date();\nexport const optionalTimestampSchema = z.dat"
      }
    ]
  }
}