# Phase 6: à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¹à¸œà¸™à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸š

## ğŸ“Š à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™

### à¸›à¸±à¸à¸«à¸²à¸«à¸¥à¸±à¸à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚
1. **Failing Tests: 38 à¸ˆà¸²à¸ 252 tests (15% failure rate)**
2. **Permission Middleware: à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸—à¸¸à¸ router**
3. **Performance: à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸§à¸±à¸”à¸œà¸¥à¸ˆà¸²à¸ indexes à¸—à¸µà¹ˆà¹€à¸à¸´à¹ˆà¸¡à¹„à¸›**
4. **Services Layer: à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰ refactor à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ repositories**
5. **Frontend: à¸•à¹‰à¸­à¸‡ refactor à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ UX**

### à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸—à¸µà¹ˆà¸œà¹ˆà¸²à¸™à¸¡à¸² âœ…
- âœ… à¹à¸¢à¸ routers à¸ªà¸³à¹€à¸£à¹‡à¸ˆ (3,937 â†’ 741 lines, -81.2%)
- âœ… à¸ªà¸£à¹‰à¸²à¸‡ Repository Pattern (10 repositories)
- âœ… à¹€à¸à¸´à¹ˆà¸¡ Foreign Keys à¹à¸¥à¸° Indexes
- âœ… à¸ªà¸£à¹‰à¸²à¸‡ Zod Validation Schemas
- âœ… à¸ªà¸£à¹‰à¸²à¸‡ Permission Middleware (à¸šà¸²à¸‡à¸ªà¹ˆà¸§à¸™)
- âœ… à¸ªà¸£à¹‰à¸²à¸‡ Performance Metrics Dashboard

---

## ğŸ¯ à¹à¸œà¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸š

### à¸«à¸¥à¸±à¸à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
1. **à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸à¹ˆà¸­à¸™à¸—à¸³** - à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸›à¸±à¸à¸«à¸²à¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡à¸à¹ˆà¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¹à¸à¹‰
2. **à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸›à¸±à¸à¸«à¸²** - à¹à¸¢à¸à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆà¸„à¸¥à¹‰à¸²à¸¢à¸à¸±à¸™à¸¡à¸²à¹à¸à¹‰à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™
3. **à¹à¸à¹‰à¹„à¸‚à¸­à¸¢à¹ˆà¸²à¸‡à¸¡à¸µà¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¸ à¸²à¸** - à¹ƒà¸Šà¹‰ automation à¹à¸¥à¸° batch operations
4. **à¸—à¸”à¸ªà¸­à¸šà¸—à¸¸à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™** - à¸¢à¸·à¸™à¸¢à¸±à¸™à¸§à¹ˆà¸²à¹à¸à¹‰à¹„à¸‚à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸à¹ˆà¸­à¸™à¹„à¸›à¸•à¹ˆà¸­
5. **à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ** - à¸ªà¸£à¹‰à¸²à¸‡ checkpoint à¹à¸¥à¸° documentation

---

## ğŸ“‹ Phase 6.1: à¹à¸à¹‰à¹„à¸‚ Failing Tests (Priority 1)

### à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
```bash
# 1. à¸£à¸±à¸™ tests à¹à¸¥à¸°à¹€à¸à¹‡à¸šà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
pnpm test --reporter=verbose > test-results.txt 2>&1

# 2. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ failing tests
grep -A 5 "FAIL" test-results.txt > failing-tests-summary.txt

# 3. à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸›à¸±à¸à¸«à¸²
# - insertId issues (à¹ƒà¸Šà¹‰ direct insert à¹à¸—à¸™ db helpers)
# - Role enum mismatches (user vs qc_inspector, worker, etc.)
# - API mismatches (test à¹ƒà¸Šà¹‰ API à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸š implementation)
# - Data setup issues (foreign key violations, missing data)
```

### à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚
1. **insertId Issues** - à¹à¸à¹‰à¹„à¸‚à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰ db helper functions à¹à¸—à¸™ direct insert
   - à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: `await db.insert(projects).values(...)` â†’ `await createProject(...)`
   - à¸›à¸£à¸°à¹‚à¸¢à¸Šà¸™à¹Œ: à¹„à¸”à¹‰ insertId à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡, à¸œà¹ˆà¸²à¸™ validation

2. **Role Enum Mismatches** - à¸­à¸±à¸à¹€à¸”à¸— test data à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š schema
   - à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ `role: 'user'` â†’ `role: 'qc_inspector'` à¸«à¸£à¸·à¸­ `'worker'`
   - à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š schema.ts à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ valid roles

3. **API Mismatches** - à¸¥à¸šà¸«à¸£à¸·à¸­à¹à¸à¹‰à¹„à¸‚ tests à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ API à¸œà¸´à¸”
   - à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š routers à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ actual API
   - à¸­à¸±à¸à¹€à¸”à¸— tests à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š implementation

4. **Data Setup Issues** - à¹à¸à¹‰à¹„à¸‚ test setup
   - à¹€à¸à¸´à¹ˆà¸¡ foreign key data (users, projects) à¸à¹ˆà¸­à¸™
   - à¹ƒà¸Šà¹‰ transaction à¹€à¸à¸·à¹ˆà¸­ rollback à¸«à¸¥à¸±à¸‡ test

### à¸¥à¸³à¸”à¸±à¸šà¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚
```
1. Integration tests (2 files)
   - checklist-completion-flow.test.ts
   - defect-escalation-flow.test.ts

2. Unit tests (27 files)
   - à¹à¸à¹‰à¹„à¸‚à¸—à¸µà¸¥à¸°à¸à¸¥à¸¸à¹ˆà¸¡à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸›à¸±à¸à¸«à¸²
   - à¸—à¸”à¸ªà¸­à¸šà¸«à¸¥à¸±à¸‡à¹à¸à¹‰à¹à¸•à¹ˆà¸¥à¸°à¸à¸¥à¸¸à¹ˆà¸¡
```

---

## ğŸ“‹ Phase 6.2: à¸‚à¸¢à¸²à¸¢ Permission Middleware (Priority 2)

### Routers à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Middleware
```typescript
// âœ… à¸¡à¸µ middleware à¹à¸¥à¹‰à¸§
- projectRouter.ts (requireProjectAccess)
- taskRouter.ts (requireTaskAccess, requireEditTask)
- defectRouter.ts (requireDefectAccess, requireEditDefect)
- checklistRouter.ts (requireEditInspection, requireApproveInspection)

// âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ middleware
- inspectionRouter.ts
- dashboardRouter.ts
- commentRouter.ts
- attachmentRouter.ts
- notificationRouter.ts
- activityRouter.ts
- categoryColorRouter.ts
- inspectionStatsRouter.ts
- errorTrackingRouter.ts
```

### à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸à¸²à¸£à¹€à¸à¸´à¹ˆà¸¡ Middleware
1. **à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ permissions à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£**
   - à¸­à¹ˆà¸²à¸™ router code à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ inline permission checks
   - à¸£à¸°à¸šà¸¸ resources à¹à¸¥à¸° actions (view, edit, delete, approve)

2. **à¸ªà¸£à¹‰à¸²à¸‡ middleware functions**
   ```typescript
   // à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡
   export const requireViewInspection = createMiddleware(async (opts) => {
     const { inspectionId } = opts.input as { inspectionId: number };
     const hasAccess = await canViewInspection(opts.ctx.user, inspectionId);
     if (!hasAccess) throw new TRPCError({ code: 'FORBIDDEN' });
     return opts.next({ ctx: opts.ctx });
   });
   ```

3. **à¹à¸—à¸™à¸—à¸µà¹ˆ inline checks à¸”à¹‰à¸§à¸¢ middleware**
   ```typescript
   // Before
   someProc: protectedProcedure
     .input(z.object({ id: z.number() }))
     .query(async ({ ctx, input }) => {
       // inline permission check
       const hasAccess = await checkAccess(...);
       if (!hasAccess) throw error;
       // ...
     })

   // After
   someProc: protectedProcedure
     .use(requireViewResource)
     .input(z.object({ id: z.number() }))
     .query(async ({ ctx, input }) => {
       // no inline check needed
       // ...
     })
   ```

4. **à¹€à¸‚à¸µà¸¢à¸™ integration tests**
   - à¸—à¸”à¸ªà¸­à¸š unauthorized access
   - à¸—à¸”à¸ªà¸­à¸š authorized access
   - à¸—à¸”à¸ªà¸­à¸š role-based access

---

## ğŸ“‹ Phase 6.3: à¸§à¸±à¸”à¸œà¸¥à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ Performance (Priority 3)

### à¸à¸²à¸£à¸§à¸±à¸”à¸œà¸¥ Performance
```typescript
// 1. à¹ƒà¸Šà¹‰ Performance Metrics Dashboard à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ
// - à¹€à¸›à¸´à¸” /performance-metrics
// - à¸”à¸¹ slow queries (> 100ms)
// - à¸”à¸¹ query execution times

// 2. à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¹ˆà¸­à¸™à¹à¸¥à¸°à¸«à¸¥à¸±à¸‡ indexes
// - à¸£à¸±à¸™ benchmark queries
// - à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹ƒà¸™ PERFORMANCE_REPORT.md

// 3. à¸£à¸°à¸šà¸¸ bottlenecks
// - N+1 queries
// - Missing indexes
// - Complex joins
// - Large data scans
```

### à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡
1. **à¹€à¸à¸´à¹ˆà¸¡ indexes à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡** - à¸•à¸²à¸¡à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
2. **Optimize queries** - à¸¥à¸” joins, à¹ƒà¸Šà¹‰ select specific columns
3. **Add caching** - à¸ªà¸³à¸«à¸£à¸±à¸š queries à¸—à¸µà¹ˆ query à¸šà¹ˆà¸­à¸¢
4. **Pagination** - à¸ªà¸³à¸«à¸£à¸±à¸š list queries

---

## ğŸ“‹ Phase 6.4: Refactor Services Layer (Priority 4)

### Services à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡ Refactor
```typescript
// âœ… à¸¡à¸µ services à¹à¸¥à¹‰à¸§ (à¹à¸•à¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ repositories)
- server/services/project.service.ts
- server/services/task.service.ts
- server/services/defect.service.ts
- server/services/inspection.service.ts
- server/services/notification.service.ts
- server/services/analytics.service.ts

// âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ services
- checklist.service.ts
- template.service.ts
- archive.service.ts
```

### à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸à¸²à¸£ Refactor
1. **à¸­à¸±à¸à¹€à¸”à¸— existing services à¹ƒà¸«à¹‰à¹ƒà¸Šà¹‰ repositories**
   ```typescript
   // Before
   import { getDb } from '../db';
   const db = await getDb();
   const result = await db.select()...

   // After
   import { projectRepository } from '../repositories';
   const result = await projectRepository.findById(id);
   ```

2. **à¸ªà¸£à¹‰à¸²à¸‡ missing services**
   - à¸¢à¹‰à¸²à¸¢ business logic à¸ˆà¸²à¸ routers
   - à¹ƒà¸Šà¹‰ repositories à¸ªà¸³à¸«à¸£à¸±à¸š data access
   - à¹€à¸à¸´à¹ˆà¸¡ transaction management

3. **à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ error handling**
   - Consistent error types
   - Proper error messages
   - Error logging

---

## ğŸ“‹ Phase 6.5: Frontend Refactoring (Priority 5)

### à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰
1. **Loading States** - à¹„à¸¡à¹ˆà¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­
2. **Error Handling** - à¸‚à¸²à¸” error boundaries
3. **Form Validation** - feedback à¹„à¸¡à¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™
4. **Optimistic Updates** - à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
5. **Responsive Design** - à¸šà¸²à¸‡à¸«à¸™à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆ responsive

### à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡
1. **à¸ªà¸£à¹‰à¸²à¸‡ shared components**
   - LoadingSpinner
   - ErrorBoundary
   - FormField with validation
   - ConfirmDialog

2. **à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ tRPC usage**
   - à¹€à¸à¸´à¹ˆà¸¡ optimistic updates à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
   - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ cache invalidation
   - à¹€à¸à¸´à¹ˆà¸¡ error handling

3. **à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ UX**
   - à¹€à¸à¸´à¹ˆà¸¡ loading skeletons
   - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ form validation feedback
   - à¹€à¸à¸´à¹ˆà¸¡ success/error toasts

---

## ğŸ“Š à¹€à¸¡à¸•à¸£à¸´à¸à¸‹à¹Œà¸§à¸±à¸”à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ

### Phase 6.1 Success Metrics
- âœ… All tests passing (252/252)
- âœ… Test coverage > 80%
- âœ… No failing integration tests

### Phase 6.2 Success Metrics
- âœ… Permission middleware à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸—à¸¸à¸ router
- âœ… Integration tests à¸ªà¸³à¸«à¸£à¸±à¸š permissions
- âœ… No inline permission checks

### Phase 6.3 Success Metrics
- âœ… Query execution time < 100ms (95th percentile)
- âœ… Performance report à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ
- âœ… Indexes à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡ slow queries

### Phase 6.4 Success Metrics
- âœ… Services à¹ƒà¸Šà¹‰ repositories 100%
- âœ… No direct db access à¹ƒà¸™ routers
- âœ… Consistent error handling

### Phase 6.5 Success Metrics
- âœ… Consistent loading states
- âœ… Error boundaries à¸—à¸¸à¸à¸«à¸™à¹‰à¸²
- âœ… Responsive design à¸—à¸¸à¸à¸«à¸™à¹‰à¸²

---

## ğŸš€ Timeline

### Week 1: Tests & Middleware
- Day 1-2: à¹à¸à¹‰à¹„à¸‚ failing tests
- Day 3-4: à¸‚à¸¢à¸²à¸¢ permission middleware
- Day 5: à¸—à¸”à¸ªà¸­à¸šà¹à¸¥à¸° checkpoint

### Week 2: Performance & Services
- Day 1-2: à¸§à¸±à¸”à¸œà¸¥à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ performance
- Day 3-4: Refactor services layer
- Day 5: à¸—à¸”à¸ªà¸­à¸šà¹à¸¥à¸° checkpoint

### Week 3: Frontend & Final
- Day 1-3: Frontend refactoring
- Day 4: Final testing
- Day 5: Documentation à¹à¸¥à¸° checkpoint

---

## ğŸ“ Next Steps

1. **à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸²à¸ Phase 6.1** - à¹à¸à¹‰à¹„à¸‚ failing tests
   - à¸£à¸±à¸™ tests à¹à¸¥à¸°à¹€à¸à¹‡à¸šà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
   - à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸›à¸±à¸à¸«à¸²
   - à¹à¸à¹‰à¹„à¸‚à¸—à¸µà¸¥à¸°à¸à¸¥à¸¸à¹ˆà¸¡

2. **à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸š**
   - à¸—à¸³à¸—à¸µà¸¥à¸° phase
   - à¸—à¸”à¸ªà¸­à¸šà¸«à¸¥à¸±à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™
   - à¸ªà¸£à¹‰à¸²à¸‡ checkpoint à¹€à¸›à¹‡à¸™à¸£à¸°à¸¢à¸°

3. **à¸£à¸²à¸¢à¸‡à¸²à¸™à¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²**
   - à¸­à¸±à¸à¹€à¸”à¸— todo.md
   - à¸ªà¸£à¹‰à¸²à¸‡ progress reports
   - à¹à¸ˆà¹‰à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸•à¹ˆà¸¥à¸° phase
